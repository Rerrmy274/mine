<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RerrMyTrades — Volatility Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
(function(){var n=function(){};console.log=n;console.warn=n;console.info=n;console.error=n;})();
</script>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  /* ── Deriv Dark Mode (exact Quill/app.deriv.com tokens) ── */
  --bg:#0a0b0d;--s1:#141519;--s2:#1c1e24;--s3:#23262f;
  --b0:rgba(255,255,255,0.08);--b1:rgba(255,255,255,0.14);
  /* Deriv Coral brand red */
  --violet:#0052ff;--cyan:#2d78ff;--green:#05b169;--red:#f05252;
  --gold:#f7931a;--pink:#0052ff;--orange:#f7931a;
  /* Text */
  --txt:#ffffff;--txt2:#8a919e;--txt3:#5b6270;
  --up:#05b169;--dn:#f05252;
  --nav-bg:#0a0b0d;--accent:#0052ff;
  --glow:rgba(0,82,255,0.25);
}

/* ── LIGHT MODE ── */
html.light{
  /* ── Deriv Light Mode (exact app.deriv.com tokens) ── */
  --bg:#f5f5f5;--s1:#ffffff;--s2:#f5f5f5;--s3:#ebebeb;
  --b0:rgba(0,0,0,0.08);--b1:rgba(0,0,0,0.14);
  --txt:#0a0b0d;--txt2:#5b6270;--txt3:#8a919e;
  --nav-bg:#ffffff;
  --glow:rgba(0,82,255,0.12);
}
html.light body{background:var(--bg);color:var(--txt)}
html.light #hdr{background:rgba(255,255,255,0.98);border-bottom-color:rgba(0,0,0,0.08)}
html.light #tnav{background:rgba(255,255,255,0.98);border-bottom-color:rgba(0,0,0,0.08)}
html.light #ticker{background:rgba(255,255,255,0.98);border-bottom-color:rgba(0,0,0,0.08)}
html.light #col-mkt{background:#ffffff;border-right-color:rgba(0,0,0,0.08)}
html.light .mkt-row:hover{background:rgba(0,0,0,0.04)}
html.light .mkt-row.sel{background:rgba(0,82,255,0.06)}
html.light #col-chart,html.light #col-digit,html.light #col-rf,html.light #col-ldp,
html.light #col-dtrader,html.light #col-dbot,html.light #col-journal,html.light #col-trade,
html.light #col-motivation{background:#f2f3f4}
html.light .chart-hdr{background:rgba(255,255,255,0.95)}
html.light .tf-bar{background:rgba(242,243,244,0.95)}
html.light .ind-bar{background:rgba(242,243,244,0.98)}
html.light .ind-tile{border-right-color:rgba(0,0,0,0.06)}
html.light #col-trade{background:#ffffff;border-left-color:rgba(0,0,0,0.08)}
html.light .tpanel-body{background:#ffffff}
html.light .live-band{background:linear-gradient(135deg,rgba(0,82,255,0.03),rgba(5,177,105,0.02))}
html.light .ct-sect,.html.light .fg,.html.light .digit-sect,.html.light .dir-btns,.html.light .poc{border-bottom-color:rgba(255,255,255,0.06)}
html.light .fi,.html.light .fs{background:rgba(139,92,246,0.04);border-color:rgba(255,255,255,0.10);color:var(--txt)}
html.light .sg{background:rgba(255,255,255,0.05)}
html.light .st{background:#ffffff}
html.light .stat-pill{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.1)}
html.light .tptab{color:var(--txt3)}
html.light .tptab.on{color:var(--accent)}
html.light .digit-btn{background:rgba(255,255,255,0.95);border-color:rgba(0,0,0,0.1);color:var(--txt)}
html.light .sh{background:rgba(242,243,244,0.95)}
html.light .prob-box,.html.light .dhmap,.html.light .pred-sect,.html.light .streak-sect,
html.light .ou-sect,.html.light .tick-counter,.html.light .cs-analysis,.html.light .rf-pred,
html.light .dint-body,.html.light .ldp-hdr,.html.light .ldp-body,.html.light .ldp-card{
  border-color:rgba(255,255,255,0.06)}
html.light .ldp-card{background:rgba(255,255,255,0.9)}
html.light .pattern-item{background:rgba(255,255,255,0.7)}
html.light .an-card{background:rgba(255,255,255,0.9)}
html.light #bnav{background:rgba(255,255,255,0.98);border-top-color:rgba(0,0,0,0.08)}
html.light .theme-btn::after{content:'☀️'}
html.light .theme-btn .ico{display:none}
html.light #banner{background:rgba(0,82,255,0.05);border-bottom-color:rgba(0,82,255,0.15)}
html.light #ambientBg::before{background:none}
html.light #ambientBg::after{background:none}
html.light .mkt-sym{color:var(--txt)}
html.light .mkt-px{color:var(--txt2)}
html.light .chart-sym{color:var(--txt)}
html.light .tn{color:var(--txt3)}
html.light .tn.act{color:var(--accent)}
html.light .tfb{color:var(--txt3)}
html.light .tfb.on{color:var(--violet);background:rgba(255,255,255,0.06)}
html.light ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2)}
html.light .dh-cell{background:rgba(255,255,255,0.9)!important}
html.light .motiv-card{background:rgba(255,255,255,0.95)}
html.light #motiv-hero{background:rgba(255,255,255,0.8)}

html,body{height:100%;overflow:hidden;background:var(--bg)}
body{color:var(--txt);font-family:'Inter',sans-serif;font-size:13px;font-weight:400;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent;letter-spacing:0}

/* ── Deriv Quill Typography ── */
h1,h2,h3,h4,h5,h6{font-family:'Inter',sans-serif;font-weight:700}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
strong,b{font-weight:600}

/* ── Scrollbars ── */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:2px}
::-webkit-scrollbar-track{background:transparent}

/* ── Ambient ── */
#ambientBg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
#ambientBg::before{content:'';position:absolute;top:-20%;left:-10%;width:60%;height:70%;
  background:radial-gradient(ellipse,rgba(255,255,255,0.05) 0%,transparent 65%);
  animation:a1 18s ease-in-out infinite alternate}
#ambientBg::after{content:'';position:absolute;bottom:-20%;right:-10%;width:50%;height:60%;
  background:radial-gradient(ellipse,rgba(34,211,238,0.05) 0%,transparent 65%);
  animation:a2 22s ease-in-out infinite alternate}
@keyframes a1{to{transform:translate(4%,3%) scale(1.04)}}
@keyframes a2{to{transform:translate(-3%,-4%) scale(1.06)}}

/* ── HEADER ── */
#hdr{position:fixed;top:0;left:0;right:0;height:52px;z-index:400;display:flex;align-items:center;
  justify-content:space-between;padding:0 12px;background:rgba(10,11,13,0.98);
  border-bottom:1px solid var(--b0);backdrop-filter:blur(20px)}
#hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,82,255,0.6),transparent)}
.logo{display:flex;align-items:center;gap:8px;flex-shrink:0}
.logo-sq{width:32px;height:32px;background:#0052ff;border-radius:6px;
  display:flex;align-items:center;justify-content:center;font-family:'Inter',sans-serif;
  font-weight:900;font-size:11px;color:#fff;letter-spacing:0;
  box-shadow:0 0 16px rgba(0,82,255,0.45)}
.logo-name{font-family:'Inter',sans-serif;font-weight:700;font-size:12px;color:var(--txt);line-height:1.1;letter-spacing:-0.02em}
.logo-name span{font-size:8px;color:var(--txt3);letter-spacing:1.5px;font-weight:400;display:block;text-transform:uppercase}
.hdr-center{display:flex;align-items:center;gap:6px;flex:1;justify-content:center}
.stat-pill{display:flex;align-items:center;gap:5px;padding:3px 9px;border-radius:12px;
  background:rgba(255,255,255,0.04);border:1px solid var(--b0);font-family:'JetBrains Mono',monospace;font-size:9px}
.sp-l{color:var(--txt3);font-size:7px;letter-spacing:.5px;text-transform:uppercase}
.sp-v{color:var(--txt);font-weight:600}
.sp-v.g{color:var(--green)}.sp-v.r{color:var(--red)}.sp-v.c{color:var(--cyan)}
.ws-dot{width:5px;height:5px;border-radius:50%;background:var(--green);
  box-shadow:0 0 6px var(--green);animation:blink 2s ease-in-out infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.hdr-r{display:flex;align-items:center;gap:6px;flex-shrink:0}
.bal-chip{display:none;padding:3px 10px;border-radius:12px;background:rgba(5,177,105,0.1);
  border:1px solid rgba(5,177,105,0.3);font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--green);font-weight:700}
.btn-api{padding:5px 12px;border-radius:12px;font-weight:800;font-size:9px;
  background:#0052ff;color:#fff;border:none;cursor:pointer;
  box-shadow:0 0 14px rgba(0,82,255,0.3);transition:all .2s;letter-spacing:.5px;text-transform:uppercase}
.btn-api:hover{box-shadow:0 0 22px rgba(0,82,255,0.55);transform:translateY(-1px)}
.btn-api.live{background:#05b169}
.theme-btn{width:30px;height:30px;border-radius:4px;border:1px solid var(--b0);background:transparent;
  color:var(--txt3);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.theme-btn:hover{background:rgba(255,255,255,0.10);color:var(--txt)}

/* ── TOP NAV ── */
#tnav{position:fixed;top:52px;left:0;right:0;height:40px;z-index:399;
  background:rgba(10,11,13,0.98);border-bottom:1px solid var(--b0);
  display:flex;align-items:stretch;backdrop-filter:blur(20px);justify-content:center;overflow-x:auto}
.tn{display:flex;align-items:center;gap:5px;padding:0 13px;font-size:10px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;cursor:pointer;border:none;background:transparent;
  color:var(--txt3);border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;flex-shrink:0}
.tn.act{color:var(--violet);border-bottom-color:var(--violet)}
.tn-ico{font-size:12px}
.tn-badge{background:rgba(255,255,255,0.14);color:var(--violet);border-radius:4px;padding:1px 5px;
  font-size:7px;font-weight:700;border:1px solid rgba(0,82,255,0.25)}

/* ── TICKER ── */
#ticker{position:fixed;top:92px;left:0;right:0;height:26px;z-index:398;
  background:rgba(10,11,13,0.95);border-bottom:1px solid var(--b0);
  overflow:hidden;display:flex;align-items:center;backdrop-filter:blur(10px)}
.tick-track{display:flex;animation:tickScroll 35s linear infinite;white-space:nowrap}
@keyframes tickScroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.tick-item{display:flex;align-items:center;gap:5px;padding:0 14px;border-right:1px solid var(--b0);
  height:26px;font-family:'JetBrains Mono',monospace;font-size:8px}
.ti-sym{color:var(--txt3);letter-spacing:.5px}
.ti-price{color:var(--txt);font-weight:600}
.ti-chg{font-size:7px}
.ti-chg.up{color:var(--green)}.ti-chg.dn{color:var(--red)}

/* ── LAYOUT ── */
#page{position:fixed;top:118px;left:0;right:0;bottom:0;display:flex;z-index:1}

/* ── MARKET SIDEBAR ── */
#col-mkt{display:none!important}
.mkt-hdr{padding:8px 10px;font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--txt3);border-bottom:1px solid var(--b0);display:flex;align-items:center;justify-content:space-between}
.mkt-scroll{flex:1;overflow-y:auto}
.mkt-cat{padding:5px 10px 3px;font-size:7px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:rgba(0,82,255,0.55);border-top:1px solid var(--b0)}
.mkt-row{display:flex;align-items:center;padding:7px 10px;cursor:pointer;border-bottom:1px solid rgba(139,92,246,0.04);
  transition:background .15s;gap:6px}
.mkt-row:hover{background:rgba(139,92,246,0.05)}
.mkt-row.sel{background:rgba(255,255,255,0.06);border-left:2px solid var(--violet)}
.mkt-sym{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--txt);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mkt-px{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txt2);flex-shrink:0}
.mkt-chg{font-family:'JetBrains Mono',monospace;font-size:8px;flex-shrink:0}
.mkt-chg.up{color:var(--green)}.mkt-chg.dn{color:var(--red)}
.mkt-vol-type{font-size:7px;font-weight:600;padding:1px 4px;border-radius:3px;
  background:rgba(255,255,255,0.10);color:rgba(139,92,246,0.8);flex-shrink:0}

/* ── CHART COLUMN ── */
#col-chart{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}
.chart-hdr{display:flex;align-items:center;gap:8px;padding:0 10px;height:36px;flex-shrink:0;
  background:rgba(10,11,13,0.7);border-bottom:1px solid var(--b0)}
.chart-sym{font-family:'Inter',sans-serif;font-size:11px;font-weight:700;color:var(--txt)}
.chart-desc{font-size:9px;color:var(--txt3)}
.chart-px{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--cyan);margin-left:auto}
.chart-chg{font-family:'JetBrains Mono',monospace;font-size:9px;margin-left:4px}
.chart-live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);
  box-shadow:0 0 8px var(--green);animation:blink 1.5s ease-in-out infinite;flex-shrink:0}
.chart-live-dot.offline{background:var(--red);box-shadow:0 0 6px var(--red)}
.tf-bar{display:flex;align-items:center;gap:2px;padding:4px 10px;border-bottom:1px solid var(--b0);
  background:rgba(10,11,13,0.5);flex-shrink:0;flex-wrap:wrap}
.tfb{padding:3px 8px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;
  cursor:pointer;border:1px solid transparent;color:var(--txt3);background:transparent;transition:all .15s}
.tfb:hover{color:var(--violet);border-color:rgba(0,82,255,0.25)}
.tfb.on{background:rgba(255,255,255,0.10);color:var(--violet);border-color:rgba(0,82,255,0.35)}
.tf-sep{width:1px;height:14px;background:var(--b0);margin:0 3px}
.cw{flex:1;position:relative;min-height:0;background:var(--bg)}
.cw canvas{display:block;width:100%;height:100%}
.ptag{position:absolute;right:0;padding:2px 7px;font-family:'JetBrains Mono',monospace;
  font-size:9px;font-weight:700;color:#fff;border-radius:3px 0 0 3px;transform:translateY(-50%);
  pointer-events:none;white-space:nowrap;z-index:5}
.vs{height:52px;flex-shrink:0;background:rgba(10,11,13,0.5);border-top:1px solid var(--b0);position:relative}
.vs canvas{display:block;width:100%;height:100%}
.vs-lbl{position:absolute;top:3px;left:8px;font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;text-transform:uppercase}

/* ── INDICATOR BAR ── */
.ind-bar{display:flex;gap:0;border-top:1px solid var(--b0);flex-shrink:0;overflow-x:auto;scrollbar-width:none;background:rgba(10,11,13,0.8)}
.ind-bar::-webkit-scrollbar{display:none}
.ind-tile{padding:6px 12px;border-right:1px solid var(--b0);display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.ind-lbl{font-size:7px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--txt3)}
.ind-v{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--txt)}
.ind-v.bull{color:var(--green)}.ind-v.bear{color:var(--red)}.ind-v.neut{color:var(--cyan)}

/* ── RIGHT TRADE PANEL ── */
#col-trade{width:310px;flex-shrink:0;background:var(--s1);border-left:1px solid var(--b0);
  display:flex;flex-direction:column;overflow:hidden}

/* Tabs inside trade panel */
.tpanel-tabs{display:flex;border-bottom:1px solid var(--b0);flex-shrink:0}
.tptab{flex:1;padding:8px 4px;text-align:center;font-weight:700;font-size:8px;letter-spacing:.8px;
  text-transform:uppercase;cursor:pointer;border:none;background:transparent;color:var(--txt3);
  border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s}
.tptab.on{color:var(--violet);border-bottom-color:var(--violet)}

/* Trade panel body */
.tpanel-body{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0}

/* Live price band */
.live-band{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;
  background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(5,177,105,0.04));
  border-bottom:1px solid var(--b0);flex-shrink:0}
.lb-px{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--cyan)}
.lb-mkt{font-size:9px;font-weight:700;color:var(--txt2)}
.lb-sub{font-size:8px;color:var(--txt3)}

/* Contract type selector */
.ct-sect{padding:8px 10px;border-bottom:1px solid var(--b0);flex-shrink:0}
.ct-lbl{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:6px}
.ct-btns{display:flex;gap:4px;flex-wrap:wrap}
.ctb-pill{padding:4px 8px;border-radius:8px;font-size:8px;font-weight:700;cursor:pointer;
  border:1px solid var(--b0);background:transparent;color:var(--txt3);transition:all .15s;flex-shrink:0;white-space:nowrap}
.ctb-pill:hover{color:var(--violet);border-color:rgba(0,82,255,0.35)}
.ctb-pill.on{background:rgba(255,255,255,0.10);color:var(--violet);border-color:rgba(0,82,255,0.35)}
.ctb-pill.on.rf{color:var(--cyan);border-color:rgba(5,177,105,0.4);background:rgba(5,177,105,0.08)}
.ctb-pill.on.dg{color:var(--gold);border-color:rgba(245,158,11,0.4);background:rgba(247,147,26,0.08)}

/* Form groups */
.fg{padding:8px 10px;display:flex;flex-direction:column;gap:7px;border-bottom:1px solid var(--b0);flex-shrink:0}
.fl{font-size:7px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--txt3);margin-bottom:2px}
.fi,.fs{background:rgba(139,92,246,0.05);border:1px solid var(--b0);border-radius:7px;
  padding:8px 10px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:12px;
  width:100%;outline:none;transition:border-color .2s;-webkit-appearance:none;min-height:38px}
.fi:focus,.fs:focus{border-color:rgba(0,82,255,0.35);box-shadow:0 0 0 2px rgba(255,255,255,0.04)}
.dr{display:flex;gap:6px}.dr .fi,.dr .fs{flex:1}
.psets{display:flex;gap:4px;flex-wrap:wrap}
.ps{padding:4px 8px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;border:1px solid var(--b0);background:rgba(255,255,255,0.02);color:var(--txt3);transition:all .15s}
.ps:hover{color:var(--violet);border-color:rgba(0,82,255,0.25);background:rgba(255,255,255,0.04)}

/* Over/Under digit selector */
.digit-sect{padding:8px 10px;border-bottom:1px solid var(--b0);flex-shrink:0}
.digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-top:6px}
.digit-btn{padding:7px 3px;border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:12px;
  font-weight:700;cursor:pointer;border:1px solid var(--b0);background:rgba(255,255,255,0.02);
  color:var(--txt2);transition:all .15s;text-align:center;position:relative;overflow:hidden}
.digit-btn .d-pct{position:absolute;bottom:1px;left:0;right:0;font-size:6px;color:var(--txt3);text-align:center;font-weight:400;font-family:'JetBrains Mono',monospace}
.digit-btn:hover{border-color:rgba(0,82,255,0.35);color:var(--violet);background:rgba(255,255,255,0.05)}
.digit-btn.sel{background:rgba(255,255,255,0.14);color:var(--violet);border-color:rgba(0,82,255,0.45);
  box-shadow:0 0 12px rgba(255,255,255,0.16)}
.digit-btn.hot{background:rgba(240,82,82,0.1);color:var(--red);border-color:rgba(240,82,82,0.3)}
.digit-btn.cold{background:rgba(5,177,105,0.1);color:var(--green);border-color:rgba(5,177,105,0.3)}
.digit-btn.warm{background:rgba(247,147,26,0.08);color:var(--gold);border-color:rgba(245,158,11,0.25)}

/* Direction buttons */
.dir-btns{display:flex;gap:4px;padding:8px 10px;border-bottom:1px solid var(--b0);flex-shrink:0}
.dir-btn{flex:1;padding:10px;border-radius:8px;font-weight:800;font-size:10px;letter-spacing:.5px;
  cursor:pointer;border:none;transition:all .2s;text-transform:uppercase}
.dir-btn.up{background:linear-gradient(135deg,rgba(5,177,105,0.2),rgba(5,177,105,0.1));
  color:var(--green);border:1px solid rgba(5,177,105,0.35)}
.dir-btn.up:hover,.dir-btn.up.sel{background:#05b169;color:#fff;
  box-shadow:0 0 20px rgba(16,185,129,0.4);border-color:transparent}
.dir-btn.dn{background:linear-gradient(135deg,rgba(240,82,82,0.2),rgba(240,82,82,0.1));
  color:var(--red);border:1px solid rgba(240,82,82,0.35)}
.dir-btn.dn:hover,.dir-btn.dn.sel{background:#f05252;color:#fff;
  box-shadow:0 0 20px rgba(240,82,82,0.4);border-color:transparent}

/* Payout display */
.poc{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;
  background:rgba(255,255,255,0.04);border-bottom:1px solid var(--b0);flex-shrink:0}
.poc-l{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3)}
.poc-v{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:16px;color:var(--green)}
.poc-p{font-family:'Inter',sans-serif;font-weight:700;font-size:14px;color:var(--violet)}

/* Execute button */
.exec-btn{margin:8px 10px;padding:12px;border-radius:8px;font-weight:800;font-size:11px;
  letter-spacing:.4px;cursor:pointer;border:none;transition:all .2s;text-transform:uppercase;
  position:relative;overflow:hidden}
.exec-btn.buy{background:#0052ff;color:#fff;
  box-shadow:0 4px 20px rgba(0,82,255,0.35)}
.exec-btn.buy:hover{box-shadow:0 6px 30px rgba(0,82,255,0.55)}
.exec-btn.sell{background:#f05252;color:#fff;
  box-shadow:0 4px 20px rgba(240,82,82,0.35)}
.exec-btn.sell:hover{box-shadow:0 6px 30px rgba(239,68,68,0.5)}
.exec-btn.even{background:linear-gradient(135deg,#2d8a89,#05b169);color:#fff;box-shadow:0 4px 20px rgba(5,177,105,0.35)}
.exec-btn.odd{background:linear-gradient(135deg,#9d174d,#0052ff);color:#fff;box-shadow:0 4px 20px rgba(236,72,153,0.35)}
.exec-btn::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.1);opacity:0;transition:opacity .2s}
.exec-btn:active::before{opacity:1}
.exec-btn:active{transform:scale(.98)}

/* Stats grid */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--b0);border-top:1px solid var(--b0);flex-shrink:0}
.st{background:var(--s1);padding:8px 10px}
.sl{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:3px}
.sv{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px;color:var(--txt)}
.sv.g{color:var(--up)}.sv.r{color:var(--dn)}.sv.c{color:var(--cyan)}

/* ── DIGIT ANALYSIS PANEL ── */
#col-digit{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}

/* Probability box */
.prob-box{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.prob-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px}
.prob-bar-wrap{display:flex;height:6px;border-radius:3px;overflow:hidden;gap:1px;margin-bottom:4px}
.prob-bull{background:var(--green);transition:width .5s}
.prob-bear{background:var(--red);transition:width .5s}
.prob-labels{display:flex;justify-content:space-between;margin-top:3px}
.prob-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700}
.prob-lbl.g{color:var(--green)}.prob-lbl.r{color:var(--red)}

/* Digit frequency heatmap */
.dhmap{display:grid;grid-template-columns:repeat(10,1fr);gap:3px;padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.dh-cell{display:flex;flex-direction:column;align-items:center;border-radius:6px;padding:5px 2px;transition:all .25s;cursor:default;position:relative}
.dh-num{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700}
.dh-pct{font-size:7px;margin-top:1px;font-weight:600}
.dh-bar-wrap{width:100%;border-radius:2px;overflow:hidden;height:3px;margin-top:3px;background:rgba(255,255,255,0.05)}
.dh-bar-fill{height:100%;border-radius:2px;transition:width .5s}

/* Next digit prediction */
.pred-sect{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.pred-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px}
.pred-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:8px}
.pred-cell{border-radius:6px;padding:6px 4px;text-align:center;border:1px solid var(--b0);transition:all .3s}
.pred-num{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--txt)}
.pred-pct{font-size:7px;color:var(--txt3);margin-top:2px;font-family:'JetBrains Mono',monospace}
.pred-cell.best{border-color:rgba(16,185,129,0.5);background:rgba(5,177,105,0.1)}
.pred-cell.best .pred-num{color:var(--green)}
.pred-cell.worst{border-color:rgba(240,82,82,0.4);background:rgba(239,68,68,0.07)}
.pred-cell.worst .pred-num{color:var(--red)}

/* Streak & pattern */
.streak-sect{padding:10px 12px;flex-shrink:0;border-bottom:1px solid var(--b0)}
.streak-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px}
.last-digits{display:flex;gap:3px;flex-wrap:wrap}
.ld{width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;flex-shrink:0}
.ld.ev{background:rgba(5,177,105,0.15);color:var(--cyan);border:1px solid rgba(34,211,238,0.3)}
.ld.od{background:rgba(236,72,153,0.12);color:var(--pink);border:1px solid rgba(236,72,153,0.25)}

/* Over/Under analysis */
.ou-sect{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.ou-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
.ou-card{border-radius:8px;padding:8px 10px;text-align:center;border:1px solid var(--b0)}
.ou-label{font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--txt3)}
.ou-val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;margin-top:3px}
.ou-card.over{background:rgba(16,185,129,0.07);border-color:rgba(16,185,129,0.25)}
.ou-card.over .ou-val{color:var(--green)}
.ou-card.under{background:rgba(239,68,68,0.07);border-color:rgba(239,68,68,0.25)}
.ou-card.under .ou-val{color:var(--red)}
.ou-card.even{background:rgba(34,211,238,0.07);border-color:rgba(5,177,105,0.25)}
.ou-card.even .ou-val{color:var(--cyan)}
.ou-card.odd{background:rgba(236,72,153,0.07);border-color:rgba(236,72,153,0.25)}
.ou-card.odd .ou-val{color:var(--pink)}

/* ── RISE/FALL PANEL ── */
#col-rf{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}

/* Tick counter */
.tick-counter{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.tc-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tc-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3)}
.tc-controls{display:flex;gap:4px;align-items:center}
.tc-num-input{width:50px;background:rgba(255,255,255,0.04);border:1px solid var(--b0);border-radius:5px;
  padding:3px 6px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:10px;text-align:center;outline:none}
.tc-btn{padding:3px 8px;border-radius:5px;font-size:8px;font-weight:700;cursor:pointer;border:1px solid var(--b0);
  background:rgba(255,255,255,0.05);color:var(--violet);letter-spacing:.5px;text-transform:uppercase;transition:all .15s}
.tc-btn:hover{background:rgba(255,255,255,0.14)}
.tc-btn.active{background:rgba(240,82,82,0.15);color:var(--red);border-color:rgba(240,82,82,0.3)}
.tick-dots{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px;min-height:22px}
.tick-dot{width:8px;height:8px;border-radius:50%;transition:all .2s;flex-shrink:0}
.tick-dot.up{background:var(--green);box-shadow:0 0 4px var(--green)}
.tick-dot.dn{background:var(--red);box-shadow:0 0 4px var(--red)}
.tick-dot.pending{background:var(--txt3);opacity:.4}
.tc-result{margin-top:6px;padding:6px 10px;border-radius:6px;text-align:center;font-weight:800;font-size:10px;letter-spacing:.5px;display:none}
.tc-result.rise{background:rgba(5,177,105,0.15);color:var(--green);border:1px solid rgba(5,177,105,0.35)}
.tc-result.fall{background:rgba(240,82,82,0.15);color:var(--red);border:1px solid rgba(240,82,82,0.35)}

/* Candlestick analysis */
.cs-analysis{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.cs-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px}
.pattern-list{display:flex;flex-direction:column;gap:5px}
.pattern-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;
  border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid var(--b0)}
.pi-name{font-size:9px;font-weight:700;color:var(--txt2)}
.pi-signal{font-size:8px;font-weight:700;padding:2px 7px;border-radius:4px}
.pi-signal.bull{background:rgba(5,177,105,0.15);color:var(--green)}
.pi-signal.bear{background:rgba(239,68,68,0.12);color:var(--red)}
.pi-signal.neut{background:rgba(255,255,255,0.06);color:var(--violet)}
.pi-conf{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txt3)}

/* Rise/Fall prediction */
.rf-pred{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.rf-pred-box{border-radius:10px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;transition:all .5s}
.rf-pred-box.rise{background:linear-gradient(135deg,rgba(16,185,129,0.12),rgba(16,185,129,0.04));border:1px solid rgba(5,177,105,0.3)}
.rf-pred-box.fall{background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(239,68,68,0.04));border:1px solid rgba(240,82,82,0.3)}
.rf-pred-box.neut{background:rgba(255,255,255,0.04);border:1px solid var(--b0)}
.rfp-dir{font-weight:800;font-size:16px}
.rfp-dir.rise{color:var(--green)}.rfp-dir.fall{color:var(--red)}.rfp-dir.neut{color:var(--violet)}
.rfp-conf{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700}
.rfp-reason{font-size:8px;color:var(--txt3);line-height:1.5;max-width:130px}

/* ── LDP TOOL ── */
#col-ldp{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}
.ldp-hdr{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0}
.ldp-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px}
.ldp-controls{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.ldp-sel{background:rgba(255,255,255,0.04);border:1px solid var(--b0);border-radius:6px;
  padding:5px 8px;color:var(--txt2);font-family:'JetBrains Mono',monospace;font-size:9px;
  outline:none;-webkit-appearance:none;cursor:pointer}
.ldp-sel option{background:#181818}
.ldp-run-btn{padding:5px 14px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-weight:700;
  font-size:9px;letter-spacing:1.5px;cursor:pointer;border:1px solid rgba(0,82,255,0.35);
  background:rgba(255,255,255,0.06);color:var(--violet);text-transform:uppercase;transition:all .2s}
.ldp-run-btn:hover{background:rgba(255,255,255,0.14);box-shadow:0 0 12px rgba(255,255,255,0.14)}
.ldp-run-btn.running{color:var(--gold);border-color:rgba(245,158,11,0.4);background:rgba(247,147,26,0.08);animation:scanPulse .8s ease-in-out infinite}
@keyframes scanPulse{0%,100%{opacity:1}50%{opacity:.5}}

.ldp-body{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:8px}

/* LDP card */
.ldp-card{border-radius:8px;border:1px solid var(--b0);background:rgba(10,11,13,0.7);padding:10px 12px;
  cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.ldp-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.ldp-card.bull::before{background:var(--green)}
.ldp-card.bear::before{background:var(--red)}
.ldp-card.neut::before{background:var(--violet)}
.ldp-card:hover{background:rgba(26,21,53,0.9);border-color:rgba(255,255,255,0.16);transform:translateY(-1px)}
.ldp-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.ldp-sym{font-family:'Inter',sans-serif;font-size:10px;font-weight:700;color:var(--txt)}
.ldp-signal{font-size:8px;font-weight:700;padding:2px 8px;border-radius:4px}
.ldp-signal.bull{background:rgba(5,177,105,0.15);color:var(--green)}
.ldp-signal.bear{background:rgba(239,68,68,0.12);color:var(--red)}
.ldp-signal.neut{background:rgba(255,255,255,0.06);color:var(--violet)}
.ldp-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:8px}
.ldp-m{text-align:center;background:rgba(255,255,255,0.02);border-radius:4px;padding:4px}
.ldp-ml{font-size:6px;color:var(--txt3);letter-spacing:.5px;text-transform:uppercase}
.ldp-mv{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:var(--txt);margin-top:1px}
.ldp-bars{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.ldp-bar-row{display:flex;align-items:center;gap:6px}
.ldp-bar-lbl{font-size:7px;color:var(--txt3);width:60px;flex-shrink:0;text-transform:uppercase;letter-spacing:.5px}
.ldp-bar-track{flex:1;height:4px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden}
.ldp-bar-fill{height:100%;border-radius:2px;transition:width .8s ease}
.ldp-bar-val{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;width:30px;text-align:right;flex-shrink:0}
.ldp-foot{display:flex;align-items:center;justify-content:space-between}
.ldp-price{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:var(--txt2)}
.ldp-conf-badge{font-size:7px;font-weight:700;padding:2px 6px;border-radius:4px;letter-spacing:.5px;text-transform:uppercase}
.ldp-conf-badge.high{background:rgba(5,177,105,0.15);color:var(--green);border:1px solid rgba(16,185,129,0.25)}
.ldp-conf-badge.med{background:rgba(245,158,11,0.12);color:var(--gold);border:1px solid rgba(245,158,11,0.2)}
.ldp-conf-badge.low{background:rgba(240,82,82,0.1);color:var(--red);border:1px solid rgba(240,82,82,0.2)}
.ldp-trade-btn{padding:3px 10px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:8px;
  font-weight:700;cursor:pointer;border:1px solid rgba(0,82,255,0.25);background:rgba(255,255,255,0.06);
  color:var(--violet);letter-spacing:.5px;text-transform:uppercase;transition:all .15s}
.ldp-trade-btn:hover{background:rgba(255,255,255,0.16)}

/* Idle state */
.ldp-idle{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;text-align:center;gap:10px}
.ldp-idle-icon{font-size:32px;opacity:.3}
.ldp-idle-title{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;color:var(--violet);letter-spacing:2px;text-transform:uppercase}
.ldp-idle-sub{font-size:9px;color:var(--txt3);line-height:1.7}

/* LDP log */
.ldp-log{padding:0 12px 10px;flex-shrink:0}
.ldp-log-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:5px}
.ldp-log-entries{display:flex;flex-direction:column;gap:2px;max-height:80px;overflow-y:auto}
.ldp-log-entry{font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(0,82,255,0.45);line-height:1.5}
.ldp-log-entry.signal{color:rgba(5,177,105,0.7)}

/* ── DTRADER/DBOT INTEGRATED PANELS ── */
#col-dtrader,#col-dbot{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}

.dint-hdr{padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0;display:flex;align-items:center;gap:8px}
.dint-title{font-family:'Inter',sans-serif;font-weight:700;font-size:12px;color:var(--txt);flex:1}
.dint-badge{padding:3px 8px;border-radius:5px;font-size:8px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.dint-badge.dt{background:rgba(34,211,238,0.12);color:var(--cyan);border:1px solid rgba(5,177,105,0.25)}
.dint-badge.db{background:rgba(255,255,255,0.08);color:var(--violet);border:1px solid rgba(255,255,255,0.16)}

.dint-body{flex:1;overflow-y:auto;padding:12px}

/* DTrader form */
.dtrader-form{display:flex;flex-direction:column;gap:12px}
.dtrader-mkt-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
  border-radius:8px;background:linear-gradient(135deg,rgba(5,177,105,0.08),rgba(5,177,105,0.03));
  border:1px solid rgba(5,177,105,0.2)}
.dtm-sym{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--cyan)}
.dtm-px{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--txt)}
.dtm-chg{font-family:'JetBrains Mono',monospace;font-size:9px}

.dtrader-trade-types{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.dtt-card{border-radius:8px;padding:10px;cursor:pointer;border:1px solid var(--b0);
  background:rgba(255,255,255,0.02);transition:all .2s;text-align:center}
.dtt-card:hover{border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.05)}
.dtt-card.sel{border-color:rgba(5,177,105,0.5);background:rgba(34,211,238,0.1)}
.dtt-icon{font-size:18px;margin-bottom:4px}
.dtt-name{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px}

.dtrader-stake{display:flex;flex-direction:column;gap:6px}
.dts-lbl{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3)}
.dts-row{display:flex;gap:6px;align-items:center}
.dts-input{flex:1;background:rgba(34,211,238,0.05);border:1px solid rgba(5,177,105,0.15);
  border-radius:7px;padding:8px 10px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:13px;
  outline:none;transition:border-color .2s}
.dts-input:focus{border-color:rgba(5,177,105,0.4)}
.dts-presets{display:flex;gap:3px;flex-wrap:wrap}
.dts-ps{padding:4px 7px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;border:1px solid rgba(5,177,105,0.15);background:rgba(5,177,105,0.04);
  color:rgba(34,211,238,0.6);transition:all .15s}
.dts-ps:hover{color:var(--cyan);border-color:rgba(5,177,105,0.4)}

.dtrader-duration{display:flex;flex-direction:column;gap:6px}
.dts-dur-row{display:flex;gap:4px}
.dur-btn{flex:1;padding:6px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;
  cursor:pointer;border:1px solid rgba(5,177,105,0.15);background:transparent;color:rgba(5,177,105,0.5);
  text-align:center;transition:all .15s}
.dur-btn.on,.dur-btn:hover{background:rgba(34,211,238,0.1);color:var(--cyan);border-color:rgba(5,177,105,0.4)}

.dtrader-payout{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;
  border-radius:8px;background:rgba(34,211,238,0.05);border:1px solid rgba(5,177,105,0.15)}
.dtp-l{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(5,177,105,0.5)}
.dtp-v{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--green)}
.dtp-p{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--cyan)}

.dtrader-exec{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.dt-exec-rise{padding:12px;border-radius:8px;font-weight:800;font-size:11px;cursor:pointer;border:none;
  background:#05b169;color:#fff;text-transform:uppercase;
  box-shadow:0 4px 16px rgba(16,185,129,0.4);transition:all .2s}
.dt-exec-rise:hover{box-shadow:0 6px 24px rgba(16,185,129,0.6)}
.dt-exec-fall{padding:12px;border-radius:8px;font-weight:800;font-size:11px;cursor:pointer;border:none;
  background:#f05252;color:#fff;text-transform:uppercase;
  box-shadow:0 4px 16px rgba(240,82,82,0.4);transition:all .2s}
.dt-exec-fall:hover{box-shadow:0 6px 24px rgba(240,82,82,0.6)}

/* DBot */
.dbot-form{display:flex;flex-direction:column;gap:12px}
.dbot-status{padding:10px 12px;border-radius:8px;background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(139,92,246,0.04));border:1px solid rgba(255,255,255,0.14)}
.dbs-row{display:flex;align-items:center;justify-content:space-between}
.dbs-name{font-weight:800;font-size:11px;color:var(--violet)}
.dbs-pill{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700}
.db-dot{width:6px;height:6px;border-radius:50%}
.db-dot.run{background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 1s ease-in-out infinite}
.db-dot.stop{background:var(--txt3)}
.dbs-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:8px}
.dbss{text-align:center;background:rgba(0,0,0,0.2);border-radius:5px;padding:5px}
.dbss-l{font-size:6px;color:var(--txt3);letter-spacing:.5px;text-transform:uppercase}
.dbss-v{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--txt);margin-top:1px}

.dbot-strategy{border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--b0);padding:10px 12px}
.dbs-title{font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt2);margin-bottom:10px}
.dbs-rule{display:flex;gap:6px;margin-bottom:7px;align-items:center}
.dbs-op{font-size:8px;font-weight:700;color:var(--gold);width:22px;flex-shrink:0;text-transform:uppercase}
.dbs-sel{flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--b0);border-radius:6px;
  padding:5px 8px;color:var(--txt2);font-family:'JetBrains Mono',monospace;font-size:9px;
  outline:none;-webkit-appearance:none}
.dbs-sel option{background:#181818}
.mm-row{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.mm-lbl{font-size:8px;color:var(--txt3);width:90px;flex-shrink:0}
.mm-inp{flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--b0);border-radius:6px;
  padding:5px 8px;color:var(--txt2);font-family:'JetBrains Mono',monospace;font-size:9px;
  outline:none}
.dbot-exec{display:flex;flex-direction:column;gap:6px}
.db-start{width:100%;padding:11px;border-radius:8px;font-weight:800;font-size:10px;cursor:pointer;border:none;
  background:#0052ff;color:#fff;text-transform:uppercase;letter-spacing:.5px;
  box-shadow:0 4px 14px rgba(0,82,255,0.3);transition:all .2s}
.db-start:hover{box-shadow:0 6px 20px rgba(139,92,246,0.55)}
.db-start.stopping{background:linear-gradient(135deg,#7f1d1d,#f05252);box-shadow:0 4px 14px rgba(240,82,82,0.35)}
.db-kill{width:100%;padding:8px;border-radius:6px;font-weight:700;font-size:9px;cursor:pointer;
  border:1px solid rgba(240,82,82,0.3);background:rgba(239,68,68,0.07);color:var(--red);
  letter-spacing:.5px;text-transform:uppercase;transition:all .2s}
.db-kill:hover{background:rgba(240,82,82,0.15)}

/* ── JOURNAL PANEL ── */
#col-journal{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden}
.analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:10px 12px;flex-shrink:0;border-bottom:1px solid var(--b0)}
.an-card{border-radius:8px;padding:8px 10px;background:rgba(255,255,255,0.02);border:1px solid var(--b0)}
.an-title{font-size:7px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--txt3);margin-bottom:4px}
.an-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--txt)}
.an-val.g{color:var(--green)}.an-val.r{color:var(--red)}.an-val.c{color:var(--cyan)}.an-val.gold{color:var(--gold)}
.an-sub{font-size:8px;color:var(--txt3);margin-top:2px}

/* ── BOTTOM NAV (mobile) ── */
#bnav{position:fixed;bottom:0;left:0;right:0;height:56px;z-index:399;
  background:rgba(10,11,13,0.98);border-top:1px solid var(--b0);
  display:none;align-items:stretch;backdrop-filter:blur(20px)}
@media(max-width:959px){#bnav{display:flex}}
.bn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
  cursor:pointer;border:none;background:transparent;color:var(--txt3);font-size:7px;
  font-weight:700;letter-spacing:.5px;text-transform:uppercase;transition:all .2s}
.bn-ico{font-size:16px;line-height:1}
.bn.act{color:var(--violet)}

/* ── DESKTOP PANEL SYSTEM ── */
/* On desktop: market sidebar always visible, chart always visible, right panel switches */
@media(min-width:960px){
  #col-chart{display:flex!important}
  /* All switchable panels hidden by default, shown via .active class */
  #col-digit,#col-rf,#col-ldp,#col-dtrader,#col-dbot,#col-journal,#col-trade,#col-motivation{
    display:none!important;
  }
  #col-digit.active,#col-rf.active,#col-ldp.active,#col-dtrader.active,
  #col-dbot.active,#col-journal.active,#col-trade.active,#col-motivation.active{
    display:flex!important;
  }
}

/* ── MOBILE LAYOUT ── */
@media(max-width:959px){
  #page{bottom:56px;flex-direction:column}
  #col-chart,#col-trade,#col-digit,#col-rf,#col-ldp,#col-dtrader,#col-dbot,#col-journal,#col-motivation{
    position:absolute;inset:0;display:none!important}
  #col-chart.active,#col-trade.active,#col-digit.active,#col-rf.active,#col-ldp.active,
  #col-dtrader.active,#col-dbot.active,#col-journal.active,#col-motivation.active{display:flex!important}
  #col-trade{width:100%}
}

/* ── MODAL ── */
#modalBg{position:fixed;inset:0;z-index:600;display:flex;align-items:flex-end;justify-content:center;
  background:rgba(0,0,0,0.85);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .3s}
#modalBg.on{opacity:1;pointer-events:all}
#modal{background:#242424;border:1px solid rgba(255,255,255,0.1);border-radius:16px 16px 0 0;
  width:100%;max-width:460px;transform:translateY(60px);
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);box-shadow:0 -24px 64px rgba(0,0,0,0.7)}
#modalBg.on #modal{transform:translateY(0)}
@media(min-width:600px){#modalBg{align-items:center}#modal{border-radius:16px;max-width:400px}}
.m-drag{width:40px;height:4px;border-radius:2px;background:var(--b1);margin:12px auto 0}
.m-body{padding:20px 22px 30px}
.m-title{font-family:'Inter',sans-serif;font-weight:700;font-size:18px;color:var(--txt);margin-bottom:5px}
.m-sub{font-size:10px;color:var(--txt3);line-height:1.7;margin-bottom:18px}
.m-sub strong{color:var(--violet)}
.m-inp{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.14);border-radius:8px;
  padding:11px 13px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:12px;
  width:100%;margin-bottom:10px;outline:none;min-height:44px;transition:border-color .2s}
.m-inp:focus{border-color:rgba(0,82,255,0.45)}
.m-go{width:100%;padding:12px;border-radius:8px;font-weight:800;font-size:11px;cursor:pointer;border:none;
  background:#0052ff;color:#fff;
  box-shadow:0 0 18px rgba(0,82,255,0.3);transition:all .2s;text-transform:uppercase;letter-spacing:.5px;min-height:44px;margin-bottom:8px}
.m-skip{width:100%;padding:10px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;border:1px solid var(--b0);background:transparent;color:var(--txt3);min-height:38px}
.m-demo{font-size:9px;text-align:center;color:var(--txt3);margin-top:8px}
.m-demo a{color:var(--violet);cursor:pointer;text-decoration:underline}
.m-divider{display:flex;align-items:center;gap:10px;margin:14px 0 12px;color:var(--txt3);font-size:9px;letter-spacing:.5px;text-transform:uppercase}
.m-divider::before,.m-divider::after{content:'';flex:1;height:1px;background:var(--b0)}
#oauthBtn{position:relative;overflow:hidden}
#oauthBtn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.07),transparent);transform:translateX(-100%);transition:transform .5s}
#oauthBtn:hover::after{transform:translateX(100%)}

/* ── TOAST ── */
#toast{position:fixed;top:calc(118px + 10px);left:50%;transform:translateX(-50%) translateY(-120px);
  z-index:700;display:none;align-items:center;gap:10px;padding:9px 14px;border-radius:10px;
  background:rgba(10,11,13,0.98);border:1px solid rgba(255,255,255,0.14);
  box-shadow:0 10px 40px rgba(0,0,0,0.7);backdrop-filter:blur(20px);
  max-width:calc(100vw - 32px);white-space:nowrap;transition:transform .4s cubic-bezier(.34,1.56,.64,1)}
#toast.on{transform:translateX(-50%) translateY(0)}
.t-ico{font-size:15px;flex-shrink:0}
.t-title{font-weight:700;font-size:10px;color:var(--txt)}
.t-body{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txt2)}

/* ── BANNER ── */
#banner{position:fixed;bottom:56px;left:0;right:0;z-index:200;padding:5px 12px;text-align:center;
  font-size:9px;font-weight:600;background:rgba(247,147,26,0.08);
  border-top:1px solid rgba(245,158,11,0.2);color:var(--gold);display:none}
#banner a{color:var(--gold);cursor:pointer;text-decoration:underline}
@media(min-width:960px){#banner{bottom:0}}


/* ── MOBILE FIXES ── */
@media(max-width:959px){
  #tnav{display:none!important}
  #ticker{display:none!important}
  #page{top:52px!important}
  .hdr-center{display:none!important}
  #hdr{padding:0 10px}
}

/* ══════════════════════════════════════════════════
   AUTOMATED TICK COUNTER  — ATC styles
   Scoped under #col-chart to avoid conflicts
══════════════════════════════════════════════════ */

/* Top bar */
.atc-topbar{display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--b0);
  flex-shrink:0;gap:8px}
.atc-sym-group{display:flex;align-items:center;gap:7px;min-width:0}
.atc-sym{font-size:14px;font-weight:800;color:var(--txt);letter-spacing:-0.3px}
.atc-symname{font-size:10px;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.atc-price-group{display:flex;align-items:baseline;gap:5px;flex-shrink:0}
.atc-live-px{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--cyan);transition:color .25s}
.atc-live-px.flash-g{color:var(--green)!important}
.atc-live-px.flash-r{color:var(--red)!important}
.atc-live-chg{font-family:'JetBrains Mono',monospace;font-size:11px}

/* Hero area */
.atc-hero{flex-shrink:0;background:linear-gradient(160deg,var(--s2) 0%,var(--bg) 100%);
  border-bottom:1px solid var(--b0);padding:18px 14px 14px}
.atc-hero-inner{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.atc-pulse-ring{width:14px;height:14px;border-radius:50%;background:var(--green);
  box-shadow:0 0 0 0 rgba(5,177,105,0.5);
  animation:atcPulse 1.8s ease-in-out infinite;flex-shrink:0}
.atc-pulse-ring.dn{background:var(--red);box-shadow:0 0 0 0 rgba(240,82,82,0.5);
  animation:atcPulseR 1.8s ease-in-out infinite}
.atc-pulse-ring.idle{background:var(--txt3);box-shadow:none;animation:none}
@keyframes atcPulse{0%{box-shadow:0 0 0 0 rgba(5,177,105,0.6)}70%{box-shadow:0 0 0 10px rgba(5,177,105,0)}100%{box-shadow:0 0 0 0 rgba(5,177,105,0)}}
@keyframes atcPulseR{0%{box-shadow:0 0 0 0 rgba(240,82,82,0.6)}70%{box-shadow:0 0 0 10px rgba(240,82,82,0)}100%{box-shadow:0 0 0 0 rgba(240,82,82,0)}}
.atc-hero-px{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:700;
  color:var(--txt);letter-spacing:-1px;line-height:1;transition:color .2s}
.atc-hero-px.g{color:var(--green)}.atc-hero-px.r{color:var(--red)}
.atc-hero-dir{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--txt3);margin-left:auto;padding:3px 10px;border-radius:20px;
  background:rgba(255,255,255,0.05);border:1px solid var(--b0);white-space:nowrap}
.atc-hero-dir.g{color:var(--green);background:rgba(5,177,105,0.1);border-color:rgba(5,177,105,0.3)}
.atc-hero-dir.r{color:var(--red);background:rgba(240,82,82,0.1);border-color:rgba(240,82,82,0.3)}

/* Session cards */
.atc-session-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.atc-sess-card{background:rgba(255,255,255,0.03);border:1px solid var(--b0);
  border-radius:8px;padding:8px;text-align:center}
.atc-sess-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--txt);line-height:1}
.atc-sess-val.g{color:var(--green)}.atc-sess-val.r{color:var(--red)}
.atc-sess-lbl{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--txt3);margin-top:3px}

/* Controls */
.atc-controls{display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;border-bottom:1px solid var(--b0);background:var(--s1);flex-shrink:0;flex-wrap:wrap}
.atc-ctrl-group{display:flex;flex-direction:column;gap:5px}
.atc-ctrl-lbl{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--txt3)}
.atc-size-btns{display:flex;gap:4px}
.atc-sz{padding:5px 11px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;
  border:1px solid var(--b0);background:transparent;color:var(--txt3);
  font-family:'JetBrains Mono',monospace;transition:all .15s}
.atc-sz:hover{color:var(--txt);border-color:var(--accent)}
.atc-sz.on{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 0 12px rgba(0,82,255,0.3)}
.atc-toggle-btn{padding:7px 14px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;
  border:1px solid rgba(5,177,105,0.4);background:rgba(5,177,105,0.1);color:var(--green);
  letter-spacing:.5px;text-transform:uppercase;transition:all .2s;white-space:nowrap}
.atc-toggle-btn.paused{border-color:rgba(0,82,255,0.4);background:rgba(0,82,255,0.1);color:var(--accent)}
.atc-rst-btn{padding:7px 10px;border-radius:8px;font-size:14px;cursor:pointer;
  border:1px solid var(--b0);background:rgba(255,255,255,0.04);color:var(--txt3);transition:all .2s}
.atc-rst-btn:hover{color:var(--txt);background:rgba(255,255,255,0.08)}

/* Round progress bar */
.atc-round-bar{padding:8px 14px;border-bottom:1px solid var(--b0);flex-shrink:0;
  background:rgba(0,82,255,0.03)}
.atc-round-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.atc-rmeta-item{font-size:10px;color:var(--txt3);font-weight:600}
.atc-rmeta-item strong{color:var(--accent);font-family:'JetBrains Mono',monospace}
.atc-progress-track{height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden}
.atc-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--cyan));
  border-radius:2px;transition:width .3s ease;box-shadow:0 0 8px rgba(0,82,255,0.5)}

/* Tick dots */
.atc-dots-area{padding:12px 14px;display:flex;flex-wrap:wrap;gap:7px;
  border-bottom:1px solid var(--b0);flex-shrink:0;min-height:58px;align-content:flex-start}
.atc-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:10px;font-weight:700;transition:all .2s;flex-shrink:0}
.atc-dot.up{background:rgba(5,177,105,0.2);border:2px solid var(--green);color:var(--green);
  box-shadow:0 0 8px rgba(5,177,105,0.4)}
.atc-dot.dn{background:rgba(240,82,82,0.2);border:2px solid var(--red);color:var(--red);
  box-shadow:0 0 8px rgba(240,82,82,0.4)}
.atc-dot.pending{background:rgba(255,255,255,0.04);border:2px solid rgba(255,255,255,0.1);color:transparent}
.atc-dot.next{background:rgba(0,82,255,0.1);border:2px dashed rgba(0,82,255,0.5);
  animation:blink .7s ease-in-out infinite}

/* Result flash */
.atc-result-flash{padding:12px 14px;flex-shrink:0;border-bottom:1px solid var(--b0);
  display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center}
.atc-result-flash.rise{background:rgba(5,177,105,0.06)}
.atc-result-flash.fall{background:rgba(240,82,82,0.06)}
.atc-rf-dir{font-size:26px;font-weight:900;letter-spacing:-0.5px;line-height:1}
.atc-result-flash.rise .atc-rf-dir{color:var(--green)}
.atc-result-flash.fall .atc-rf-dir{color:var(--red)}
.atc-rf-stats{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txt2)}
.atc-rf-next{font-size:10px;color:var(--txt3);margin-top:2px}
.atc-rf-next span{color:var(--accent);font-weight:700}

/* Bias bar */
.atc-bias-section{padding:10px 14px;border-bottom:1px solid var(--b0);flex-shrink:0}
.atc-bias-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.atc-bias-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--txt3)}
.atc-bias-lbl{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700}
.atc-bias-lbl.g{color:var(--green)}.atc-bias-lbl.r{color:var(--red)}
.atc-bias-track{height:8px;border-radius:4px;overflow:hidden;display:flex;
  background:rgba(255,255,255,0.05)}
.atc-bias-g{background:linear-gradient(90deg,var(--green),rgba(5,177,105,0.6));
  height:100%;transition:width .5s ease}
.atc-bias-r{background:linear-gradient(90deg,rgba(240,82,82,0.6),var(--red));
  height:100%;transition:width .5s ease}

/* Round history */
.atc-history{flex:1;overflow-y:auto;min-height:0;display:flex;flex-direction:column}
.atc-hist-hdr{padding:8px 14px;font-size:8px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:var(--txt3);border-bottom:1px solid var(--b0);flex-shrink:0}
.atc-hist-scroll{flex:1;overflow-y:auto;padding:8px 14px;display:flex;flex-direction:column;gap:5px}
.atc-hist-row{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;
  background:rgba(255,255,255,0.025);border:1px solid var(--b0)}
.atc-hr-round{font-size:9px;color:var(--txt3);font-weight:700;min-width:22px;font-family:'JetBrains Mono',monospace}
.atc-hr-dots{display:flex;gap:3px;flex:1;flex-wrap:wrap;align-items:center}
.atc-hr-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.atc-hr-dot.up{background:var(--green)}.atc-hr-dot.dn{background:var(--red)}
.atc-hr-result{font-size:12px;font-weight:800;min-width:44px;text-align:right;white-space:nowrap}
.atc-hr-result.rise{color:var(--green)}.atc-hr-result.fall{color:var(--red)}.atc-hr-result.neut{color:var(--txt3)}
.atc-hr-conf{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);min-width:30px;text-align:right}

@media(max-width:959px){
  .atc-hero-px{font-size:26px!important}
  .atc-sess-val{font-size:16px!important}
  .atc-session-row{grid-template-columns:repeat(2,1fr)!important}
  .atc-dot{width:20px!important;height:20px!important;font-size:9px!important}
}

/* ══════════════════════════════════════════
   TICK COUNTER AUTO BOT STYLES
══════════════════════════════════════════ */
.atcbot-wrap{
  flex-shrink:0;border-top:2px solid rgba(0,82,255,0.3);
  background:var(--s1);display:flex;flex-direction:column;
  max-height:320px;
}
.atcbot-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid var(--b0);flex-shrink:0;
  background:linear-gradient(90deg,rgba(0,82,255,0.06),transparent);
}
.atcbot-hdr-left{display:flex;align-items:center;gap:8px}
.atcbot-status-dot{
  width:9px;height:9px;border-radius:50%;background:var(--txt3);
  flex-shrink:0;transition:all .3s
}
.atcbot-status-dot.running{background:var(--green);box-shadow:0 0 8px rgba(5,177,105,0.6);animation:blink 1.2s ease-in-out infinite}
.atcbot-status-dot.error{background:var(--red);box-shadow:0 0 8px rgba(240,82,82,0.5)}
.atcbot-title{font-size:11px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--txt)}
.atcbot-badge{
  font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  padding:2px 7px;border-radius:10px;
  background:rgba(255,255,255,0.07);color:var(--txt3);border:1px solid var(--b0)
}
.atcbot-badge.running{background:rgba(5,177,105,0.12);color:var(--green);border-color:rgba(5,177,105,0.3)}
.atcbot-badge.win{background:rgba(5,177,105,0.12);color:var(--green);border-color:rgba(5,177,105,0.3)}
.atcbot-badge.loss{background:rgba(240,82,82,0.12);color:var(--red);border-color:rgba(240,82,82,0.3)}
.atcbot-badge.stopped{background:rgba(247,147,26,0.12);color:var(--gold);border-color:rgba(247,147,26,0.3)}
.atcbot-hdr-right{display:flex;align-items:center;gap:8px}
.atcbot-pnl{
  font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;
  color:var(--txt);transition:color .3s;min-width:60px;text-align:right
}
.atcbot-pnl.pos{color:var(--green)}.atcbot-pnl.neg{color:var(--red)}
.atcbot-main-btn{
  padding:7px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;
  background:var(--accent);color:#fff;border:none;letter-spacing:.5px;
  text-transform:uppercase;transition:all .2s;white-space:nowrap;
  box-shadow:0 0 16px rgba(0,82,255,0.25)
}
.atcbot-main-btn:hover{box-shadow:0 0 24px rgba(0,82,255,0.45);transform:translateY(-1px)}
.atcbot-main-btn.stop{background:#f05252;box-shadow:0 0 16px rgba(240,82,82,0.25)}
.atcbot-main-btn.stop:hover{box-shadow:0 0 24px rgba(240,82,82,0.45)}

/* Settings */
.atcbot-settings{padding:10px 14px;border-bottom:1px solid var(--b0);flex-shrink:0;display:flex;flex-direction:column;gap:8px}
.atcbot-row{display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap}
.atcbot-field{display:flex;flex-direction:column;gap:4px;flex:1;min-width:70px}
.atcbot-lbl{font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--txt3)}
.atcbot-inp{
  background:rgba(255,255,255,0.05);border:1px solid var(--b0);border-radius:7px;
  padding:6px 8px;color:var(--txt);font-family:'JetBrains Mono',monospace;
  font-size:12px;font-weight:600;text-align:center;outline:none;width:100%;
  transition:border-color .2s
}
.atcbot-inp:focus{border-color:rgba(0,82,255,0.5)}
.atcbot-inp:disabled{opacity:0.45;cursor:not-allowed}
.atcbot-dir-btn{
  padding:6px 12px;border-radius:7px;font-size:10px;font-weight:700;cursor:pointer;
  border:1px solid var(--b0);background:rgba(255,255,255,0.04);color:var(--txt3);
  letter-spacing:.5px;text-transform:uppercase;transition:all .15s;white-space:nowrap
}
.atcbot-dir-btn.on{
  background:rgba(0,82,255,0.15);color:var(--accent);border-color:rgba(0,82,255,0.4)
}
.atcbot-dir-btn:hover:not(.on){color:var(--txt);border-color:rgba(255,255,255,0.2)}

/* Log */
.atcbot-log{flex:1;overflow-y:auto;padding:8px 14px;display:flex;flex-direction:column;gap:3px;min-height:60px;max-height:120px}
.atcbot-log-idle{font-size:10px;color:var(--txt3);text-align:center;padding:12px 0;line-height:1.6}
.ablog{display:flex;align-items:flex-start;gap:8px;font-size:10px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.ablog-time{color:var(--txt3);font-family:'JetBrains Mono',monospace;font-size:9px;flex-shrink:0;margin-top:1px}
.ablog-ico{flex-shrink:0}
.ablog-msg{color:var(--txt2);flex:1;line-height:1.4}
.ablog.win .ablog-msg{color:var(--green)}.ablog.loss .ablog-msg{color:var(--red)}
.ablog.info .ablog-msg{color:var(--cyan)}.ablog.warn .ablog-msg{color:var(--gold)}

/* ══════════════════════════════════════════
   ADVANCED DIGIT PATTERN BOT — dpbot styles
══════════════════════════════════════════ */
.dpbot-wrap{
  display:flex;flex-direction:column;border-top:2px solid rgba(0,82,255,0.25);
  background:var(--s1);flex-shrink:0;
}

/* Signal row */
.dpbot-signal-row{display:flex;gap:0;border-bottom:1px solid var(--b0);flex-shrink:0}
.dpbot-signal-card{
  flex:1;padding:12px 14px;border-right:1px solid var(--b0);
  display:flex;flex-direction:column;gap:4px;
  background:linear-gradient(135deg,rgba(0,82,255,0.04),transparent);
  transition:background .3s
}
.dpbot-signal-card.over-sig{background:linear-gradient(135deg,rgba(5,177,105,0.08),transparent)}
.dpbot-signal-card.under-sig{background:linear-gradient(135deg,rgba(240,82,82,0.08),transparent)}
.dpbot-sig-label{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--txt3)}
.dpbot-sig-dir{font-size:20px;font-weight:900;color:var(--txt);line-height:1.1;letter-spacing:-0.3px}
.dpbot-sig-dir.over{color:var(--green)}.dpbot-sig-dir.under{color:var(--red)}.dpbot-sig-dir.wait{color:var(--txt3)}
.dpbot-sig-detail{font-size:10px;color:var(--txt2);line-height:1.4}
.dpbot-window-card{padding:10px 12px;display:flex;flex-direction:column;gap:4px;flex-shrink:0;min-width:130px}
.dpbot-win-btns{display:flex;gap:3px;flex-wrap:wrap}
.dpbot-wb{padding:3px 9px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;
  border:1px solid var(--b0);background:transparent;color:var(--txt3);transition:all .15s;
  font-family:'JetBrains Mono',monospace}
.dpbot-wb:hover{color:var(--txt);border-color:var(--accent)}
.dpbot-wb.on{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Pattern visualiser */
.dpbot-pattern-vis{
  display:flex;align-items:center;gap:8px;padding:10px 14px;
  border-bottom:1px solid var(--b0);flex-shrink:0;background:rgba(0,82,255,0.02)
}
.dpbot-pv-label{font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--txt3);white-space:nowrap;flex-shrink:0}
.dpbot-pv-digits{display:flex;gap:5px;flex:1;justify-content:center}
.dpbot-pv-d{
  width:30px;height:30px;border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-family:'JetBrains Mono',monospace;font-size:14px;
  font-weight:700;background:rgba(255,255,255,0.06);border:1px solid var(--b0);color:var(--txt)
}
.dpbot-pv-d.over{background:rgba(5,177,105,0.15);border-color:rgba(5,177,105,0.4);color:var(--green)}
.dpbot-pv-d.under{background:rgba(240,82,82,0.15);border-color:rgba(240,82,82,0.4);color:var(--red)}
.dpbot-pv-arrow{font-size:18px;color:var(--txt3);flex-shrink:0}
.dpbot-pv-next{
  width:36px;height:36px;border-radius:10px;display:flex;align-items:center;
  justify-content:center;font-family:'JetBrains Mono',monospace;font-size:16px;
  font-weight:700;border:2px dashed rgba(0,82,255,0.4);color:var(--accent);
  background:rgba(0,82,255,0.06);animation:blink 1.2s ease-in-out infinite;flex-shrink:0
}
.dpbot-pv-next.over{border-color:rgba(5,177,105,0.6);color:var(--green);background:rgba(5,177,105,0.1);animation:none}
.dpbot-pv-next.under{border-color:rgba(240,82,82,0.6);color:var(--red);background:rgba(240,82,82,0.1);animation:none}

/* Bot controls */
.dpbot-controls{padding:10px 14px;border-bottom:1px solid var(--b0);flex-shrink:0;display:flex;flex-direction:column;gap:7px}
.dpbot-ctrl-row{display:flex;align-items:flex-end;gap:7px;flex-wrap:wrap}
.dpbot-field{display:flex;flex-direction:column;gap:3px;flex:1;min-width:65px}
.dpbot-lbl{font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--txt3)}
.dpbot-inp{
  background:rgba(255,255,255,0.05);border:1px solid var(--b0);border-radius:7px;
  padding:6px 8px;color:var(--txt);font-family:'JetBrains Mono',monospace;
  font-size:12px;font-weight:600;text-align:center;outline:none;width:100%;transition:border-color .2s
}
.dpbot-inp:focus{border-color:rgba(0,82,255,0.5)}
.dpbot-inp:disabled{opacity:0.4;cursor:not-allowed}
.dpbot-pnl{
  font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;
  color:var(--txt);transition:color .3s;min-width:58px;text-align:right
}
.dpbot-pnl.pos{color:var(--green)}.dpbot-pnl.neg{color:var(--red)}
.dpbot-start-btn{
  padding:8px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;
  background:var(--accent);color:#fff;border:none;letter-spacing:.5px;
  text-transform:uppercase;transition:all .2s;white-space:nowrap;
  box-shadow:0 0 14px rgba(0,82,255,0.2)
}
.dpbot-start-btn:hover{box-shadow:0 0 22px rgba(0,82,255,0.4);transform:translateY(-1px)}
.dpbot-start-btn.stop{background:#f05252;box-shadow:0 0 14px rgba(240,82,82,0.2)}

/* Bot log */
.dpbot-log{overflow-y:auto;max-height:110px;padding:8px 14px;display:flex;flex-direction:column;gap:2px}
.dpbot-log-idle{font-size:10px;color:var(--txt3);text-align:center;padding:10px 0;line-height:1.6}
.dpblog{display:flex;align-items:flex-start;gap:7px;font-size:10px;padding:3px 0;
  border-bottom:1px solid rgba(255,255,255,0.04)}
.dpblog-time{color:var(--txt3);font-family:'JetBrains Mono',monospace;font-size:9px;flex-shrink:0;margin-top:1px}
.dpblog-msg{color:var(--txt2);flex:1;line-height:1.4}
.dpblog.win .dpblog-msg{color:var(--green)}.dpblog.loss .dpblog-msg{color:var(--red)}
.dpblog.info .dpblog-msg{color:var(--cyan)}.dpblog.warn .dpblog-msg{color:var(--gold)}

/* ── READABILITY BUMPS ── */
body{font-size:13px!important}
.mkt-sym,.mkt-px{font-size:11px!important}
.ind-lbl{font-size:9px!important}
.ind-v{font-size:12px!important}
.tn{font-size:10px!important}
.tfb{font-size:9px!important}
.tick-item{font-size:9px!important}
.tc-result{font-size:11px!important}
.rfp-dir{font-size:16px!important}
.rfp-conf{font-size:20px!important}
.lb-px{font-size:22px!important}
#tnav::-webkit-scrollbar{display:none}
.tf-bar::-webkit-scrollbar{display:none}
/* Deriv chart iframe */
#derivChartWrap{flex-direction:column}
#derivChartFrame{flex:1;min-height:0}
.tfb.deriv-tab{background:rgba(5,177,105,0.08);color:var(--cyan);border-color:rgba(34,211,238,0.3)}
.tfb.deriv-tab.on{background:rgba(5,177,105,0.2);color:var(--cyan);border-color:rgba(5,177,105,0.5)}

/* ── MOTIVATION PANEL CSS ── */
.motiv-rate-btn{padding:3px 7px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;
  cursor:pointer;border:1px solid var(--b0);background:transparent;color:var(--txt3);transition:all .15s}
.motiv-rate-btn:hover{color:var(--red);border-color:rgba(240,82,82,0.4)}
.motiv-rate-btn.on{background:rgba(239,68,68,0.12);color:#f05252;border-color:rgba(240,82,82,0.35)}
.motiv-card{padding:8px 10px;border-radius:7px;border:1px solid var(--b0);background:rgba(255,255,255,0.02);
  cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.motiv-card:hover{border-color:rgba(240,82,82,0.3);background:rgba(239,68,68,0.04);transform:translateX(2px)}
.motiv-card.playing{border-color:rgba(239,68,68,0.5);background:rgba(239,68,68,0.08)}
.motiv-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;background:rgba(240,82,82,0.4)}
.motiv-card.playing::before{background:#f05252;box-shadow:0 0 8px rgba(240,82,82,0.6)}
.motiv-card-num{font-family:'JetBrains Mono',monospace;font-size:7px;font-weight:700;color:rgba(239,68,68,0.5);margin-bottom:2px}
.motiv-card-preview{font-size:9px;color:var(--txt2);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.motiv-line{padding:5px 8px;border-radius:5px;font-size:9px;line-height:1.7;color:var(--txt3);cursor:pointer;
  transition:all .2s;border-left:2px solid transparent}
.motiv-line:hover{color:var(--txt2);background:rgba(255,255,255,0.02)}
.motiv-line.active{color:var(--txt);background:rgba(239,68,68,0.07);border-left-color:#f05252}
.motiv-line.spoken{color:rgba(240,82,82,0.4)}

@keyframes fdn{0%,100%{color:var(--txt)}50%{color:var(--red)}}
.fup{animation:fup .4s ease}.fdn{animation:fdn .4s ease}

/* Shared table styles */
.tbl{width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:8px}
.tbl th{padding:5px 10px;text-align:left;color:var(--txt3);font-size:7px;letter-spacing:1px;
  text-transform:uppercase;background:rgba(139,92,246,0.04);position:sticky;top:0;font-weight:500;border-bottom:1px solid var(--b0)}
.tbl td{padding:6px 10px;border-bottom:1px solid rgba(139,92,246,0.03);color:var(--txt2);vertical-align:middle}
.tbl tr:hover td{background:rgba(139,92,246,0.02)}
.badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:3px;font-size:7px;font-weight:700;letter-spacing:.3px}
.badge.won{background:rgba(5,177,105,0.1);color:var(--up);border:1px solid rgba(5,177,105,0.2)}
.badge.lost{background:rgba(240,82,82,0.1);color:var(--dn);border:1px solid rgba(240,82,82,0.2)}
.badge.open{background:rgba(255,255,255,0.06);color:var(--violet);border:1px solid rgba(255,255,255,0.14)}
.epty{text-align:center;padding:20px;color:var(--txt3);font-size:10px}

/* Shared panel header */
.sh{padding:8px 12px;font-size:9px;font-weight:700;color:var(--txt2);
  border-bottom:1px solid var(--b0);display:flex;align-items:center;gap:6px;flex-shrink:0;
  background:rgba(10,11,13,0.7)}
.sh-badge{padding:2px 7px;border-radius:4px;font-size:7px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.sh-badge.green{background:rgba(5,177,105,0.15);color:var(--green);border:1px solid rgba(16,185,129,0.25)}
.sh-badge.gold{background:rgba(247,147,26,0.15);color:var(--gold);border:1px solid rgba(245,158,11,0.25)}
.sh-badge.blue{background:rgba(34,211,238,0.12);color:var(--cyan);border:1px solid rgba(5,177,105,0.2)}
.sh-badge.violet{background:rgba(255,255,255,0.10);color:var(--violet);border:1px solid rgba(255,255,255,0.16)}
</style>
</head>
<body>
<div id="ambientBg"></div>

<!-- HEADER -->
<div id="hdr">
  <div class="logo">
    <div class="logo-sq">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Candlestick chart icon -->
        <rect x="2" y="11" width="3" height="7" rx="0.5" fill="white" opacity="0.9"/>
        <rect x="3" y="8" width="1" height="3" fill="white" opacity="0.6"/>
        <rect x="3" y="18" width="1" height="1.5" fill="white" opacity="0.6"/>
        <rect x="7.5" y="5" width="3" height="9" rx="0.5" fill="white" opacity="0.9"/>
        <rect x="9" y="2" width="1" height="3" fill="white" opacity="0.6"/>
        <rect x="9" y="14" width="1" height="2" fill="white" opacity="0.6"/>
        <rect x="13" y="8" width="3" height="6" rx="0.5" fill="white" opacity="0.9"/>
        <rect x="14.5" y="5" width="1" height="3" fill="white" opacity="0.6"/>
        <rect x="14.5" y="14" width="1" height="2" fill="white" opacity="0.6"/>
        <!-- Rising trend line -->
        <polyline points="2,16 9,9 14.5,11 19,4" stroke="rgba(34,211,238,0.9)" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="logo-name">RerrMyTrades<span>Volatility Engine</span></div>
  </div>
  <div class="hdr-center">
    <div class="stat-pill"><div class="ws-dot" id="wsDot"></div><span class="sp-l">WS</span><span class="sp-v" id="wsStatus">CONN...</span></div>
    <div class="stat-pill"><span class="sp-l">MKT</span><span class="sp-v c" id="hSym">R_100</span></div>
    <div class="stat-pill"><span class="sp-l">PRICE</span><span class="sp-v" id="hPx">—</span></div>
    <div class="stat-pill"><span class="sp-l">DAY</span><span class="sp-v" id="hChg">—</span></div>
    <div class="stat-pill" id="balStat" style="display:none"><span class="sp-l">BAL</span><span class="sp-v g" id="hBal">—</span></div>
  </div>
  <div class="hdr-r">
    <div class="bal-chip" id="balChip">$0.00</div>
    <button class="btn-api" id="btnApi" onclick="openModal()" title="Connect your Deriv account via OAuth">🔑 CONNECT</button>
    <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme" id="themeBtn"><span id="themeIco">🌙</span></button>
  </div>
</div>

<!-- TOP NAV -->
<div id="tnav">
  <button class="tn act" id="tn-col-chart" onclick="goCol('col-chart')"><span class="tn-ico">📈</span>Chart</button>
  <button class="tn" id="tn-col-digit" onclick="goCol('col-digit')"><span class="tn-ico">🎯</span>Digits<span class="tn-badge">ANALYSIS</span></button>
  <button class="tn" id="tn-col-rf" onclick="goCol('col-rf')"><span class="tn-ico">⚡</span>Rise/Fall</button>
  <button class="tn" id="tn-col-ldp" onclick="goCol('col-ldp')"><span class="tn-ico">🔬</span>LDP Tool</button>
  <button class="tn" id="tn-col-dtrader" onclick="goCol('col-dtrader')"><span class="tn-ico">🏦</span>DTrader</button>
  <button class="tn" id="tn-col-dbot" onclick="goCol('col-dbot')"><span class="tn-ico">🤖</span>DBot</button>
  <button class="tn" id="tn-col-journal" onclick="goCol('col-journal')"><span class="tn-ico">📂</span>Journal</button>
  <button class="tn" id="tn-col-motivation" onclick="goCol('col-motivation')"><span class="tn-ico">🔥</span>Mindset</button>
  <button class="tn" id="tn-col-trade" onclick="goCol('col-trade')"><span class="tn-ico">💰</span>Trade</button>
</div>

<!-- TICKER -->
<div id="ticker"><div class="tick-track" id="tickTrack"></div></div>

<!-- PAGE -->
<div id="page">
  <!-- AUTOMATED TICK COUNTER — replaces chart on home screen -->
  <div id="col-chart">

    <!-- ── TOP BAR: symbol + live price ── -->
    <div class="atc-topbar">
      <div class="atc-sym-group">
        <div class="chart-live-dot" id="chartLiveDot"></div>
        <span class="atc-sym" id="cSym">R_100</span>
        <span class="atc-symname" id="cDesc">Volatility 100 Index</span>
      </div>
      <div class="atc-price-group">
        <span class="atc-live-px" id="cPx">—</span>
        <span class="atc-live-chg" id="cChg"></span>
      </div>
    </div>

    <!-- ── HERO PRICE + PULSE RING ── -->
    <div class="atc-hero">
      <div class="atc-hero-inner">
        <div class="atc-pulse-ring" id="atcPulseRing"></div>
        <div class="atc-hero-px" id="atcHeroPx">—</div>
        <div class="atc-hero-dir" id="atcHeroDir">WAITING</div>
      </div>
      <div class="atc-session-row">
        <div class="atc-sess-card">
          <div class="atc-sess-val g" id="atcSessUp">0</div>
          <div class="atc-sess-lbl">UP</div>
        </div>
        <div class="atc-sess-card">
          <div class="atc-sess-val r" id="atcSessDn">0</div>
          <div class="atc-sess-lbl">DOWN</div>
        </div>
        <div class="atc-sess-card">
          <div class="atc-sess-val" id="atcSessStreak">—</div>
          <div class="atc-sess-lbl">STREAK</div>
        </div>
        <div class="atc-sess-card">
          <div class="atc-sess-val" id="atcSessRounds">0</div>
          <div class="atc-sess-lbl">ROUNDS</div>
        </div>
      </div>
    </div>

    <!-- ── CONTROLS ── -->
    <div class="atc-controls">
      <div class="atc-ctrl-group">
        <span class="atc-ctrl-lbl">TICKS PER ROUND</span>
        <div class="atc-size-btns">
          <button class="atc-sz" onclick="atcSetSize(5)">5</button>
          <button class="atc-sz" onclick="atcSetSize(10)">10</button>
          <button class="atc-sz on" onclick="atcSetSize(15)">15</button>
          <button class="atc-sz" onclick="atcSetSize(20)">20</button>
          <button class="atc-sz" onclick="atcSetSize(25)">25</button>
        </div>
      </div>
      <div class="atc-ctrl-group" style="align-items:flex-end">
        <span class="atc-ctrl-lbl">AUTO MODE</span>
        <div style="display:flex;gap:6px">
          <button class="atc-toggle-btn on" id="atcToggleBtn" onclick="atcToggle()">⏸ RUNNING</button>
          <button class="atc-rst-btn" onclick="atcReset()" title="Reset session">↺</button>
        </div>
      </div>
    </div>

    <!-- ── ROUND PROGRESS ── -->
    <div class="atc-round-bar">
      <div class="atc-round-meta">
        <span class="atc-rmeta-item">ROUND <strong id="atcRoundNum">1</strong></span>
        <span class="atc-rmeta-item" id="atcRoundStatus">WAITING FOR TICKS...</span>
        <span class="atc-rmeta-item"><strong id="atcCountedNum">0</strong> / <strong id="atcTargetNum">15</strong></span>
      </div>
      <div class="atc-progress-track">
        <div class="atc-progress-fill" id="atcProgressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- ── TICK DOTS ── -->
    <div class="atc-dots-area" id="atcDotsArea"></div>

    <!-- ── RESULT FLASH ── -->
    <div class="atc-result-flash" id="atcResultFlash" style="display:none">
      <div class="atc-rf-dir" id="atcRfDir">—</div>
      <div class="atc-rf-stats" id="atcRfStats">—</div>
      <div class="atc-rf-next">Next round in <span id="atcRfCountdown">3</span>s</div>
    </div>

    <!-- ── BIAS BAR ── -->
    <div class="atc-bias-section">
      <div class="atc-bias-hdr">
        <span class="atc-bias-lbl g" id="atcBiasPctG">50%</span>
        <span class="atc-bias-title">SESSION BIAS</span>
        <span class="atc-bias-lbl r" id="atcBiasPctR">50%</span>
      </div>
      <div class="atc-bias-track">
        <div class="atc-bias-g" id="atcBiasG" style="width:50%"></div>
        <div class="atc-bias-r" id="atcBiasR" style="width:50%"></div>
      </div>
    </div>

    <!-- ── ROUND HISTORY ── -->
    <div class="atc-history">
      <div class="atc-hist-hdr">ROUND HISTORY</div>
      <div class="atc-hist-scroll" id="atcHistScroll"></div>
    </div>

    <!-- ══════════════════════════════════════════
         TICK COUNTER AUTO BOT
    ══════════════════════════════════════════ -->
    <div class="atcbot-wrap" id="atcBot">

      <!-- Header with toggle -->
      <div class="atcbot-hdr">
        <div class="atcbot-hdr-left">
          <div class="atcbot-status-dot" id="atcBotDot"></div>
          <span class="atcbot-title">AUTO BOT</span>
          <span class="atcbot-badge" id="atcBotBadge">IDLE</span>
        </div>
        <div class="atcbot-hdr-right">
          <span class="atcbot-pnl" id="atcBotPnl">$0.00</span>
          <button class="atcbot-main-btn" id="atcBotMainBtn" onclick="atcBotToggle()">▶ START</button>
        </div>
      </div>

      <!-- Settings grid -->
      <div class="atcbot-settings" id="atcBotSettings">

        <!-- Row 1: Stake + Martingale -->
        <div class="atcbot-row">
          <div class="atcbot-field">
            <label class="atcbot-lbl">STAKE ($)</label>
            <input class="atcbot-inp" type="number" id="abStake" value="1" min="0.35" step="0.5">
          </div>
          <div class="atcbot-field">
            <label class="atcbot-lbl">MARTINGALE ×</label>
            <input class="atcbot-inp" type="number" id="abMart" value="2" min="1" step="0.1">
          </div>
          <div class="atcbot-field">
            <label class="atcbot-lbl">DURATION (t)</label>
            <input class="atcbot-inp" type="number" id="abDur" value="5" min="1" max="10" step="1">
          </div>
        </div>

        <!-- Row 2: Stop Loss + Take Profit + Runs -->
        <div class="atcbot-row">
          <div class="atcbot-field">
            <label class="atcbot-lbl">STOP LOSS ($)</label>
            <input class="atcbot-inp" type="number" id="abSL" value="10" min="0" step="1">
          </div>
          <div class="atcbot-field">
            <label class="atcbot-lbl">TAKE PROFIT ($)</label>
            <input class="atcbot-inp" type="number" id="abTP" value="20" min="0" step="1">
          </div>
          <div class="atcbot-field">
            <label class="atcbot-lbl">MAX RUNS</label>
            <input class="atcbot-inp" type="number" id="abRuns" value="10" min="1" step="1">
          </div>
        </div>

        <!-- Row 3: Direction mode -->
        <div class="atcbot-row" style="gap:6px">
          <span class="atcbot-lbl" style="align-self:center">TRADE DIRECTION:</span>
          <button class="atcbot-dir-btn on" id="abDirWith" onclick="abSetDir('with')">↗ WITH SIGNAL</button>
          <button class="atcbot-dir-btn" id="abDirAgainst" onclick="abSetDir('against')">↙ AGAINST SIGNAL</button>
        </div>

      </div>

      <!-- Bot log -->
      <div class="atcbot-log" id="atcBotLog">
        <div class="atcbot-log-idle">Configure settings above and press START to begin auto-trading on tick counter signals.</div>
      </div>

    </div>

  </div>

  <!-- DIGIT ANALYSIS PANEL -->
  <div id="col-digit">
    <div class="sh">🎯 Digit Analysis <span class="sh-badge gold" id="mktBadge">R_100</span></div>

    <!-- Last digits stream -->
    <div class="streak-sect">
      <div class="streak-title">LAST DIGITS STREAM</div>
      <div class="last-digits" id="lastDigits"></div>
    </div>

    <!-- Digit frequency heatmap -->
    <div class="dhmap" id="digitHmap"></div>

    <!-- Next digit prediction -->
    <div class="pred-sect">
      <div class="pred-title">NEXT DIGIT PREDICTION PROBABILITY</div>
      <div class="pred-grid" id="predGrid"></div>
      <div style="display:flex;gap:8px;margin-top:6px;font-size:8px;color:var(--txt3)">
        <span style="color:var(--green)">■</span> High probability
        <span style="color:var(--red)">■</span> Low probability
        <span style="margin-left:auto;font-family:'JetBrains Mono',monospace" id="predUpdated">Based on 100 ticks</span>
      </div>
    </div>

    <!-- ══ ADVANCED DIGIT PATTERN BOT ══ -->
    <div class="dpbot-wrap">

      <!-- Live signal display -->
      <div class="dpbot-signal-row">
        <div class="dpbot-signal-card" id="dpbotSignalCard">
          <div class="dpbot-sig-label">PATTERN SIGNAL</div>
          <div class="dpbot-sig-dir" id="dpbotSigDir">SCANNING...</div>
          <div class="dpbot-sig-detail" id="dpbotSigDetail">Waiting for digit data</div>
        </div>
        <div class="dpbot-window-card">
          <div class="dpbot-sig-label">PATTERN WINDOW</div>
          <div class="dpbot-win-btns">
            <button class="dpbot-wb" onclick="dpbotSetWindow(2)">2</button>
            <button class="dpbot-wb on" onclick="dpbotSetWindow(3)">3</button>
            <button class="dpbot-wb" onclick="dpbotSetWindow(4)">4</button>
            <button class="dpbot-wb" onclick="dpbotSetWindow(5)">5</button>
          </div>
          <div class="dpbot-sig-label" style="margin-top:4px">BARRIER</div>
          <div class="dpbot-win-btns">
            <button class="dpbot-wb" onclick="dpbotSetBarrier(2)">2</button>
            <button class="dpbot-wb on" onclick="dpbotSetBarrier(5)">5</button>
            <button class="dpbot-wb" onclick="dpbotSetBarrier(7)">7</button>
          </div>
        </div>
      </div>

      <!-- Pattern history visualiser -->
      <div class="dpbot-pattern-vis">
        <div class="dpbot-pv-label">LAST <span id="dpbotWinLabel">3</span> DIGITS</div>
        <div class="dpbot-pv-digits" id="dpbotPvDigits"></div>
        <div class="dpbot-pv-arrow" id="dpbotPvArrow">→</div>
        <div class="dpbot-pv-next" id="dpbotPvNext">?</div>
      </div>

      <!-- Bot controls -->
      <div class="dpbot-controls">
        <div class="dpbot-ctrl-row">
          <div class="dpbot-field">
            <label class="dpbot-lbl">STAKE ($)</label>
            <input class="dpbot-inp" type="number" id="dpbStake" value="1" min="0.35" step="0.5">
          </div>
          <div class="dpbot-field">
            <label class="dpbot-lbl">MARTINGALE ×</label>
            <input class="dpbot-inp" type="number" id="dpbMart" value="2" min="1" step="0.1">
          </div>
          <div class="dpbot-field">
            <label class="dpbot-lbl">DURATION (t)</label>
            <input class="dpbot-inp" type="number" id="dpbDur" value="5" min="1" max="10">
          </div>
        </div>
        <div class="dpbot-ctrl-row">
          <div class="dpbot-field">
            <label class="dpbot-lbl">STOP LOSS ($)</label>
            <input class="dpbot-inp" type="number" id="dpbSL" value="10" min="0" step="1">
          </div>
          <div class="dpbot-field">
            <label class="dpbot-lbl">TAKE PROFIT ($)</label>
            <input class="dpbot-inp" type="number" id="dpbTP" value="20" min="0" step="1">
          </div>
          <div class="dpbot-field">
            <label class="dpbot-lbl">MAX RUNS</label>
            <input class="dpbot-inp" type="number" id="dpbRuns" value="20" min="1" step="1">
          </div>
        </div>
        <div class="dpbot-ctrl-row" style="gap:8px;justify-content:space-between;align-items:center">
          <div style="display:flex;align-items:center;gap:6px">
            <span class="dpbot-lbl">MIN CONFIDENCE</span>
            <select class="dpbot-inp" id="dpbMinConf" style="width:70px">
              <option value="60">60%</option>
              <option value="65">65%</option>
              <option value="70" selected>70%</option>
              <option value="75">75%</option>
              <option value="80">80%</option>
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="dpbot-pnl" id="dpbotPnl">$0.00</span>
            <button class="dpbot-start-btn" id="dpbotStartBtn" onclick="dpbotToggle()">▶ START BOT</button>
          </div>
        </div>
      </div>

      <!-- Bot log -->
      <div class="dpbot-log" id="dpbotLog">
        <div class="dpbot-log-idle">Set your parameters and press START BOT. The bot trades automatically when pattern confidence meets your threshold.</div>
      </div>

    </div>
  </div>

  <!-- RISE/FALL PANEL -->
  <div id="col-rf">
    <div class="sh">⚡ Rise / Fall Engine <span class="sh-badge green">LIVE</span></div>

    <!-- Tick counter -->
    <div class="tick-counter">
      <div class="tc-hdr">
        <div class="tc-title">TICK COUNTER — PREDICT RISE / FALL</div>
        <div class="tc-controls">
          <span style="font-size:8px;color:var(--txt3)">Ticks:</span>
          <input class="tc-num-input" type="number" id="tcCount" value="5" min="1" max="50">
          <button class="tc-btn" id="tcBtn" onclick="startTickCounter()">▶ START</button>
        </div>
      </div>
      <div class="tick-dots" id="tickDots"></div>
      <div class="tc-result" id="tcResult"></div>
    </div>

    <!-- Rise/Fall Prediction -->
    <div class="rf-pred">
      <div class="pred-title" style="font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);padding:0;margin-bottom:8px">AI RISE / FALL PREDICTION</div>
      <div class="rf-pred-box neut" id="rfPredBox">
        <div>
          <div class="rfp-dir neut" id="rfPredDir">ANALYSING...</div>
          <div class="rfp-reason" id="rfPredReason">Gathering market data...</div>
        </div>
        <div>
          <div class="rfp-conf" id="rfPredConf" style="color:var(--violet)">—</div>
          <div style="font-size:7px;color:var(--txt3);text-align:right;margin-top:2px">confidence</div>
        </div>
      </div>
    </div>

    <!-- Candlestick Pattern Analysis -->
    <div class="cs-analysis">
      <div class="cs-title">CANDLESTICK PATTERN ANALYSIS</div>
      <div class="pattern-list" id="patternList"></div>
    </div>

    <!-- Multi-signal consensus -->
    <div style="padding:10px 12px;border-bottom:1px solid var(--b0);flex-shrink:0">
      <div class="pred-title" style="font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px">MULTI-INDICATOR CONSENSUS</div>
      <div id="rfConsensus" style="display:flex;flex-direction:column;gap:4px"></div>
    </div>
  </div>

  <!-- LDP TOOL -->
  <div id="col-ldp">
    <div class="ldp-hdr">
      <div style="font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:6px">⚙️ LDP (Last Digit Probability) Tool — Advanced</div>
      <div class="ldp-controls">
        <select class="ldp-sel" id="ldpMarket">
          <option value="all">All Volatility Indices</option>
          <option value="R_10">Volatility 10</option>
          <option value="R_25">Volatility 25</option>
          <option value="R_50">Volatility 50</option>
          <option value="R_75">Volatility 75</option>
          <option value="R_100">Volatility 100</option>
          <option value="1HZ10V">Vol 10 (1s)</option>
          <option value="1HZ25V">Vol 25 (1s)</option>
          <option value="1HZ50V">Vol 50 (1s)</option>
          <option value="1HZ75V">Vol 75 (1s)</option>
          <option value="1HZ100V">Vol 100 (1s)</option>
        </select>
        <select class="ldp-sel" id="ldpContract">
          <option value="over_under">Over / Under</option>
          <option value="even_odd">Even / Odd</option>
          <option value="matches_differs">Matches / Differs</option>
        </select>
        <select class="ldp-sel" id="ldpSamples">
          <option value="50">50 ticks</option>
          <option value="100" selected>100 ticks</option>
          <option value="200">200 ticks</option>
          <option value="500">500 ticks</option>
        </select>
        <button class="ldp-run-btn" id="ldpRunBtn" onclick="runLDP()">▶ SCAN</button>
      </div>
    </div>
    <div class="ldp-body" id="ldpBody">
      <div class="ldp-idle">
        <div class="ldp-idle-icon">🔬</div>
        <div class="ldp-idle-title">LDP SCANNER READY</div>
        <div class="ldp-idle-sub">Select market & contract type,<br>then click <strong style="color:var(--violet)">▶ SCAN</strong> to analyse<br>last-digit probability patterns</div>
      </div>
    </div>
    <div class="ldp-log">
      <div class="ldp-log-title">Scan Log</div>
      <div class="ldp-log-entries" id="ldpLog"></div>
    </div>
  </div>

  <!-- DTRADER INTEGRATED -->
  <div id="col-dtrader">
    <div class="dint-hdr">
      <span class="dint-title">DTrader — Integrated</span>
      <span class="dint-badge dt">INTERNAL</span>
      <span style="font-size:8px;color:var(--txt3)">No login required</span>
    </div>
    <div class="dint-body">
      <div class="dtrader-form">
        <!-- Market row -->
        <div class="dtrader-mkt-row">
          <div>
            <div class="dtm-sym" id="dtSym">R_100</div>
            <div style="font-size:8px;color:rgba(5,177,105,0.5);margin-top:2px">Volatility 100 Index</div>
          </div>
          <div style="text-align:right">
            <div class="dtm-px" id="dtPx">—</div>
            <div class="dtm-chg" id="dtChg"></div>
          </div>
        </div>

        <!-- Trade type -->
        <div>
          <div class="dts-lbl" style="margin-bottom:6px">TRADE TYPE</div>
          <div class="dtrader-trade-types">
            <div class="dtt-card sel" onclick="dtSelType('rise_fall',this)"><div class="dtt-icon">📈</div><div class="dtt-name">Rise / Fall</div></div>
            <div class="dtt-card" onclick="dtSelType('over_under',this)"><div class="dtt-icon">🎯</div><div class="dtt-name">Over / Under</div></div>
            <div class="dtt-card" onclick="dtSelType('even_odd',this)"><div class="dtt-icon">⚖️</div><div class="dtt-name">Even / Odd</div></div>
            <div class="dtt-card" onclick="dtSelType('matches_differs',this)"><div class="dtt-icon">🔢</div><div class="dtt-name">Matches / Differs</div></div>
          </div>
        </div>

        <!-- Digit selector (for digit contracts) -->
        <div id="dtDigitSel" style="display:none">
          <div class="dts-lbl" style="margin-bottom:6px">SELECT DIGIT</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px" id="dtDigitBtns"></div>
        </div>

        <!-- Stake -->
        <div class="dtrader-stake">
          <div class="dts-lbl">STAKE (USD)</div>
          <div class="dts-row">
            <input class="dts-input" type="number" id="dtStake" value="10" min="0.35">
          </div>
          <div class="dts-presets">
            <button class="dts-ps" onclick="$('dtStake').value=1">$1</button>
            <button class="dts-ps" onclick="$('dtStake').value=5">$5</button>
            <button class="dts-ps" onclick="$('dtStake').value=10">$10</button>
            <button class="dts-ps" onclick="$('dtStake').value=25">$25</button>
            <button class="dts-ps" onclick="$('dtStake').value=50">$50</button>
            <button class="dts-ps" onclick="$('dtStake').value=100">$100</button>
          </div>
        </div>

        <!-- Duration -->
        <div class="dtrader-duration">
          <div class="dts-lbl">DURATION</div>
          <div class="dts-dur-row">
            <button class="dur-btn on" onclick="dtSelDur(1,this)">1 Tick</button>
            <button class="dur-btn" onclick="dtSelDur(3,this)">3 Ticks</button>
            <button class="dur-btn" onclick="dtSelDur(5,this)">5 Ticks</button>
            <button class="dur-btn" onclick="dtSelDur(10,this)">10 Ticks</button>
          </div>
        </div>

        <!-- Payout display -->
        <div class="dtrader-payout">
          <div><div class="dtp-l">Est. Payout</div><div class="dtp-v" id="dtPayout">$0.00</div></div>
          <div style="text-align:right"><div class="dtp-l">Profit %</div><div class="dtp-p" id="dtProfit">0%</div></div>
        </div>

        <!-- Execute -->
        <div class="dtrader-exec" id="dtExecBtns">
          <button class="dt-exec-rise" onclick="dtTrade('rise')">▲ RISE</button>
          <button class="dt-exec-fall" onclick="dtTrade('fall')">▼ FALL</button>
        </div>

        <!-- Stats -->
        <div class="sg" style="border:1px solid var(--b0);border-radius:8px;overflow:hidden">
          <div class="st"><div class="sl">Session P&L</div><div class="sv g" id="dtPnl">$0.00</div></div>
          <div class="st"><div class="sl">Win Rate</div><div class="sv c" id="dtWr">—</div></div>
          <div class="st"><div class="sl">Trades</div><div class="sv" id="dtTrades">0</div></div>
          <div class="st"><div class="sl">Wins</div><div class="sv g" id="dtWins">0</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DBOT INTEGRATED -->
  <div id="col-dbot">
    <div class="dint-hdr">
      <span class="dint-title">DBot — Integrated</span>
      <span class="dint-badge db">INTERNAL</span>
      <span style="font-size:8px;color:var(--txt3)">No login required</span>
    </div>
    <div class="dint-body">
      <div class="dbot-form">
        <!-- Status -->
        <div class="dbot-status">
          <div class="dbs-row">
            <span class="dbs-name" id="dbBotName">Digit Master Bot</span>
            <span class="dbs-pill"><span class="db-dot stop" id="dbDot"></span><span id="dbStatus">STOPPED</span></span>
          </div>
          <div class="dbs-stats">
            <div class="dbss"><div class="dbss-l">Trades</div><div class="dbss-v" id="dbTrades">0</div></div>
            <div class="dbss"><div class="dbss-l">Wins</div><div class="dbss-v" id="dbWins">0</div></div>
            <div class="dbss"><div class="dbss-l">P&L</div><div class="dbss-v" id="dbPnl">$0</div></div>
            <div class="dbss"><div class="dbss-l">Win%</div><div class="dbss-v" id="dbWr">—</div></div>
          </div>
        </div>

        <!-- Market select -->
        <div>
          <div class="dts-lbl" style="margin-bottom:6px">TARGET MARKET</div>
          <select class="dbs-sel" id="dbMarket" style="width:100%;padding:8px 10px;border-radius:7px;font-size:10px">
            <option value="R_100">Volatility 100 Index</option>
            <option value="R_75">Volatility 75 Index</option>
            <option value="R_50">Volatility 50 Index</option>
            <option value="R_25">Volatility 25 Index</option>
            <option value="R_10">Volatility 10 Index</option>
            <option value="1HZ100V">Volatility 100 (1s) Index</option>
            <option value="1HZ75V">Volatility 75 (1s) Index</option>
            <option value="1HZ50V">Volatility 50 (1s) Index</option>
            <option value="1HZ25V">Volatility 25 (1s) Index</option>
            <option value="1HZ10V">Volatility 10 (1s) Index</option>
          </select>
        </div>

        <!-- Strategy builder -->
        <div class="dbot-strategy">
          <div class="dbs-title">⚙️ Strategy Builder</div>
          <div class="dbs-rule"><span class="dbs-op">CT</span>
            <select class="dbs-sel" id="dbContractType">
              <option>Over / Under (Last Digit)</option>
              <option>Even / Odd (Last Digit)</option>
              <option>Matches / Differs</option>
              <option>Rise / Fall</option>
            </select>
          </div>
          <div class="dbs-rule"><span class="dbs-op">IF</span>
            <select class="dbs-sel" id="dbCond1">
              <option>Digit Over-Bias (&gt;50%)</option>
              <option>Digit Under-Bias (&gt;50%)</option>
              <option>Even Digit Streak</option>
              <option>Odd Digit Streak</option>
              <option>RSI Oversold &lt; 30</option>
              <option>RSI Overbought &gt; 70</option>
              <option>EMA Cross Up</option>
              <option>EMA Cross Down</option>
              <option>Volatility Spike</option>
            </select>
          </div>
          <div class="dbs-rule"><span class="dbs-op">AND</span>
            <select class="dbs-sel" id="dbCond2">
              <option>Momentum Bullish</option>
              <option>Momentum Bearish</option>
              <option>ATR Normal</option>
              <option>ATR High</option>
              <option>MACD Bullish</option>
              <option>MACD Bearish</option>
            </select>
          </div>
          <div class="dbs-title" style="margin-top:10px">💰 Money Management</div>
          <div class="mm-row"><div class="mm-lbl">Stake Method</div>
            <select class="mm-inp" id="dbMmType"><option>Fixed</option><option>% of Balance</option><option>Anti-Martingale</option><option>Controlled Martingale</option></select>
          </div>
          <div class="mm-row"><div class="mm-lbl">Base Stake ($)</div><input class="mm-inp" type="number" id="dbStake" value="10"></div>
          <div class="mm-row"><div class="mm-lbl">Daily Loss Limit</div><input class="mm-inp" type="number" id="dbLossLimit" value="50"></div>
          <div class="mm-row"><div class="mm-lbl">Consec. Loss Stop</div><input class="mm-inp" type="number" id="dbConsec" value="5"></div>
        </div>

        <!-- Execute -->
        <div class="dbot-exec">
          <button class="db-start" id="dbStartBtn" onclick="toggleDBot()">▶ START BOT</button>
          <button class="db-kill" onclick="emergencyStopDBot()">🔴 EMERGENCY STOP</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JOURNAL -->
  <div id="col-journal">
    <div class="sh">📂 Trade Journal <span class="sh-badge gold">SESSION</span></div>
    <div class="analytics-grid">
      <div class="an-card"><div class="an-title">Total P&L</div><div class="an-val g" id="jPnl">$0.00</div><div class="an-sub">All trades</div></div>
      <div class="an-card"><div class="an-title">Win Rate</div><div class="an-val c" id="jWr">—</div><div class="an-sub" id="jWrSub">0/0 trades</div></div>
      <div class="an-card"><div class="an-title">Profit Factor</div><div class="an-val gold" id="jPf">—</div><div class="an-sub">Wins/Losses</div></div>
      <div class="an-card"><div class="an-title">Max Drawdown</div><div class="an-val r" id="jDd">0%</div><div class="an-sub">Worst streak</div></div>
      <div class="an-card"><div class="an-title">Best Market</div><div class="an-val c" id="jBest">—</div><div class="an-sub">By P&L</div></div>
      <div class="an-card"><div class="an-title">Total Trades</div><div class="an-val" id="jTotal">0</div><div class="an-sub">Completed</div></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:8px 12px">
      <div style="font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);margin-bottom:8px">TRADE HISTORY</div>
      <div style="overflow-x:auto">
        <table class="tbl" style="min-width:420px">
          <thead><tr><th>ID</th><th>MKT</th><th>TYPE</th><th>STAKE</th><th>P&L</th><th>STATUS</th><th>TIME</th></tr></thead>
          <tbody id="journalTbl"></tbody>
        </table>
      </div>
    </div>
    <div style="padding:8px 12px;border-top:1px solid var(--b0);flex-shrink:0">
      <button onclick="exportCSV()" style="width:100%;padding:8px;border-radius:6px;font-size:9px;font-weight:700;cursor:pointer;border:1px solid var(--b0);background:rgba(255,255,255,0.04);color:var(--violet);letter-spacing:.5px;text-transform:uppercase">⬇ Export CSV</button>
    </div>
  </div>

  <!-- TRADE PANEL -->
  <div id="col-trade">
    <div class="live-band">
      <div>
        <div class="lb-mkt" id="tradeMkt">R_100</div>
        <div class="lb-sub">Volatility 100 Index</div>
      </div>
      <div class="lb-px" id="tradePx">—</div>
    </div>

    <!-- Contract type -->
    <div class="ct-sect">
      <div class="ct-lbl">CONTRACT TYPE</div>
      <div class="ct-btns">
        <button class="ctb-pill on rf" onclick="setContract('rise_fall',this)">📈 Rise/Fall</button>
        <button class="ctb-pill dg" onclick="setContract('over_under',this)">🎯 Over/Under</button>
        <button class="ctb-pill dg" onclick="setContract('even_odd',this)">⚖️ Even/Odd</button>
        <button class="ctb-pill dg" onclick="setContract('matches_differs',this)">🔢 Matches/Differs</button>
      </div>
    </div>

    <!-- Digit selector (shown for digit contracts) -->
    <div class="digit-sect" id="digitSect" style="display:none">
      <div class="ct-lbl" id="digitSectLbl">SELECT DIGIT (Over/Under)</div>
      <div class="digit-grid" id="digitGrid"></div>
      <div style="margin-top:6px;font-size:8px;color:var(--txt3);text-align:center" id="digitInfo">Select a digit to bet on</div>
    </div>

    <!-- Form -->
    <div class="fg">
      <div class="fl">STAKE (USD)</div>
      <div class="iw">
        <input class="fi" type="number" id="stakeV" value="10" min="0.35" oninput="calcPay()">
      </div>
      <div class="psets">
        <button class="ps" onclick="setStk(1)">$1</button>
        <button class="ps" onclick="setStk(5)">$5</button>
        <button class="ps" onclick="setStk(10)">$10</button>
        <button class="ps" onclick="setStk(25)">$25</button>
        <button class="ps" onclick="setStk(50)">$50</button>
      </div>
      <div class="fl" style="margin-top:4px">DURATION</div>
      <div class="dr">
        <input class="fi" type="number" id="durV" value="5" min="1" max="365" oninput="calcPay()">
        <select class="fs" id="durUnit">
          <option value="t">Ticks</option>
          <option value="s">Seconds</option>
          <option value="m">Minutes</option>
        </select>
      </div>
    </div>

    <!-- Payout -->
    <div class="poc">
      <div><div class="poc-l">Est. Payout</div><div class="poc-v" id="payV">$0.00</div></div>
      <div style="text-align:right"><div class="poc-l">Profit %</div><div class="poc-p" id="profitPct">0%</div></div>
    </div>

    <!-- Direction / execute -->
    <div id="rfExec">
      <div class="dir-btns">
        <button class="dir-btn up sel" id="tabBuy" onclick="selDir('buy',this)">▲ RISE</button>
        <button class="dir-btn dn" id="tabSell" onclick="selDir('sell',this)">▼ FALL</button>
      </div>
      <button class="exec-btn buy" style="width:calc(100% - 20px)" id="execBtn" onclick="doTrade()">⚡ EXECUTE TRADE</button>
    </div>

    <!-- For Even/Odd contracts -->
    <div id="eoExec" style="display:none;padding:0 10px 8px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <button class="exec-btn even" onclick="doDigitTrade('even')">EVEN</button>
        <button class="exec-btn odd" onclick="doDigitTrade('odd')">ODD</button>
      </div>
    </div>

    <!-- For Matches/Differs -->
    <div id="mdExec" style="display:none;padding:0 10px 8px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <button class="exec-btn buy" onclick="doDigitTrade('matches')">🎯 MATCHES</button>
        <button class="exec-btn sell" onclick="doDigitTrade('differs')">✗ DIFFERS</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="sg">
      <div class="st"><div class="sl">P&L</div><div class="sv g" id="pnlV">$0.00</div></div>
      <div class="st"><div class="sl">Win Rate</div><div class="sv c" id="wrV">—</div></div>
      <div class="st"><div class="sl">Trades</div><div class="sv" id="cntV">0</div></div>
      <div class="st"><div class="sl">Streak</div><div class="sv" id="streakV">—</div></div>
    </div>
  </div>
  <!-- ═══════════════════════════════════════════════
       MOTIVATION / MINDSET PANEL
  ═══════════════════════════════════════════════ -->
  <div id="col-motivation" style="flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;overflow:hidden">

    <!-- Panel header -->
    <div class="sh" style="background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(247,147,26,0.06));border-bottom:1px solid rgba(240,82,82,0.2)">
      🔥 Trader Mindset
      <span class="sh-badge" style="background:rgba(240,82,82,0.15);color:#f05252;border:1px solid rgba(240,82,82,0.3)">AUDIO</span>
      <span style="margin-left:auto;font-size:7px;color:var(--txt3);letter-spacing:1px">DEEP VOICE · TTS</span>
    </div>

    <!-- Scrollable content -->
    <div style="flex:1;overflow-y:auto;display:flex;flex-direction:column">

      <!-- Waveform visualizer + main controls -->
      <div id="motiv-hero" style="padding:16px 14px;border-bottom:1px solid var(--b0);background:linear-gradient(180deg,rgba(240,82,82,0.06),transparent);flex-shrink:0">

        <!-- Waveform canvas -->
        <canvas id="motivWave" height="60" style="width:100%;border-radius:8px;background:rgba(0,0,0,0.3);display:block;margin-bottom:12px"></canvas>

        <!-- Now playing -->
        <div style="margin-bottom:10px">
          <div style="font-size:7px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(240,82,82,0.6);margin-bottom:4px">NOW SPEAKING</div>
          <div id="motivNowPlaying" style="font-family:'Inter',sans-serif;font-size:11px;font-weight:700;color:var(--txt);line-height:1.5;min-height:32px;transition:all .3s">
            Press PLAY to hear the voice of discipline...
          </div>
        </div>

        <!-- Progress bar -->
        <div style="height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;margin-bottom:10px;cursor:pointer" onclick="motivSeek(event,this)">
          <div id="motivProgress" style="height:100%;width:0%;background:linear-gradient(90deg,#f05252,#f7931a);border-radius:2px;transition:width .3s"></div>
        </div>

        <!-- Time + rate -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <span id="motivTime" style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txt3)">0:00 / 0:00</span>
          <div style="display:flex;align-items:center;gap:4px">
            <span style="font-size:7px;color:var(--txt3);letter-spacing:1px">SPEED</span>
            <button class="motiv-rate-btn on" data-rate="0.75" onclick="motivSetRate(0.75,this)">0.75×</button>
            <button class="motiv-rate-btn on" data-rate="0.85" onclick="motivSetRate(0.85,this)">0.85×</button>
            <button class="motiv-rate-btn" data-rate="1" onclick="motivSetRate(1,this)">1×</button>
            <button class="motiv-rate-btn" data-rate="1.2" onclick="motivSetRate(1.2,this)">1.2×</button>
          </div>
        </div>

        <!-- Main controls -->
        <div style="display:flex;gap:6px;align-items:center">
          <button id="motivPlayBtn" onclick="motivToggle()" style="flex:1;padding:11px;border-radius:8px;font-weight:800;font-size:13px;cursor:pointer;border:none;
            background:#f05252;color:#fff;
            box-shadow:0 4px 20px rgba(240,82,82,0.4);transition:all .2s;letter-spacing:.5px">
            ▶ PLAY
          </button>
          <button onclick="motivStop()" style="padding:11px 14px;border-radius:8px;font-size:11px;cursor:pointer;
            border:1px solid rgba(240,82,82,0.3);background:rgba(240,82,82,0.06);color:#f05252;font-weight:700;transition:all .2s">
            ■ STOP
          </button>
          <button onclick="motivRestart()" style="padding:11px 14px;border-radius:8px;font-size:11px;cursor:pointer;
            border:1px solid var(--b0);background:rgba(255,255,255,0.03);color:var(--txt3);font-weight:700;transition:all .2s">
            ↺
          </button>
        </div>

        <!-- Voice selector -->
        <div style="margin-top:10px;display:flex;align-items:center;gap:6px">
          <span style="font-size:7px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--txt3);flex-shrink:0">VOICE</span>
          <select id="motivVoiceSelect" onchange="motivSetVoice(this.value)"
            style="flex:1;background:rgba(240,82,82,0.06);border:1px solid rgba(240,82,82,0.2);border-radius:6px;
            padding:5px 8px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:8px;outline:none;cursor:pointer">
            <option value="">Loading voices...</option>
          </select>
          <div id="motivVolDot" style="width:8px;height:8px;border-radius:50%;background:var(--txt3);flex-shrink:0;transition:all .2s"></div>
        </div>
      </div>

      <!-- Hidden elements kept for JS compatibility -->
      <div id="motivCards" style="display:none"></div>
      <div id="motivTranscript" style="display:none"></div>

    </div>
  </div>

</div><!-- /page -->

<!-- BOTTOM NAV -->
<div id="bnav">
  <button class="bn act" id="bn-col-chart" onclick="goCol('col-chart')"><span class="bn-ico">📈</span>Chart</button>
  <button class="bn" id="bn-col-digit" onclick="goCol('col-digit')"><span class="bn-ico">🎯</span>Digits</button>
  <button class="bn" id="bn-col-rf" onclick="goCol('col-rf')"><span class="bn-ico">⚡</span>Rise/Fall</button>
  <button class="bn" id="bn-col-ldp" onclick="goCol('col-ldp')"><span class="bn-ico">🔬</span>LDP</button>
  <button class="bn" id="bn-col-motivation" onclick="goCol('col-motivation')"><span class="bn-ico">🔥</span>Mindset</button>
  <button class="bn" id="bn-col-trade" onclick="goCol('col-trade')"><span class="bn-ico">💰</span>Trade</button>
</div>

<!-- MODAL -->
<div id="modalBg">
  <div id="modal">
    <div class="m-drag"></div>
    <div class="m-body">

      <!-- Logo mark -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px">
        <div style="width:38px;height:38px;background:#0052ff;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 20px rgba(0,82,255,0.35)">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="2" y="11" width="3" height="7" rx="0.5" fill="white" opacity="0.9"/><rect x="7.5" y="5" width="3" height="9" rx="0.5" fill="white" opacity="0.9"/><rect x="13" y="8" width="3" height="6" rx="0.5" fill="white" opacity="0.9"/><polyline points="2,16 9,9 14.5,11 19,4" stroke="rgba(34,211,238,0.9)" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div>
          <div class="m-title" style="margin-bottom:2px">Connect to Deriv</div>
          <div style="font-size:9px;color:var(--txt3);letter-spacing:.5px">RerrMyTrades — Volatility Engine</div>
        </div>
      </div>

      <div class="m-sub" style="margin-bottom:20px">Authorise with your Deriv account. You'll be redirected to Deriv to grant permissions — then brought straight back to the app.</div>

      <!-- Primary: OAuth button -->
      <button class="m-go" id="oauthBtn" onclick="doOAuth()">
        <span style="display:flex;align-items:center;justify-content:center;gap:8px">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="9" stroke="white" stroke-width="1.5"/><path d="M6.5 10a3.5 3.5 0 1 0 7 0 3.5 3.5 0 0 0-7 0z" fill="white" opacity="0.85"/></svg>
          Connect with Deriv Account
        </span>
      </button>

      <!-- Divider -->
      <div class="m-divider"><span>or use API token directly</span></div>

      <!-- Fallback: manual token -->
      <input class="m-inp" type="password" id="apiTok" placeholder="Paste API Token (read + trade)" autocomplete="off">
      <button class="m-go" onclick="doAuth()" style="background:rgba(0,82,255,0.15);border:1px solid rgba(0,82,255,0.35);box-shadow:none;margin-bottom:8px;color:var(--accent)">🔑 Connect with Token</button>

      <button class="m-skip" onclick="closeModal()">Continue in Demo Mode</button>
      <button class="m-skip" style="color:var(--red);border-color:rgba(240,82,82,0.2);margin-top:4px" onclick="doDisconnect()">🔓 Disconnect</button>

      <div class="m-demo">New to Deriv? <a href="https://deriv.com/signup/" target="_blank">Create a free account →</a></div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"><div class="t-ico" id="tIco"></div><div><div class="t-title" id="tTitle"></div><div class="t-body" id="tBody"></div></div></div>

<!-- BANNER -->
<div id="banner">Demo mode active — <a onclick="doOAuth()">Connect your Deriv account</a> to trade live</div>

<script>
/* ══════════════════════════════════════
   RerrMyTrades — Volatility Engine
   APP_ID: 127596
══════════════════════════════════════ */
const APP_ID = 127596; // rerrmytrades registered Deriv app ID
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

// ── State ──────────────────────────
let ws, tok, sym = 'R_100', tf = '1T';
let wsConn = false, authed = false;
let ticks = [], ohlc = [];
let trades = [];
let cnt = 0, proft = 0, wins = 0, totals = 0, consecLoss = 0, consecWin = 0;
let px = 0, dayO = 0, tPx = {};
let digitHistory = Array(10).fill(0);
let digitStream = []; // actual last digit values
let contractMode = 'rise_fall', selectedDigit = 5, selectedDir = 'buy';
let peakBal = 0, bal = 0, drawdown = 0;

// DTrader state
let dtTradeType = 'rise_fall', dtDuration = 1;
let dtTrades = 0, dtWins = 0, dtPnl = 0;

// DBot state
let dbRunning = false, dbTrades = 0, dbWins = 0, dbPnl = 0, dbConsecLoss = 0;
let dbInterval = null;

// Tick counter state
let tcRunning = false, tcResults = [], tcTarget = 5;

// ── Markets (ONLY Volatility Indices) ──
const MKT = {
  R_10:     {n:'Vol 10',      d:'Volatility 10 Index',       b:9876.54,  v:0.15,  pip:2},
  R_25:     {n:'Vol 25',      d:'Volatility 25 Index',       b:12345.6,  v:0.3,   pip:2},
  R_50:     {n:'Vol 50',      d:'Volatility 50 Index',       b:3456.78,  v:0.4,   pip:2},
  R_75:     {n:'Vol 75',      d:'Volatility 75 Index',       b:1234.56,  v:0.6,   pip:2},
  R_100:    {n:'Vol 100',     d:'Volatility 100 Index',      b:5234.12,  v:0.85,  pip:2},
  '1HZ10V': {n:'Vol 10 (1s)', d:'Volatility 10 (1s) Index',  b:8765.4,   v:0.18,  pip:2},
  '1HZ25V': {n:'Vol 25 (1s)', d:'Volatility 25 (1s) Index',  b:11234.5,  v:0.35,  pip:2},
  '1HZ50V': {n:'Vol 50 (1s)', d:'Volatility 50 (1s) Index',  b:3123.45,  v:0.45,  pip:2},
  '1HZ75V': {n:'Vol 75 (1s)', d:'Volatility 75 (1s) Index',  b:2345.0,   v:0.72,  pip:2},
  '1HZ100V':{n:'Vol 100 (1s)',d:'Volatility 100 (1s) Index', b:4321.0,   v:0.95,  pip:2},
};

// ── Helpers ───────────────────────
const $ = id => document.getElementById(id);
const fp = p => {
  if (!p && p !== 0) return '—';
  if (Math.abs(p) < 0.01) return p.toFixed(5);
  if (Math.abs(p) < 100)  return p.toFixed(4);
  if (Math.abs(p) < 10000) return p.toFixed(2);
  return p.toFixed(0);
};
const clamp = (v,mn,mx) => Math.min(Math.max(v,mn),mx);
const rnd = (mn,mx) => mn + Math.random()*(mx-mn);

// ── Theme ─────────────────────────
function toggleTheme() {
  // Re-apply chart theme after toggle
  requestAnimationFrame(() => {
    if (tvChart) {
      const isLight = document.documentElement.classList.contains('light');
      tvChart.applyOptions({
        layout: {
          background: { type: 'solid', color: isLight ? '#ffffff' : '#151717' },
          textColor: isLight ? '#666666' : '#999999',
        },
        grid: {
          vertLines: { color: isLight ? 'rgba(0,0,0,0.04)' : 'rgba(255,255,255,0.03)' },
          horzLines: { color: isLight ? 'rgba(0,0,0,0.04)' : 'rgba(255,255,255,0.03)' },
        },
        rightPriceScale: { borderColor: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.06)' },
        timeScale:       { borderColor: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.06)' },
      });
    }
  });
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('rmt-theme', isLight ? 'light' : 'dark');
  const ico = $('themeIco');
  if (ico) ico.textContent = isLight ? '☀️' : '🌙';
  // Update lightweight chart background
  if (tvChart) {
    const bg = isLight ? '#f4f3ff' : '#181818';
    const txt = isLight ? '#4b4070' : '#4b5563';
    const grid = isLight ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.04)';
    tvChart.applyOptions({
      layout: { background: { color: bg }, textColor: txt },
      grid: { vertLines: { color: grid }, horzLines: { color: grid } },
    });
  }
  if (window._derivChart) {
    const bg = isLight ? '#f4f3ff' : '#181818';
    const txt = isLight ? '#4b4070' : '#4b5563';
    window._derivChart.applyOptions({
      layout: { background: { color: bg }, textColor: txt },
    });
  }
}
if (localStorage.getItem('rmt-theme') === 'light') {
  document.documentElement.classList.add('light');
  const ico = document.getElementById('themeIco');
  if (ico) ico.textContent = '☀️';
}

// ── Navigation ────────────────────
// All switchable panels (right-side on desktop, full-screen on mobile)
const SWITCH_PANELS = ['col-digit','col-rf','col-ldp','col-dtrader','col-dbot','col-journal','col-trade','col-motivation'];
// Always-visible on desktop (left side)
const FIXED_PANELS = ['col-chart'];
// All panels combined
const ALL_PANELS = [...FIXED_PANELS, ...SWITCH_PANELS];

function goCol(id) {
  const isMobile = window.innerWidth < 960;

  if (isMobile) {
    // Mobile: one panel visible at a time
    ALL_PANELS.forEach(p => {
      const el = $(p); if (!el) return;
      el.classList.remove('active');
    });
    const el = $(id); if (el) el.classList.add('active');
  } else {
    // Desktop: fixed panels always visible, switch panels toggle
    if (SWITCH_PANELS.includes(id)) {
      // Hide all switch panels, show selected
      SWITCH_PANELS.forEach(p => {
        const el = $(p); if (!el) return;
        el.classList.remove('active');
      });
      const el = $(id); if (el) el.classList.add('active');
    }
    // Fixed panels (chart, mkt) always stay visible — handled by CSS
  }

  // Update nav highlights
  document.querySelectorAll('.tn,.bn').forEach(b => b.classList.remove('act'));
  const tn = $('tn-' + id); if (tn) tn.classList.add('act');
  const bn = $('bn-' + id); if (bn) bn.classList.add('act');
}

// ── Modal ─────────────────────────
function openModal() {
  $('modalBg').classList.add('on');
  setTimeout(() => { const i = $('apiTok'); if (i) i.focus(); }, 350);
}
function closeModal() { $('modalBg').classList.remove('on'); }
$('modalBg').addEventListener('click', e => { if (e.target === $('modalBg')) closeModal(); });

// ── Toast ─────────────────────────
let toastTimer;
function toast(ico, title, body = '', dur = 2500) {
  $('tIco').textContent = ico;
  $('tTitle').textContent = title;
  $('tBody').textContent = body;
  const t = $('toast');
  t.style.display = 'flex';
  requestAnimationFrame(() => t.classList.add('on'));
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.classList.remove('on'); setTimeout(() => { t.style.display = 'none'; }, 450); }, dur);
}

// ── WebSocket ─────────────────────
function connectWS() {
  setDot('gold','CONN');
  const dot = $('chartLiveDot'); if (dot) { dot.className = 'chart-live-dot offline'; }
  const ltxt = $('chartLiveTxt'); if (ltxt) { ltxt.textContent = 'CONNECTING'; ltxt.style.color = 'var(--gold)'; }

  // Warn if running from file:// (WebSocket may be blocked by browser)
  if (location.protocol === 'file:') {
    toast('⚠️','Local File Detected',
      'For best results, serve via localhost or rerrmytrades.com. Some browsers block WS on file://', 6000);
  }

  try {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => {
      setDot('green','LIVE'); wsConn = true;
      const dot = $('chartLiveDot'); if (dot) { dot.className = 'chart-live-dot'; }
      const ltxt = $('chartLiveTxt'); if (ltxt) { ltxt.textContent = 'LIVE'; ltxt.style.color = 'var(--green)'; }
      console.log('✅ WS connected to Deriv — App ID:', APP_ID);
      if (tok) {
        wsSend({authorize: tok});
      }
      subTicks(sym);
      setInterval(() => { if (wsConn) wsSend({ping: 1}); }, 25000);
    };
    ws.onmessage = e => { try { onMsg(JSON.parse(e.data)); } catch(err) { console.error('WS parse error:', err); } };
    ws.onclose = (e) => {
      setDot('red','OFF'); wsConn = false; authed = false;
      const dot = $('chartLiveDot'); if (dot) dot.className = 'chart-live-dot offline';
      const ltxt = $('chartLiveTxt'); if (ltxt) { ltxt.textContent = 'OFFLINE'; ltxt.style.color = 'var(--red)'; }
      console.warn('WS closed — code:', e.code, '| reason:', e.reason || 'none');
      // Show user-visible error for common close codes
      if (e.code === 1006) toast('📡','Connection Lost', 'Reconnecting to Deriv...', 3000);
      setTimeout(connectWS, 3000);
    };
    ws.onerror = (e) => {
      console.error('WS error event:', e);
      setDot('red','ERR');
      toast('❌','WS Error', 'Check console (F12) for details');
    };
  } catch(e) {
    console.error('WS connect failed:', e);
    setDot('red','ERR');
    setTimeout(connectWS, 5000);
  }
}
function wsSend(o) { if (ws && ws.readyState === 1) ws.send(JSON.stringify(o)); }

// Granularity map for all timeframes
const TF_GRAN = {'1M':60,'5M':300,'15M':900,'1H':3600,'4H':14400,'1D':86400};

function subTicks(s) {
  wsSend({forget_all: 'ticks'});
  wsSend({forget_all: 'candles'});
  // Subscribe to live ticks
  wsSend({ticks: s, subscribe: 1});
  // Also get historical data for current timeframe
  if (tf === '1T') {
    // Get last 500 ticks for tick history chart
    wsSend({ticks_history: s, adjust_start_time: 1, count: 500, end: 'latest', style: 'ticks', subscribe: 0});
  } else {
    getOHLC(s, tf);
  }
}
function getOHLC(s, f) {
  const g = TF_GRAN[f] || 60;
  wsSend({forget_all: 'candles'});
  wsSend({ticks_history: s, adjust_start_time: 1, count: 300, end: 'latest', granularity: g, style: 'candles', subscribe: 1});
}

function onMsg(d) {
  if (d.error) {
    if (d.error.code === 'InvalidToken') toast('❌','Invalid Token', d.error.message);
    else if (d.error.code === 'AuthorizationRequired') { toast('🔑','Auth Required','Please connect your API token'); openModal(); }
    else toast('⚠️','API Error', d.error.message || d.error.code);
    console.warn('WS error:', d.error.code, d.error.message);
    window._pendingTrade = null;
    return;
  }
  switch(d.msg_type) {
    case 'authorize':
      authed = true; bal = d.authorize.balance; peakBal = bal;
      updBal(bal);
      $('btnApi').textContent = '✓ LIVE'; $('btnApi').classList.add('live');
      $('banner').style.display = 'none'; $('balChip').style.display = 'flex';
      $('balStat').style.display = 'flex';
      const dot = $('chartLiveDot'); if (dot) dot.classList.remove('offline');
      const ltxt = $('chartLiveTxt'); if (ltxt) { ltxt.textContent = 'LIVE'; ltxt.style.color = 'var(--green)'; }
      toast('✅','Connected!', `${d.authorize.loginid} · Balance: $${bal.toFixed(2)}`);
      closeModal();
      wsSend({balance: 1, subscribe: 1, account: 'current'});
      break;

    case 'balance':
      bal = d.balance.balance;
      updBal(bal);
      // Update drawdown
      if (bal > peakBal) peakBal = bal;
      if (peakBal > 0) drawdown = Math.max(drawdown, (peakBal - bal) / peakBal * 100);
      break;

    case 'proposal':
      // Got price quote — now execute the buy immediately
      if (d.proposal && window._pendingTrade) {
        const proposalId = d.proposal.id;
        const askPrice = d.proposal.ask_price;
        wsSend({ buy: proposalId, price: askPrice });
        toast('💫','Buying...', `${window._pendingTrade.ct} · $${askPrice}`);
      }
      break;

    case 'buy':
      onBuy(d.buy);
      window._pendingTrade = null;
      break;

    case 'tick': onTick(d.tick); break;

    case 'history':
      if (d.history && d.history.times && d.history.prices) {
        initTickHistory(d.history);
      }
      break;
    case 'candles': if (d.candles) initOHLC(d.candles); break;
    case 'ohlc': if (d.ohlc) updOHLC(d.ohlc); break;
    case 'proposal_open_contract': onPoc(d.proposal_open_contract); break;
    case 'forget_all': break;
    case 'ping': break;
  }
}

function setDot(c, txt) {
  const d = $('wsDot'), s = $('wsStatus');
  if (d) { d.style.background = c === 'green' ? 'var(--green)' : c === 'gold' ? 'var(--gold)' : 'var(--red)'; d.style.boxShadow = `0 0 6px ${c === 'green' ? 'var(--green)' : c === 'gold' ? 'var(--gold)' : 'var(--red)'}`; }
  if (s) s.textContent = txt;
}

function onTick(t) {
  const prev = px; px = +t.quote;
  const epoch = t.epoch || Math.floor(Date.now() / 1000);
  ticks.push(px); if (ticks.length > 500) ticks.shift();
  tickEpochs.push(epoch); if (tickEpochs.length > 500) tickEpochs.shift();

  // Extract last digit from price string (e.g. "1234.56" → 6)
  const priceStr = t.quote ? t.quote.toString() : px.toFixed(MKT[sym]?.dp || 2);
  const lastDigit = parseInt(priceStr.replace('.','').slice(-1)) || 0;
  digitHistory[lastDigit]++;
  digitStream.push(lastDigit); if (digitStream.length > 500) digitStream.shift();

  updPriceUI(px, prev);

  // Update TV chart — tick mode: append point; candle mode: update last candle
  if (tf === '1T') {
    tvChartUpdateTick(px, epoch);
  } else {
    // Update the current forming candle in ohlc array
    const lc = ohlc[ohlc.length - 1];
    if (lc) {
      lc.h = Math.max(lc.h, px); lc.l = Math.min(lc.l, px); lc.c = px;
      tvChartUpdateCandle(lc);
    }
  }

  updateDigitAnalysis();
  runAI();
  updateRFAnalysis();
  tickCounterTick(px, prev);
  atcTick(px, prev);
}

function initTickHistory(history) {
  // Load historical tick data into TV tick series
  ticks = history.prices.map(p => +p);
  tickEpochs = history.times.map(t => +t);
  if (ticks.length > 0) { px = ticks[ticks.length - 1]; dayO = ticks[0]; }

  // Seed digit history from tick data
  digitHistory = Array(10).fill(0);
  digitStream = [];
  ticks.forEach(p => {
    const d = parseInt(p.toString().replace('.','').slice(-1)) || 0;
    digitHistory[d]++; digitStream.push(d);
  });

  if (tvTickSeries && tf === '1T') {
    // Build unique time→value data points
    const seen = new Set();
    const data = tickEpochs.map((t, i) => ({ time: t, value: ticks[i] }))
      .filter(d => d.value > 0 && !seen.has(d.time) && seen.add(d.time))
      .sort((a, b) => a.time - b.time);
    try {
      tvTickSeries.setData(data);
      tvChart.timeScale().fitContent();
      hideChartLoader();
    } catch(e) { console.warn('tick history setData:', e); }
  }
  updPriceUI(px, px);
  updateDigitAnalysis();
}

function initOHLC(cs) {
  ohlc = cs.map(c => ({e: +c.epoch, o: +c.open, h: +c.high, l: +c.low, c: +c.close}));
  dayO = ohlc[0]?.o || px;
  if (ohlc.length > 0) px = ohlc[ohlc.length - 1].c;

  // Load into TV chart
  if (!tvSeries) buildMainSeries();
  loadOHLCData();
  hideChartLoader();
  updIndicators();
  updPriceUI(px, px);
}

function updOHLC(c) {
  const epoch = +c.epoch;
  const last = ohlc[ohlc.length - 1];
  if (last && last.e === epoch) {
    // Update current forming candle
    last.o = +c.open; last.h = +c.high; last.l = +c.low; last.c = +c.close;
  } else {
    // New candle formed
    ohlc.push({e: epoch, o: +c.open, h: +c.high, l: +c.low, c: +c.close});
    if (ohlc.length > 300) ohlc.shift();
  }
  tvChartUpdateCandle(ohlc[ohlc.length - 1]);
  updIndicators();
}
function onBuy(b) {
  const pending = window._pendingTrade || {};
  const t = {
    id: b.contract_id,
    sym,
    type: contractMode,
    dir: pending.dir || (selectedDir === 'buy' ? 'CALL' : 'PUT'),
    stake: b.buy_price || pending.stake || +($('stakeV')?.value || 10),
    entry: px,
    time: new Date().toLocaleTimeString(),
    status: 'open',
    pnl: 0
  };
  trades.unshift(t); cnt++;
  updStats(); updJournal();
  toast('📈','Trade Open', `#${String(b.contract_id).slice(-6)} · $${t.stake.toFixed(2)}`);
  // Subscribe to contract updates
  wsSend({proposal_open_contract: 1, contract_id: b.contract_id, subscribe: 1});
}

function onPoc(p) {
  const t = trades.find(x => x.id == p.contract_id);
  if (!t) return;
  t.pnl = +(p.profit || 0);

  if (p.is_sold || p.is_expired) {
    const won = p.profit > 0;
    t.status = won ? 'won' : 'lost';
    t.pnl = +(p.profit || 0);

    if (won) { wins++; consecWin++; consecLoss = 0; }
    else { consecLoss++; consecWin = 0; }
    totals++;
    proft += t.pnl;

    checkRiskLimits();
    // Notify auto bot if this was a bot trade
    if (window._pendingTrade && window._pendingTrade.isBot) {
      if (window._pendingTrade.isDpbot) {
        dpbotHandlePoc(won, +(p.profit || 0), window._pendingTrade.ct);
      } else {
        window._pendingTrade.isBot = false;
        atcBotOnTradeDone(won, +(p.profit || 0));
      }
    }
    toast(
      won ? '🏆' : '❌',
      won ? 'Trade Won!' : 'Trade Lost',
      `${(p.profit >= 0 ? '+' : '')}$${(+p.profit).toFixed(2)} · Balance: $${(+p.balance_after).toFixed(2)}`
    );

    // Update balance immediately from contract result (instant, no extra request needed)
    if (p.balance_after) {
      bal = +p.balance_after;
      updBal(bal);
      if (bal > peakBal) peakBal = bal;
      if (peakBal > 0) drawdown = Math.max(drawdown, (peakBal - bal) / peakBal * 100);
    } else {
      // Fallback: request fresh balance
      wsSend({balance: 1});
    }
  }
  updStats(); updJournal();
}

// ── Demo simulation ───────────────
function startDemo() {
  buildCandles(sym);
  // Load initial data into TV chart
  setTimeout(() => {
    if (!wsConn) {
      if (tf === '1T') {
        buildMainSeries();
        loadTickData();
      } else {
        buildMainSeries();
        loadOHLCData();
      }
      hideChartLoader();
    }
  }, 200);

  renderMkts(); renderTicker();
  updPriceUI(px, px); buildDigitGrid(); buildPredGrid(); renderLastDigits();
  renderDtDigitBtns();

  setInterval(() => {
    if (wsConn) return; // Don't simulate when live
    const m = MKT[sym] || MKT.R_100;
    const prev = px;
    px = Math.max(0.001, px + (Math.random() - 0.49) * m.v);
    const epoch = Math.floor(Date.now() / 1000);

    ticks.push(px); if (ticks.length > 500) ticks.shift();
    tickEpochs.push(epoch); if (tickEpochs.length > 500) tickEpochs.shift();

    const priceStr = px.toFixed(m.dp || 2);
    const ld = parseInt(priceStr.replace('.','').slice(-1)) || 0;
    digitHistory[ld]++;
    digitStream.push(ld); if (digitStream.length > 500) digitStream.shift();
    if (digitHistory.reduce((a,b)=>a+b,0) > 1000) digitHistory = digitHistory.map(v => Math.max(0, v - 1));

    const lc = ohlc[ohlc.length-1];
    if (lc) { lc.h = Math.max(lc.h, px); lc.l = Math.min(lc.l, px); lc.c = px; }

    Object.keys(tPx).forEach(s => { tPx[s] = Math.max(0.001, tPx[s] + (Math.random() - 0.49) * MKT[s].v); });

    updPriceUI(px, prev);

    // Update TV chart
    if (tf === '1T') {
      tvChartUpdateTick(px, epoch);
    } else if (lc) {
      tvChartUpdateCandle(lc);
    }

    renderTicker(); renderMkts(); updateDigitAnalysis();
    runAI(); updateRFAnalysis();
    tickCounterTick(px, prev);
    if (dbRunning) runDBotTick();
  }, 380);

  // Candle formation every minute (demo only)
  setInterval(() => {
    if (wsConn || tf === '1T') return;
    const epoch = Math.floor(Date.now() / 1000);
    ohlc.push({e: epoch, o: px, h: px, l: px, c: px});
    if (ohlc.length > 300) ohlc.shift();
  }, 60000);
}

function buildCandles(s) {
  const m = MKT[s]; let p = tPx[s] || m.b;
  ohlc = []; ticks = []; tickEpochs = [];
  const now = Math.floor(Date.now()/1000);
  for (let i = 299; i >= 0; i--) {
    const o = p, h = p + Math.random()*m.v*2.5, l = p - Math.random()*m.v*2.5, c = l + Math.random()*(h-l);
    ohlc.push({e: now - i*60, o, h, l, c}); p = c;
  }
  px = p; dayO = ohlc[0].o;

  // Seed tick history (last 500 ticks at ~0.4s intervals)
  let tp = px;
  for (let i = 499; i >= 0; i--) {
    tp = Math.max(0.001, tp + (Math.random() - 0.5) * m.v * 0.3);
    ticks.unshift(tp);
    tickEpochs.unshift(now - i);
  }
  px = ticks[ticks.length - 1];

  // Seed digit history
  digitHistory = Array(10).fill(0);
  digitStream = [];
  ticks.forEach(tickPx => {
    const d = parseInt(tickPx.toFixed(m.dp || 2).replace('.','').slice(-1)) || 0;
    digitHistory[d]++; digitStream.push(d);
  });
}

// ── Market selection ──────────────
function selMkt(s) {
  sym = s;
  const m = MKT[s]; if (!m) return;
  px = tPx[s] || m.b;

  // Show loader
  const loader = $('chartLoader');
  if (loader) { loader.style.display = 'flex'; loader.style.opacity = '1'; }

  buildCandles(s);
  ticks = [px]; tickEpochs = [Math.floor(Date.now()/1000)];

  if (wsConn) {
    subTicks(s);
  } else {
    // Demo: rebuild TV chart with new candles
    buildMainSeries();
    if (tf === '1T') loadTickData(); else loadOHLCData();
    hideChartLoader();
  }

  // Update all symbol labels
  const symEls = ['cSym','hSym','tradeMkt','dtSym','mktBadge'];
  symEls.forEach(id => { const e = $(id); if (e) e.textContent = m.n; });
  $('cSym').textContent = m.n;
  $('cDesc').textContent = m.d;
  $('tradeMkt').textContent = m.n;
  $('dtSym').textContent = m.n;
  $('mktBadge').textContent = s;
  const dtDescEl = document.querySelector('#col-dtrader .dtrader-mkt-row div div:last-child');
  if (dtDescEl) dtDescEl.textContent = m.d;

  digitHistory = Array(10).fill(0); digitStream = [];
  renderMkts(); updPriceUI(px, px); renderTicker();
  updateDigitAnalysis(); calcPay(); calcDTPay();
  updateDerivChart(s);
  toast('🔄','Market', m.d);
}

// ── Price UI ──────────────────────
function updPriceUI(p, prev) {
  const ids = ['hPx','cPx','tradePx','dtPx'];
  ids.forEach(id => {
    const e = $(id); if (!e) return;
    e.textContent = fp(p);
    e.classList.remove('fup','fdn');
    void e.offsetWidth;
    if (p > prev) e.classList.add('fup');
    else if (p < prev) e.classList.add('fdn');
  });

  // Day change
  if (dayO) {
    const chgPct = ((p - dayO) / dayO * 100);
    const chgStr = (chgPct >= 0 ? '+' : '') + chgPct.toFixed(2) + '%';
    const chgColor = chgPct >= 0 ? 'var(--green)' : 'var(--red)';
    ['hChg','cChg','dtChg'].forEach(id => {
      const e = $(id); if (!e) return;
      e.textContent = chgStr; e.style.color = chgColor;
    });
  }
}

function updBal(b) {
  const fmt = '$' + (+b).toFixed(2);
  const e = $('balChip'); if (e) e.textContent = fmt;
  const h = $('hBal'); if (h) h.textContent = fmt;
  // Flash green or red based on direction
  if (window._lastBal !== undefined) {
    const el = $('hBal');
    if (el) {
      el.classList.remove('fup','fdn');
      void el.offsetWidth;
      if (b > window._lastBal) el.classList.add('fup');
      else if (b < window._lastBal) el.classList.add('fdn');
    }
  }
  window._lastBal = b;
}

// ── Render Markets ────────────────
function renderMkts() {
  const el = $('mktList'); if (!el) return;
  el.innerHTML = Object.entries(MKT).map(([s, m]) => {
    const p = tPx[s] || m.b;
    const chg = ((p - m.b) / m.b * 100);
    const isSel = s === sym;
    const is1s = s.startsWith('1HZ');
    return `<div class="mkt-row ${isSel?'sel':''}" onclick="selMkt('${s}')">
      <div style="display:flex;flex-direction:column;gap:1px;min-width:0;flex:1">
        <span class="mkt-sym">${m.n}</span>
        <span class="mkt-px">${fp(p)}</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
        <span class="mkt-chg ${chg>=0?'up':'dn'}">${chg>=0?'+':''}${chg.toFixed(2)}%</span>
        ${is1s ? '<span class="mkt-vol-type">1s</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

// ── Render Ticker ─────────────────
function renderTicker() {
  const html = Object.entries(tPx).map(([s,p]) => {
    const m = MKT[s]; if (!m) return '';
    const chg = ((p - m.b) / m.b * 100);
    return `<div class="tick-item"><span class="ti-sym">${m.n}</span><span class="ti-price">${fp(p)}</span><span class="ti-chg ${chg>=0?'up':'dn'}">${chg>=0?'+':''}${chg.toFixed(2)}%</span></div>`;
  }).join('');
  const tt = $('tickTrack'); if (tt) tt.innerHTML = html + html;
}

// ── DIGIT ANALYSIS ────────────────
function buildDigitGrid() {
  const el = $('digitGrid'); if (!el) return;
  el.innerHTML = [0,1,2,3,4,5,6,7,8,9].map(d =>
    `<button class="digit-btn ${d===selectedDigit?'sel':''}" onclick="selDigit(${d},this)" id="dgBtn${d}">${d}<span class="d-pct" id="dgPct${d}">-</span></button>`
  ).join('');
}

function buildPredGrid() {
  const el = $('predGrid'); if (!el) return;
  el.innerHTML = [0,1,2,3,4,5,6,7,8,9].map(d =>
    `<div class="pred-cell" id="predCell${d}"><div class="pred-num">${d}</div><div class="pred-pct" id="predPct${d}">-</div></div>`
  ).join('');
}

function renderDtDigitBtns() {
  const el = $('dtDigitBtns'); if (!el) return;
  el.innerHTML = [0,1,2,3,4,5,6,7,8,9].map(d =>
    `<button class="digit-btn ${d===5?'sel':''}" onclick="dtSelDigit(${d},this)">${d}</button>`
  ).join('');
}

function selDigit(d, btn) {
  selectedDigit = d;
  document.querySelectorAll('#digitGrid .digit-btn').forEach(b => b.classList.remove('sel'));
  if (btn) btn.classList.add('sel');
  const info = $('digitInfo');
  if (contractMode === 'over_under') {
    if (info) info.textContent = d < 9 ? `Bet digit will be OVER ${d}` : 'Select 0–8 for Over';
  } else if (contractMode === 'matches_differs') {
    if (info) info.textContent = `Bet last digit MATCHES ${d} or DIFFERS from ${d}`;
  }
  calcPay();
}

let dtSelectedDigit = 5;
function dtSelDigit(d, btn) {
  dtSelectedDigit = d;
  document.querySelectorAll('#dtDigitBtns .digit-btn').forEach(b => b.classList.remove('sel'));
  if (btn) btn.classList.add('sel');
  calcDTPay();
}

function updateDigitAnalysis() {
  const total = digitStream.length || 1;
  const last100 = digitStream.slice(-100);
  const t100 = last100.length || 1;

  // Update heatmap
  const hmap = $('digitHmap'); if (hmap) {
    const counts = Array(10).fill(0);
    last100.forEach(d => counts[d]++);
    const maxC = Math.max(...counts) || 1;
    hmap.innerHTML = counts.map((c,d) => {
      const pct = (c / t100 * 100);
      const isHot = pct > 13;
      const isCold = pct < 7;
      const hue = isHot ? 'rgba(239,68,68,0.85)' : isCold ? 'rgba(16,185,129,0.85)' : 'rgba(139,92,246,0.8)';
      const bg = isHot ? 'rgba(240,82,82,0.1)' : isCold ? 'rgba(5,177,105,0.1)' : 'rgba(139,92,246,0.07)';
      const border = isHot ? '1px solid rgba(240,82,82,0.3)' : isCold ? '1px solid rgba(16,185,129,0.25)' : '1px solid rgba(255,255,255,0.08)';
      return `<div class="dh-cell" style="background:${bg};border:${border}">
        <div class="dh-num" style="color:${hue}">${d}</div>
        <div class="dh-pct" style="color:${hue}">${pct.toFixed(0)}%</div>
        <div class="dh-bar-wrap"><div class="dh-bar-fill" style="width:${c/maxC*100}%;background:${hue}"></div></div>
      </div>`;
    }).join('');
  }

  // Over/Under (kept for internal use by dpbot)
  const over = last100.filter(d => d > 4).length;
  const under = last100.filter(d => d < 5).length;
  const even = last100.filter(d => d % 2 === 0).length;
  const odd = last100.filter(d => d % 2 !== 0).length;

  // Update digit buttons in trade panel
  const counts2 = Array(10).fill(0);
  last100.forEach(d => counts2[d]++);
  const avg = t100 / 10;
  [0,1,2,3,4,5,6,7,8,9].forEach(d => {
    const btn = $('dgBtn' + d);
    const pctEl = $('dgPct' + d);
    const pct = (counts2[d] / t100 * 100);
    if (pctEl) pctEl.textContent = pct.toFixed(0) + '%';
    if (btn) {
      btn.classList.remove('hot','cold','warm');
      if (d === selectedDigit) return;
      if (pct > 13) btn.classList.add('hot');
      else if (pct < 7) btn.classList.add('cold');
      else if (pct > 11) btn.classList.add('warm');
    }
  });

  // Bias score (kept for internal calculations)
  const bullScore = (over / t100 * 100);

  // Next digit prediction (using frequency-based model)
  updateNextDigitPrediction(counts2, t100);

  // Render last digits stream
  renderLastDigits();

  // Digit pattern bot analysis — runs on every tick
  dpbotAnalyse();
}

function updateNextDigitPrediction(counts, total) {
  // Regression to mean: digits that are low have higher probability of appearing
  const mean = total / 10;
  const rawProbs = counts.map(c => {
    // Inverse frequency + slight randomness
    const deficit = Math.max(0, mean - c);
    return 10 + deficit * 0.8 + Math.random() * 2;
  });
  const sumProbs = rawProbs.reduce((a,b)=>a+b,0);
  const probs = rawProbs.map(p => p / sumProbs * 100);

  const maxProb = Math.max(...probs);
  const minProb = Math.min(...probs);

  [0,1,2,3,4,5,6,7,8,9].forEach(d => {
    const cell = $('predCell' + d);
    const pctEl = $('predPct' + d);
    if (!cell || !pctEl) return;
    pctEl.textContent = probs[d].toFixed(1) + '%';
    cell.classList.remove('best','worst');
    if (probs[d] >= maxProb - 0.5) cell.classList.add('best');
    else if (probs[d] <= minProb + 0.5) cell.classList.add('worst');
  });
}

function renderLastDigits() {
  const el = $('lastDigits'); if (!el) return;
  const last40 = digitStream.slice(-40);
  el.innerHTML = last40.map(d =>
    `<div class="ld ${d%2===0?'ev':'od'}">${d}</div>`
  ).join('');
}

// ── AI ANALYSIS ───────────────────
let aiSignal = {dir:'neut', conf:50, rsi:50, trend:'NEUT', macd:0};

function runAI() {
  if (ohlc.length < 20) return;
  const closes = ohlc.map(c => c.c);
  const rsi = calcRSI(closes, 14);
  const ema20 = calcEMA(closes, 20);
  const ema9 = calcEMA(closes, 9);
  const last = closes[closes.length-1];
  const atr = calcATR(ohlc.slice(-14));
  const macd = (ema9[ema9.length-1]||last) - (ema20[ema20.length-1]||last);
  const trendStr = ema20[ema20.length-1] ? (last > ema20[ema20.length-1] ? 'BULL' : 'BEAR') : 'NEUT';
  const momentum = closes.length > 10 ? ((last - closes[closes.length-10]) / closes[closes.length-10] * 100) : 0;

  let bullScore = 50;
  if (rsi < 40) bullScore += 12; if (rsi > 60) bullScore -= 12;
  if (rsi < 30) bullScore += 8; if (rsi > 70) bullScore -= 8;
  if (macd > 0) bullScore += 8; if (macd < 0) bullScore -= 8;
  if (trendStr === 'BULL') bullScore += 8; if (trendStr === 'BEAR') bullScore -= 8;
  if (momentum > 0) bullScore += 4; if (momentum < 0) bullScore -= 4;
  bullScore = clamp(bullScore, 10, 90);

  aiSignal = {dir: bullScore > 55 ? 'bull' : bullScore < 45 ? 'bear' : 'neut',
    conf: bullScore > 50 ? bullScore : 100-bullScore, rsi, trend: trendStr, macd, momentum, atr};

  updIndicators();
}

function calcRSI(data, period) {
  if (data.length < period + 1) return 50;
  let gains = 0, losses = 0;
  for (let i = data.length - period; i < data.length; i++) {
    const diff = data[i] - data[i-1];
    if (diff > 0) gains += diff; else losses -= diff;
  }
  const rs = gains / (losses || 0.001);
  return 100 - (100 / (1 + rs));
}
function calcEMA(data, p) {
  const k = 2/(p+1); let e = null;
  return data.map((v,i) => {
    if (i < p-1) return null;
    if (e === null) { e = data.slice(0,p).reduce((a,b)=>a+b,0)/p; return e; }
    return e = v*k + e*(1-k);
  });
}
function calcATR(candles) {
  if (!candles.length) return 0;
  return candles.reduce((sum,c) => sum + Math.abs(c.h - c.l), 0) / candles.length;
}
function calcBB(data, period, mult) {
  if (data.length < period) return {upper:0,lower:0,mid:0};
  const sl = data.slice(-period);
  const mean = sl.reduce((a,b)=>a+b,0)/sl.length;
  const sd = Math.sqrt(sl.reduce((a,b)=>a+(b-mean)**2,0)/sl.length);
  return {upper: mean+mult*sd, lower: mean-mult*sd, mid:mean, width: (2*mult*sd/mean*100)};
}

function updIndicators() {
  const s = aiSignal;
  const setV = (id, txt, cls) => { const e=$(id); if(!e) return; e.textContent=txt; if(cls) e.className='ind-v '+cls; };
  setV('indRsi', s.rsi.toFixed(1), s.rsi<40?'bull':s.rsi>60?'bear':'neut');
  const ema20 = calcEMA(ohlc.map(c=>c.c), 20);
  const e20 = ema20.filter(Boolean).pop();
  setV('indEma', e20 ? fp(e20) : '—', e20 ? (px > e20 ? 'bull' : 'bear') : '');
  setV('indMacd', s.macd.toFixed(4), s.macd>0?'bull':'bear');
  setV('indAtr', s.atr ? s.atr.toFixed(4) : '—', '');
  setV('indTrend', s.trend, s.trend==='BULL'?'bull':s.trend==='BEAR'?'bear':'neut');
  setV('indSig', s.dir==='bull'?'RISE':s.dir==='bear'?'FALL':'NEUTRAL', s.dir==='bull'?'bull':s.dir==='bear'?'bear':'neut');
}

// ── RISE / FALL ANALYSIS ──────────
let rfPatterns = [];
function updateRFAnalysis() {
  if (ohlc.length < 5) return;
  const data = ohlc.slice(-20);

  // Detect candlestick patterns
  rfPatterns = detectPatterns(data);
  renderPatterns();

  // Multi-signal consensus
  renderRFConsensus();

  // Overall RF prediction
  updateRFPrediction();
}

function detectPatterns(data) {
  const patterns = [];
  const n = data.length;
  if (n < 3) return patterns;

  const c = data[n-1], p = data[n-2], pp = data[n-3];
  const cUp = c.c > c.o, pUp = p.c > p.o;
  const cBody = Math.abs(c.c - c.o), pBody = Math.abs(p.c - p.o);
  const cRange = c.h - c.l, pRange = p.h - p.l;
  const cUWick = c.h - Math.max(c.c, c.o);
  const cLWick = Math.min(c.c, c.o) - c.l;

  // Doji
  if (cBody < cRange * 0.1) patterns.push({name:'Doji', signal:'neut', conf:55});
  // Hammer
  if (cLWick > cBody * 2 && cUWick < cBody * 0.5 && !cUp) patterns.push({name:'Hammer', signal:'bull', conf:68});
  // Shooting Star
  if (cUWick > cBody * 2 && cLWick < cBody * 0.5 && cUp) patterns.push({name:'Shooting Star', signal:'bear', conf:66});
  // Bullish Engulfing
  if (cUp && !pUp && c.o < p.c && c.c > p.o) patterns.push({name:'Bullish Engulfing', signal:'bull', conf:75});
  // Bearish Engulfing
  if (!cUp && pUp && c.o > p.c && c.c < p.o) patterns.push({name:'Bearish Engulfing', signal:'bear', conf:74});
  // Morning Star
  if (!pUp && cUp && pBody > Math.abs(pp.c-pp.o)*0.5 && c.c > (p.o + p.c)/2) patterns.push({name:'Morning Star', signal:'bull', conf:71});
  // Three white soldiers
  if (cUp && pUp && ohlc[n-3] && ohlc[n-3].c < ohlc[n-3].o === false && c.c > p.c && p.c > ohlc[n-3].c) patterns.push({name:'Three Soldiers', signal:'bull', conf:79});
  // Three black crows
  if (!cUp && !pUp && c.c < p.c && p.c < (ohlc[n-3]?.c||0)) patterns.push({name:'Three Crows', signal:'bear', conf:78});

  // If few natural patterns, add trend/momentum ones
  if (patterns.length === 0) {
    const trend = aiSignal.trend;
    const rsi = aiSignal.rsi;
    if (trend === 'BULL') patterns.push({name:'EMA Uptrend', signal:'bull', conf:62});
    else if (trend === 'BEAR') patterns.push({name:'EMA Downtrend', signal:'bear', conf:60});
    if (rsi < 30) patterns.push({name:'RSI Oversold', signal:'bull', conf:70});
    else if (rsi > 70) patterns.push({name:'RSI Overbought', signal:'bear', conf:70});
    patterns.push({name:'Momentum ' + (aiSignal.momentum > 0 ? 'Up' : 'Down'), signal: aiSignal.momentum > 0 ? 'bull' : 'bear', conf: 55});
  }

  return patterns.slice(0, 5);
}

function renderPatterns() {
  const el = $('patternList'); if (!el) return;
  if (!rfPatterns.length) { el.innerHTML = '<div style="font-size:9px;color:var(--txt3);padding:4px 0">Analysing patterns...</div>'; return; }
  el.innerHTML = rfPatterns.map(p =>
    `<div class="pattern-item">
      <span class="pi-name">${p.name}</span>
      <span class="pi-signal ${p.signal}">${p.signal==='bull'?'▲ RISE':p.signal==='bear'?'▼ FALL':'◆ NEUTRAL'}</span>
      <span class="pi-conf">${p.conf}%</span>
    </div>`
  ).join('');
}

function renderRFConsensus() {
  const el = $('rfConsensus'); if (!el) return;
  const indicators = [
    {name:'RSI', bull: aiSignal.rsi < 50, conf: Math.abs(50 - aiSignal.rsi)},
    {name:'EMA Trend', bull: aiSignal.trend === 'BULL', conf: 65},
    {name:'MACD', bull: aiSignal.macd > 0, conf: 60},
    {name:'Momentum', bull: aiSignal.momentum > 0, conf: 55},
    {name:'Pattern', bull: rfPatterns.filter(p=>p.signal==='bull').length > rfPatterns.filter(p=>p.signal==='bear').length, conf: 65},
    {name:'LDP Bias', bull: digitStream.slice(-20).filter(d=>d>4).length > 10, conf: 50},
  ];

  el.innerHTML = indicators.map(ind => {
    const color = ind.bull ? 'var(--green)' : 'var(--red)';
    const label = ind.bull ? '▲ RISE' : '▼ FALL';
    return `<div style="display:flex;align-items:center;gap:6px;padding:4px 0">
      <span style="font-size:8px;color:var(--txt3);width:70px;flex-shrink:0">${ind.name}</span>
      <div style="flex:1;height:3px;background:rgba(255,255,255,0.04);border-radius:2px;overflow:hidden">
        <div style="width:${ind.conf}%;height:100%;background:${color};transition:width .5s"></div>
      </div>
      <span style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;color:${color};width:45px;text-align:right">${label}</span>
    </div>`;
  }).join('');
}

function updateRFPrediction() {
  const s = aiSignal;
  const box = $('rfPredBox'), dir = $('rfPredDir'), conf = $('rfPredConf'), reason = $('rfPredReason');
  if (!box || !dir) return;

  const bullVotes = rfPatterns.filter(p=>p.signal==='bull').length;
  const bearVotes = rfPatterns.filter(p=>p.signal==='bear').length;
  let prediction, pConf;

  if (s.dir === 'bull' && bullVotes >= bearVotes) {
    prediction = 'RISE'; pConf = clamp(s.conf + bullVotes * 3, 50, 92);
  } else if (s.dir === 'bear' && bearVotes >= bullVotes) {
    prediction = 'FALL'; pConf = clamp(s.conf + bearVotes * 3, 50, 92);
  } else if (s.dir !== 'neut') {
    prediction = s.dir === 'bull' ? 'RISE' : 'FALL'; pConf = s.conf - 5;
  } else {
    prediction = 'NEUTRAL'; pConf = 50;
  }

  box.className = `rf-pred-box ${prediction === 'RISE' ? 'rise' : prediction === 'FALL' ? 'fall' : 'neut'}`;
  dir.className = `rfp-dir ${prediction === 'RISE' ? 'rise' : prediction === 'FALL' ? 'fall' : 'neut'}`;
  dir.textContent = prediction === 'RISE' ? '▲ RISE' : prediction === 'FALL' ? '▼ FALL' : '◆ NEUTRAL';
  conf.textContent = pConf.toFixed(0) + '%';
  conf.style.color = prediction === 'RISE' ? 'var(--green)' : prediction === 'FALL' ? 'var(--red)' : 'var(--violet)';

  const rsiNote = s.rsi < 35 ? 'RSI oversold (' + s.rsi.toFixed(0) + ')' :
                  s.rsi > 65 ? 'RSI overbought (' + s.rsi.toFixed(0) + ')' : 'RSI neutral';
  reason.textContent = `${s.trend} trend · ${rsiNote} · ${bullVotes}B/${bearVotes}R patterns`;
}

// ── TICK COUNTER ──────────────────
let tcTickPrices = [], tcStarted = false;

function startTickCounter() {
  const btn = $('tcBtn'), countInp = $('tcCount');
  tcTarget = parseInt(countInp?.value || 5);
  if (tcRunning) {
    // Stop
    tcRunning = false; tcStarted = false; tcTickPrices = [];
    btn.textContent = '▶ START'; btn.classList.remove('active');
    $('tcResult').style.display = 'none';
    renderTickDots();
    return;
  }
  tcRunning = true; tcStarted = true;
  tcTickPrices = [px]; // first tick
  tcResults = [];
  btn.textContent = '⏹ STOP'; btn.classList.add('active');
  $('tcResult').style.display = 'none';
  renderTickDots();
  toast('⏱','Tick Counter', `Counting ${tcTarget} ticks...`);
}

function tickCounterTick(p, prev) {
  if (!tcRunning || !tcStarted) return;
  tcTickPrices.push(p);
  tcResults.push(p > prev ? 'up' : 'dn');
  renderTickDots();

  if (tcResults.length >= tcTarget) {
    // Done!
    const ups = tcResults.filter(r=>r==='up').length;
    const dns = tcResults.filter(r=>r==='dn').length;
    const prediction = ups > dns ? 'RISE' : ups < dns ? 'FALL' : 'NEUTRAL';
    const conf = Math.round(Math.max(ups,dns) / tcResults.length * 100);
    const result = $('tcResult');
    if (result) {
      result.className = `tc-result ${prediction === 'RISE' ? 'rise' : 'fall'}`;
      result.textContent = `${prediction === 'RISE' ? '▲' : '▼'} ${prediction} — ${ups} up / ${dns} down (${conf}% bias)`;
      result.style.display = 'block';
    }
    tcRunning = false; tcStarted = false; tcTickPrices = [];
    const btn = $('tcBtn'); if (btn) { btn.textContent = '▶ START'; btn.classList.remove('active'); }
  }
}

function renderTickDots() {
  const el = $('tickDots'); if (!el) return;
  const total = tcTarget || 5;
  let html = '';
  for (let i = 0; i < total; i++) {
    if (i < tcResults.length) {
      html += `<div class="tick-dot ${tcResults[i]}"></div>`;
    } else if (tcRunning && i === tcResults.length) {
      html += `<div class="tick-dot pending" style="animation:blink .5s ease-in-out infinite"></div>`;
    } else {
      html += `<div class="tick-dot pending"></div>`;
    }
  }
  el.innerHTML = html;
}

// ══════════════════════════════════════════════════════════
// AUTOMATED TICK COUNTER (ATC) ENGINE
// Wires into the existing live tick stream via atcTick()
// ══════════════════════════════════════════════════════════
var atcState = {
  auto: true,
  size: 15,
  round: 1,
  ticks: [],        // 'up'|'dn' for current round
  sessUp: 0,
  sessDn: 0,
  streak: 0,
  streakDir: null,
  history: [],
  paused: false,    // waiting between rounds
  cdTimer: null
};

function atcSetSize(n) {
  atcState.size = n;
  atcState.ticks = [];
  document.querySelectorAll('.atc-sz').forEach(function(b){
    b.classList.toggle('on', parseInt(b.textContent) === n);
  });
  $('atcTargetNum') && ($('atcTargetNum').textContent = n);
  atcRenderDots();
  atcUpdateProgress();
}

function atcToggle() {
  atcState.auto = !atcState.auto;
  var btn = $('atcToggleBtn');
  if (atcState.auto) {
    btn.textContent = '⏸ RUNNING';
    btn.classList.remove('paused');
    btn.classList.add('on');
    atcState.paused = false;
    atcSetRoundStatus('COUNTING...');
  } else {
    btn.textContent = '▶ RESUME';
    btn.classList.add('paused');
    btn.classList.remove('on');
    atcSetRoundStatus('PAUSED');
  }
}

function atcReset() {
  atcState.round = 1;
  atcState.ticks = [];
  atcState.sessUp = 0;
  atcState.sessDn = 0;
  atcState.streak = 0;
  atcState.streakDir = null;
  atcState.history = [];
  atcState.paused = false;
  clearTimeout(atcState.cdTimer);
  var flash = $('atcResultFlash');
  if (flash) flash.style.display = 'none';
  $('atcRoundNum') && ($('atcRoundNum').textContent = '1');
  $('atcSessUp') && ($('atcSessUp').textContent = '0');
  $('atcSessDn') && ($('atcSessDn').textContent = '0');
  $('atcSessRounds') && ($('atcSessRounds').textContent = '0');
  $('atcSessStreak') && ($('atcSessStreak').textContent = '—');
  $('atcHistScroll') && ($('atcHistScroll').innerHTML = '');
  atcRenderDots();
  atcUpdateProgress();
  atcUpdateBias();
  atcSetRoundStatus('WAITING FOR TICKS...');
  var ring = $('atcPulseRing');
  if (ring) ring.className = 'atc-pulse-ring idle';
}

function atcSetRoundStatus(txt) {
  var el = $('atcRoundStatus');
  if (el) el.textContent = txt;
}

// Called on every live tick from the main WS stream
function atcTick(price, prevPrice) {
  // Mirror price to hero display
  var heroPx = $('atcHeroPx');
  var pxEl = $('cPx');

  if (heroPx) {
    var fmt = typeof price === 'number' ? price.toFixed(2) : price;
    heroPx.textContent = fmt;
    var dir = price > prevPrice ? 'g' : 'r';
    heroPx.className = 'atc-hero-px ' + dir;
    setTimeout(function(){ if(heroPx) heroPx.className = 'atc-hero-px'; }, 350);
  }

  // Flash live price in topbar
  var lpx = $('cPx');
  if (lpx) {
    var fc = price > prevPrice ? 'flash-g' : 'flash-r';
    lpx.classList.add(fc);
    setTimeout(function(){ if(lpx) lpx.classList.remove(fc); }, 280);
  }

  // Pulse ring direction
  var ring = $('atcPulseRing');
  if (ring) ring.className = 'atc-pulse-ring ' + (price > prevPrice ? '' : 'dn');

  // Hero direction badge
  var hdir = $('atcHeroDir');
  if (hdir) {
    if (price > prevPrice) { hdir.textContent = '▲ RISING'; hdir.className = 'atc-hero-dir g'; }
    else { hdir.textContent = '▼ FALLING'; hdir.className = 'atc-hero-dir r'; }
  }

  if (!atcState.auto || atcState.paused) return;

  var d = price > prevPrice ? 'up' : 'dn';
  atcState.ticks.push(d);

  // Session totals
  if (d === 'up') atcState.sessUp++; else atcState.sessDn++;

  // Streak
  if (atcState.streakDir === d) { atcState.streak++; }
  else { atcState.streakDir = d; atcState.streak = 1; }

  $('atcSessUp') && ($('atcSessUp').textContent = atcState.sessUp);
  $('atcSessDn') && ($('atcSessDn').textContent = atcState.sessDn);
  $('atcSessStreak') && ($('atcSessStreak').textContent = atcState.streak + (d === 'up' ? '↑' : '↓'));
  $('atcCountedNum') && ($('atcCountedNum').textContent = atcState.ticks.length);
  atcSetRoundStatus(atcState.ticks.length + ' / ' + atcState.size + ' TICKS');

  atcRenderDots();
  atcUpdateProgress();
  atcUpdateBias();

  if (atcState.ticks.length >= atcState.size) {
    atcFinishRound();
  }
}

function atcFinishRound() {
  var ups = atcState.ticks.filter(function(t){ return t==='up'; }).length;
  var dns = atcState.ticks.filter(function(t){ return t==='dn'; }).length;
  var dir = ups > dns ? 'RISE' : ups < dns ? 'FALL' : 'NEUTRAL';
  var conf = Math.round(Math.max(ups, dns) / atcState.ticks.length * 100);

  // Notify bot
  atcBotOnRoundComplete(dir, conf);

  // Save to history
  atcState.history.unshift({
    round: atcState.round,
    ticks: atcState.ticks.slice(),
    dir: dir, conf: conf, ups: ups, dns: dns
  });
  if (atcState.history.length > 10) atcState.history.pop();
  $('atcSessRounds') && ($('atcSessRounds').textContent = atcState.round);

  // Show result flash
  var flash = $('atcResultFlash');
  if (flash) {
    flash.style.display = 'flex';
    flash.className = 'atc-result-flash ' + (dir === 'RISE' ? 'rise' : dir === 'FALL' ? 'fall' : '');
    var rfDir = $('atcRfDir');
    if (rfDir) rfDir.textContent = dir === 'RISE' ? '▲ RISE' : dir === 'FALL' ? '▼ FALL' : '◆ NEUTRAL';
    var rfStats = $('atcRfStats');
    if (rfStats) rfStats.textContent = ups + ' UP  /  ' + dns + ' DOWN  —  ' + conf + '% bias';
  }

  atcRenderHistory();
  atcSetRoundStatus('ROUND ' + atcState.round + ' DONE');

  // Countdown and auto-start next round
  atcState.paused = true;
  var cd = 3;
  var cdEl = $('atcRfCountdown');
  if (cdEl) cdEl.textContent = cd;
  atcState.cdTimer = setInterval(function() {
    cd--;
    if (cdEl) cdEl.textContent = Math.max(0, cd);
    if (cd <= 0) {
      clearInterval(atcState.cdTimer);
      atcState.round++;
      atcState.ticks = [];
      atcState.paused = false;
      if (flash) flash.style.display = 'none';
      $('atcRoundNum') && ($('atcRoundNum').textContent = atcState.round);
      $('atcCountedNum') && ($('atcCountedNum').textContent = '0');
      atcRenderDots();
      atcUpdateProgress();
      atcSetRoundStatus('COUNTING...');
    }
  }, 1000);
}

function atcRenderDots() {
  var area = $('atcDotsArea');
  if (!area) return;
  var total = atcState.size;
  var html = '';
  for (var i = 0; i < total; i++) {
    if (i < atcState.ticks.length) {
      var t = atcState.ticks[i];
      html += '<div class="atc-dot ' + t + '">' + (t==='up'?'▲':'▼') + '</div>';
    } else if (i === atcState.ticks.length && atcState.auto && !atcState.paused) {
      html += '<div class="atc-dot next"></div>';
    } else {
      html += '<div class="atc-dot pending"></div>';
    }
  }
  area.innerHTML = html;
}

function atcUpdateProgress() {
  var fill = $('atcProgressFill');
  if (!fill) return;
  var pct = atcState.size > 0 ? Math.min(100, atcState.ticks.length / atcState.size * 100) : 0;
  fill.style.width = pct + '%';
  $('atcTargetNum') && ($('atcTargetNum').textContent = atcState.size);
}

function atcUpdateBias() {
  var total = atcState.sessUp + atcState.sessDn || 1;
  var gPct = Math.round(atcState.sessUp / total * 100);
  var rPct = 100 - gPct;
  var bg = $('atcBiasG'), br = $('atcBiasR');
  var pg = $('atcBiasPctG'), pr = $('atcBiasPctR');
  if (bg) bg.style.width = gPct + '%';
  if (br) br.style.width = rPct + '%';
  if (pg) pg.textContent = gPct + '%';
  if (pr) pr.textContent = rPct + '%';
}

function atcRenderHistory() {
  var scroll = $('atcHistScroll');
  if (!scroll) return;
  scroll.innerHTML = atcState.history.map(function(h) {
    var dots = h.ticks.map(function(t){ return '<div class="atc-hr-dot ' + t + '"></div>'; }).join('');
    var cls = h.dir === 'RISE' ? 'rise' : h.dir === 'FALL' ? 'fall' : 'neut';
    var sym = h.dir === 'RISE' ? '▲ RISE' : h.dir === 'FALL' ? '▼ FALL' : '◆ NEUT';
    return '<div class="atc-hist-row">' +
      '<span class="atc-hr-round">#' + h.round + '</span>' +
      '<div class="atc-hr-dots">' + dots + '</div>' +
      '<span class="atc-hr-result ' + cls + '">' + sym + '</span>' +
      '<span class="atc-hr-conf">' + h.conf + '%</span>' +
    '</div>';
  }).join('');
}

// Init on DOM ready
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    atcRenderDots();
    atcUpdateProgress();
    atcUpdateBias();
    $('atcTargetNum') && ($('atcTargetNum').textContent = atcState.size);
    $('atcRoundNum') && ($('atcRoundNum').textContent = atcState.round);
    var ring = $('atcPulseRing');
    if (ring) ring.className = 'atc-pulse-ring idle';
    atcSetRoundStatus('WAITING FOR TICKS...');
  }, 300);
});
// ══════════════════════════════════════════════════════════


// ── LDP TOOL ──────────────────────
let ldpRunning = false;
let ldpLogLines = [];

function ldpLog(cls, text) {
  ldpLogLines = [{cls, text}, ...ldpLogLines].slice(0, 30);
  const el = $('ldpLog'); if (!el) return;
  el.innerHTML = ldpLogLines.map(e => `<div class="ldp-log-entry ${e.cls}">${e.text}</div>`).join('');
}

function runLDP() {
  if (ldpRunning) return;
  const btn = $('ldpRunBtn'); if (!btn) return;
  const market = $('ldpMarket')?.value || 'all';
  const contract = $('ldpContract')?.value || 'over_under';
  const samples = parseInt($('ldpSamples')?.value || 100);

  btn.classList.add('running'); btn.textContent = '⌛ SCANNING...';
  ldpRunning = true;
  const body = $('ldpBody');
  if (body) body.innerHTML = `<div class="ldp-idle"><div class="ldp-idle-icon" style="animation:spin 1s linear infinite">⚙️</div><div class="ldp-idle-title">SCANNING...</div><div class="ldp-idle-sub">Analysing ${samples} ticks across<br>${market === 'all' ? 'all 10 Volatility Indices' : MKT[market]?.d || market}</div></div>`;
  ldpLog('info', `▶ Scan started — ${market === 'all' ? 'All markets' : market} · ${contract} · ${samples} ticks`);

  const steps = ['Fetching digit data...', 'Computing LDP frequencies...', 'Analysing patterns...', 'Generating predictions...', 'Scoring setups...'];
  let si = 0;
  const stepIntvl = setInterval(() => {
    if (body && si < steps.length) {
      const titleEl = body.querySelector('.ldp-idle-title');
      if (titleEl) titleEl.textContent = steps[si++];
    }
  }, 250);

  setTimeout(() => {
    clearInterval(stepIntvl);
    btn.classList.remove('running'); btn.textContent = '▶ SCAN';
    ldpRunning = false;

    // Determine which markets to scan
    const markets = market === 'all' ? Object.keys(MKT) : [market];
    const results = markets.map(s => computeLDP(s, contract, samples)).filter(Boolean);
    results.sort((a,b) => b.conf - a.conf);

    if (body) {
      body.innerHTML = results.map(r => renderLDPCard(r, contract)).join('');
    }

    ldpLog('signal', `✓ Scan complete — ${results.length} markets · ${results.filter(r=>r.confLbl==='high').length} high-conf signals`);
    results.filter(r=>r.confLbl==='high').forEach(r =>
      ldpLog('signal', `[HIGH] ${r.sym} → ${r.action} · ${r.conf}%`)
    );
  }, 1800);
}

function computeLDP(s, contract, samples) {
  const m = MKT[s]; if (!m) return null;
  const p = tPx[s] || m.b;
  const chg = (p - m.b) / m.b * 100;

  // Simulate digit history for this market
  const digits = Array(10).fill(0).map(() => Math.round(samples / 10 + (Math.random() - 0.5) * samples * 0.25));
  const total = digits.reduce((a,b)=>a+b, 0) || 1;
  const pcts = digits.map(c => c / total * 100);

  let signal, action, reasoning;
  const overPct = pcts.slice(5).reduce((a,b)=>a+b, 0);
  const evenPct = [0,2,4,6,8].map(d=>pcts[d]).reduce((a,b)=>a+b, 0);
  const hotDigit = pcts.indexOf(Math.max(...pcts));
  const coldDigit = pcts.indexOf(Math.min(...pcts));

  if (contract === 'over_under') {
    signal = overPct > 52 ? 'bull' : overPct < 48 ? 'bear' : 'neut';
    action = overPct > 52 ? '▲ OVER ' + hotDigit : overPct < 48 ? '▼ UNDER ' + coldDigit : '◆ WAIT';
    reasoning = `Over: ${overPct.toFixed(1)}% · Under: ${(100-overPct).toFixed(1)}%`;
  } else if (contract === 'even_odd') {
    signal = evenPct > 52 ? 'bull' : evenPct < 48 ? 'bear' : 'neut';
    action = evenPct > 52 ? '⚖️ EVEN' : evenPct < 48 ? '⚡ ODD' : '◆ WAIT';
    reasoning = `Even: ${evenPct.toFixed(1)}% · Odd: ${(100-evenPct).toFixed(1)}%`;
  } else {
    signal = 'neut';
    action = `🎯 MATCHES ${hotDigit}`;
    reasoning = `Digit ${hotDigit} appears ${pcts[hotDigit].toFixed(1)}%`;
  }

  // LDP-specific metrics
  const rsi = 30 + Math.random() * 40 + (chg > 0 ? 10 : -10);
  const vol = Math.round(40 + Math.abs(chg) * 15 + Math.random() * 30);
  const trend = Math.round(35 + Math.abs(chg) * 12 + Math.random() * 35);
  const ldpConf = Math.round(Math.min(98, 45 + Math.abs(overPct-50)*2 + trend*0.2 + vol*0.15));
  const confLbl = ldpConf >= 72 ? 'high' : ldpConf >= 50 ? 'med' : 'low';

  return {sym: s, m, p, chg, signal, action, reasoning, rsi:Math.round(rsi), vol, trend, conf:ldpConf, confLbl, contract, pcts, hotDigit, coldDigit};
}

function renderLDPCard(r, contract) {
  const rsiColor = r.rsi > 65 ? '#f05252' : r.rsi < 35 ? '#05b169' : '#f7931a';
  const volColor = r.vol > 70 ? '#f05252' : r.vol > 45 ? '#f7931a' : '#05b169';
  const trendColor = r.trend > 60 ? '#05b169' : '#f7931a';
  const confColor = r.confLbl === 'high' ? '#05b169' : r.confLbl === 'med' ? '#f7931a' : '#f05252';
  return `<div class="ldp-card ${r.signal}">
    <div class="ldp-card-top">
      <div>
        <div class="ldp-sym">${r.m.n}</div>
        <div style="font-size:8px;color:var(--txt3);margin-top:2px">${r.m.d}</div>
      </div>
      <span class="ldp-signal ${r.signal}">${r.action}</span>
    </div>
    <div class="ldp-metrics">
      <div class="ldp-m"><div class="ldp-ml">RSI</div><div class="ldp-mv" style="color:${rsiColor}">${r.rsi}</div></div>
      <div class="ldp-m"><div class="ldp-ml">VOL</div><div class="ldp-mv" style="color:${volColor}">${r.vol}</div></div>
      <div class="ldp-m"><div class="ldp-ml">TREND</div><div class="ldp-mv" style="color:${trendColor}">${r.trend}%</div></div>
      <div class="ldp-m"><div class="ldp-ml">CONF</div><div class="ldp-mv" style="color:${confColor}">${r.conf}%</div></div>
    </div>
    <div class="ldp-bars">
      <div class="ldp-bar-row"><div class="ldp-bar-lbl">STRENGTH</div><div class="ldp-bar-track"><div class="ldp-bar-fill" style="width:${r.trend}%;background:${trendColor}"></div></div><div class="ldp-bar-val" style="color:${trendColor}">${r.trend}%</div></div>
      <div class="ldp-bar-row"><div class="ldp-bar-lbl">LDP CONF</div><div class="ldp-bar-track"><div class="ldp-bar-fill" style="width:${r.conf}%;background:${confColor}"></div></div><div class="ldp-bar-val" style="color:${confColor}">${r.conf}%</div></div>
    </div>
    <div style="font-size:8px;color:var(--txt3);margin-bottom:8px;font-family:'JetBrains Mono',monospace">${r.reasoning}</div>
    <div class="ldp-foot">
      <span class="ldp-price">${fp(r.p)} <span style="color:${r.chg>=0?'var(--green)':'var(--red)'}">${r.chg>=0?'+':''}${r.chg.toFixed(3)}%</span></span>
      <div style="display:flex;gap:5px;align-items:center">
        <span class="ldp-conf-badge ${r.confLbl}">${r.confLbl.toUpperCase()}</span>
        <button class="ldp-trade-btn" onclick="selMkt('${r.sym}');goCol('col-trade');toast('⚡','Trading',MKT['${r.sym}']?.n||'${r.sym}')">⚡ TRADE</button>
      </div>
    </div>
  </div>`;
}

// ── DTRADER INTERNAL ──────────────
let dtSelType_val = 'rise_fall';

function dtSelType(type, btn) {
  dtSelType_val = type;
  document.querySelectorAll('.dtt-card').forEach(b => b.classList.remove('sel'));
  if (btn) btn.classList.add('sel');
  const digitSel = $('dtDigitSel');
  if (digitSel) digitSel.style.display = ['over_under','matches_differs'].includes(type) ? 'block' : 'none';
  const execBtns = $('dtExecBtns');
  if (execBtns) {
    if (type === 'rise_fall') {
      execBtns.innerHTML = `<button class="dt-exec-rise" onclick="dtTrade('rise')">▲ RISE</button><button class="dt-exec-fall" onclick="dtTrade('fall')">▼ FALL</button>`;
    } else if (type === 'even_odd') {
      execBtns.innerHTML = `<button class="dt-exec-rise" onclick="dtTrade('even')">⚖️ EVEN</button><button class="dt-exec-fall" onclick="dtTrade('odd')">⚡ ODD</button>`;
    } else if (type === 'over_under') {
      execBtns.innerHTML = `<button class="dt-exec-rise" onclick="dtTrade('over')">▲ OVER ${dtSelectedDigit}</button><button class="dt-exec-fall" onclick="dtTrade('under')">▼ UNDER ${dtSelectedDigit}</button>`;
    } else {
      execBtns.innerHTML = `<button class="dt-exec-rise" onclick="dtTrade('matches')">🎯 MATCHES</button><button class="dt-exec-fall" onclick="dtTrade('differs')">✗ DIFFERS</button>`;
    }
  }
  calcDTPay();
}

let dtDur = 1;
function dtSelDur(d, btn) {
  dtDur = d;
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  calcDTPay();
}

function calcDTPay() {
  const stake = parseFloat($('dtStake')?.value || 10);
  const payoutRates = {'rise_fall':0.95,'over_under':0.85,'even_odd':0.9,'matches_differs':0.9};
  const rate = payoutRates[dtSelType_val] || 0.95;
  const payout = stake * (1 + rate);
  const profit = payout - stake;
  const profitPct = (rate * 100).toFixed(0);
  const dp = $('dtPayout'), dpr = $('dtProfit');
  if (dp) dp.textContent = '$' + payout.toFixed(2);
  if (dpr) dpr.textContent = profitPct + '%';
}

function dtTrade(direction) {
  const stake = parseFloat($('dtStake')?.value || 10);
  if (!stake || stake < 0.35) { toast('⚠️','Min Stake','Minimum stake is $0.35'); return; }

  const typeMap = {
    'rise': 'CALL', 'fall': 'PUT',
    'even': 'DIGITEVEN', 'odd': 'DIGITODD',
    'over': 'DIGITOVER', 'under': 'DIGITUNDER',
    'matches': 'DIGITMATCH', 'differs': 'DIGITDIFF',
  };
  const ct = typeMap[direction] || 'CALL';
  const needsBarrier = ['DIGITOVER','DIGITUNDER','DIGITMATCH','DIGITDIFF'].includes(ct);
  const dur = dtDuration || 5;

  if (wsConn && authed) {
    const proposalParams = {
      proposal: 1,
      amount: stake,
      basis: 'stake',
      contract_type: ct,
      currency: 'USD',
      symbol: sym,
      duration: dur,
      duration_unit: 't',
      ...(needsBarrier ? {barrier: String(dtSelectedDigit || 5)} : {}),
    };
    window._pendingTrade = { stake, ct, dir: direction };
    wsSend(proposalParams);
    toast('⏳','DTrader Quote...', `${ct} · $${stake}`);
  } else {
    // Demo simulate
    const isWin = Math.random() > 0.45;
    const payoutRate = 0.92;
    const pnl = isWin ? stake * payoutRate : -stake;
    dtTrades++; if (isWin) dtWins++;
    dtPnl += pnl;
    const setEl = (id, v) => { const e=$(id); if(e) e.textContent=v; };
    setEl('dtPnl', (dtPnl>=0?'+':'') + '$' + dtPnl.toFixed(2));
    const dtPnlEl = $('dtPnl'); if(dtPnlEl) dtPnlEl.style.color = dtPnl>=0?'var(--green)':'var(--red)';
    setEl('dtWr', dtTrades ? Math.round(dtWins/dtTrades*100)+'%' : '—');
    setEl('dtTrades', dtTrades); setEl('dtWins', dtWins);
    const t = {id: Date.now(), sym, type: direction, dir: direction, stake, entry: px,
      time: new Date().toLocaleTimeString(), status: isWin ? 'won' : 'lost', pnl};
    trades.unshift(t); cnt++;
    if (isWin) { wins++; } proft += pnl; totals++;
    updStats(); updJournal();
    toast(isWin?'🏆':'❌', `DTrader ${isWin?'Won!':'Lost'}`, `${direction.toUpperCase()} · ${isWin?'+$':'−$'}${Math.abs(pnl).toFixed(2)}`);
  }
}

// ── DBOT INTERNAL ─────────────────
let dbConsec = 0;

function toggleDBot() {
  dbRunning = !dbRunning;
  const btn = $('dbStartBtn'), dot = $('dbDot'), status = $('dbStatus');
  if (dbRunning) {
    if (btn) { btn.textContent = '⏹ STOP BOT'; btn.classList.add('stopping'); }
    if (dot) { dot.classList.remove('stop'); dot.classList.add('run'); }
    if (status) status.textContent = 'RUNNING';
    toast('🤖','DBot Started', 'Bot is now executing trades');
  } else {
    if (btn) { btn.textContent = '▶ START BOT'; btn.classList.remove('stopping'); }
    if (dot) { dot.classList.remove('run'); dot.classList.add('stop'); }
    if (status) status.textContent = 'STOPPED';
    toast('⏹','DBot Stopped', `${dbTrades} trades · P&L: ${dbPnl>=0?'+':''}$${dbPnl.toFixed(2)}`);
  }
}

function runDBotTick() {
  if (!dbRunning) return;
  if (Math.random() > 0.95) {
    const stake = parseFloat($('dbStake')?.value || 10);
    const isWin = Math.random() > 0.44;
    const pnl = isWin ? stake * 0.9 : -stake;
    dbTrades++; if (isWin) dbWins++;
    dbPnl += pnl;
    if (!isWin) dbConsec++; else dbConsec = 0;

    const setEl = (id, v) => { const e=$(id); if(e) e.textContent=v; };
    setEl('dbTrades', dbTrades);
    setEl('dbWins', dbWins);
    const pnlStr = (dbPnl>=0?'+':'') + '$' + dbPnl.toFixed(2);
    setEl('dbPnl', pnlStr);
    const dbPnlEl = $('dbPnl'); if(dbPnlEl) dbPnlEl.style.color = dbPnl>=0?'var(--green)':'var(--red)';
    setEl('dbWr', dbTrades ? Math.round(dbWins/dbTrades*100)+'%' : '—');

    const lossLimit = parseInt($('dbLossLimit')?.value || 50);
    const consecStop = parseInt($('dbConsec')?.value || 5);
    if (dbPnl < -lossLimit || dbConsec >= consecStop) {
      emergencyStopDBot();
      toast('🛑','DBot Auto-Stop', dbConsec >= consecStop ? `${dbConsec} consecutive losses` : `Loss limit reached`);
    }
  }
}

function emergencyStopDBot() {
  dbRunning = false;
  const btn = $('dbStartBtn'), dot = $('dbDot'), status = $('dbStatus');
  if (btn) { btn.textContent = '▶ START BOT'; btn.classList.remove('stopping'); }
  if (dot) { dot.classList.remove('run'); dot.classList.add('stop'); }
  if (status) status.textContent = 'STOPPED';
  toast('🔴','Emergency Stop', 'All bot activity halted');
}

// ── TRADING ───────────────────────
function setContract(type, btn) {
  contractMode = type;
  document.querySelectorAll('.ctb-pill').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');

  // Show/hide relevant exec panels
  const rfExec = $('rfExec'), eoExec = $('eoExec'), mdExec = $('mdExec'), digitSect = $('digitSect');
  if (rfExec) rfExec.style.display = 'none';
  if (eoExec) eoExec.style.display = 'none';
  if (mdExec) mdExec.style.display = 'none';
  if (digitSect) digitSect.style.display = 'none';

  const execBtn = $('execBtn');
  if (type === 'rise_fall') {
    if (rfExec) rfExec.style.display = 'block';
  } else if (type === 'over_under') {
    if (rfExec) rfExec.style.display = 'block'; // up=over, down=under
    if (digitSect) digitSect.style.display = 'block';
    if ($('digitSectLbl')) $('digitSectLbl').textContent = 'SELECT DIGIT (Over/Under boundary)';
    const upBtn = $('tabBuy'), dnBtn = $('tabSell');
    if (upBtn) upBtn.textContent = '▲ OVER';
    if (dnBtn) dnBtn.textContent = '▼ UNDER';
    if (execBtn) execBtn.textContent = '⚡ EXECUTE OVER/UNDER';
  } else if (type === 'even_odd') {
    if (eoExec) eoExec.style.display = 'block';
  } else if (type === 'matches_differs') {
    if (mdExec) mdExec.style.display = 'block';
    if (digitSect) digitSect.style.display = 'block';
    if ($('digitSectLbl')) $('digitSectLbl').textContent = 'SELECT DIGIT TO MATCH/DIFFER';
  }
  calcPay();
}

function selDir(dir, btn) {
  selectedDir = dir;
  document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('sel'));
  if (btn) btn.classList.add('sel');
}

function setStk(v) { $('stakeV').value = v; calcPay(); }
const payoutRates = {'rise_fall':0.95,'over_under':0.85,'even_odd':0.9,'matches_differs':0.9};
function calcPay() {
  const stake = parseFloat($('stakeV')?.value || 10);
  const rate = payoutRates[contractMode] || 0.95;
  const payout = stake * (1 + rate);
  const p = $('payV'), pp = $('profitPct');
  if (p) p.textContent = '$' + payout.toFixed(2);
  if (pp) pp.textContent = (rate * 100).toFixed(0) + '%';
}

function doTrade() {
  const stake = parseFloat($('stakeV')?.value || 10);
  if (!stake || stake < 0.35) { toast('⚠️','Min Stake','Minimum stake is $0.35'); return; }
  const dur = parseInt($('durV')?.value || 5);
  const unit = $('durUnit')?.value || 't';
  const isRise = selectedDir === 'buy';
  const ct = contractMode === 'rise_fall' ? (isRise ? 'CALL' : 'PUT') :
             contractMode === 'over_under' ? (isRise ? 'DIGITOVER' : 'DIGITUNDER') : 'CALL';

  if (wsConn && authed) {
    // Step 1: Get proposal first, then buy
    const durSec = unit === 'm' ? dur * 60 : unit === 's' ? dur : null;
    const proposalParams = {
      proposal: 1,
      amount: stake,
      basis: 'stake',
      contract_type: ct,
      currency: 'USD',
      symbol: sym,
      ...(durSec ? {duration: durSec, duration_unit: 's'} : {duration: dur, duration_unit: 't'}),
      ...(contractMode === 'over_under' ? {barrier: String(selectedDigit)} : {}),
    };
    // Store pending trade info for when proposal response arrives
    window._pendingTrade = { stake, ct, dir: isRise ? 'CALL' : 'PUT' };
    wsSend(proposalParams);
    toast('⏳','Getting Quote...', `${ct} · $${stake}`);
  } else {
    simulateTrade(stake, isRise ? 'CALL' : 'PUT');
  }
}

function doDigitTrade(type) {
  const stake = parseFloat($('stakeV')?.value || 10);
  if (!stake || stake < 0.35) { toast('⚠️','Min Stake','Minimum stake is $0.35'); return; }

  const ctMap = {
    'even': 'DIGITEVEN', 'odd': 'DIGITODD',
    'over': 'DIGITOVER', 'under': 'DIGITUNDER',
    'matches': 'DIGITMATCH', 'differs': 'DIGITDIFF'
  };
  const ct = ctMap[type] || 'DIGITEVEN';
  const needsBarrier = ['DIGITOVER','DIGITUNDER','DIGITMATCH','DIGITDIFF'].includes(ct);

  if (wsConn && authed) {
    const proposalParams = {
      proposal: 1,
      amount: stake,
      basis: 'stake',
      contract_type: ct,
      currency: 'USD',
      symbol: sym,
      duration: 5,
      duration_unit: 't',
      ...(needsBarrier ? {barrier: String(selectedDigit)} : {}),
    };
    window._pendingTrade = { stake, ct, dir: type };
    wsSend(proposalParams);
    toast('⏳','Getting Quote...', `${ct} · $${stake}`);
  } else {
    simulateTrade(stake, type);
  }
}

function simulateTrade(stake, dir) {
  const isWin = Math.random() > 0.45;
  const pnl = isWin ? stake * 0.92 : -stake;
  const t = {id: Date.now(), sym, type: contractMode, dir, stake, entry: px,
    time: new Date().toLocaleTimeString(), status: isWin ? 'won' : 'lost', pnl};
  trades.unshift(t); cnt++;
  if (isWin) { wins++; consecWin++; consecLoss = 0; } else { consecLoss++; consecWin = 0; }
  totals++; proft += pnl;
  updStats(); updJournal();
  toast(isWin?'🏆':'❌', `Trade ${isWin?'Won!':'Lost'}`, `${dir.toUpperCase()} · ${isWin?'+$':'-$'}${Math.abs(pnl).toFixed(2)}`);
}

function checkRiskLimits() {
  if (consecLoss >= 5) toast('⚠️','Risk Alert','5 consecutive losses!');
}

function updStats() {
  const wr = totals ? Math.round(wins/totals*100) : null;
  const set = (id, v, col) => { const e=$(id); if(!e) return; e.textContent=v; if(col) e.style.color=col; };
  set('pnlV', (proft>=0?'+':'')+proft.toFixed(2), proft>=0?'var(--green)':'var(--red)');
  set('wrV', wr !== null ? wr+'%' : '—');
  set('cntV', totals);
  const streak = consecWin > 0 ? '🔥 '+consecWin+'W' : consecLoss > 0 ? '❄️ '+consecLoss+'L' : '—';
  set('streakV', streak);
}

function updJournal() {
  const wr = totals ? Math.round(wins/totals*100) : null;
  const gross_w = trades.filter(t=>t.pnl>0).reduce((a,t)=>a+t.pnl,0);
  const gross_l = Math.abs(trades.filter(t=>t.pnl<0).reduce((a,t)=>a+t.pnl,0));
  const pf = gross_l ? (gross_w / gross_l).toFixed(2) : '∞';

  const set = (id, v) => { const e=$(id); if(e) e.textContent=v; };
  const setG = (id, v, g) => { const e=$(id); if(!e) return; e.textContent=v; e.className='an-val '+(g?'g':'r'); };
  setG('jPnl', (proft>=0?'+$':'-$')+Math.abs(proft).toFixed(2), proft>=0);
  set('jWr', wr !== null ? wr+'%' : '—');
  set('jWrSub', `${wins}/${totals} trades`);
  set('jPf', pf);
  set('jDd', drawdown.toFixed(1)+'%');
  set('jBest', sym);
  set('jTotal', totals);

  const tbody = $('journalTbl'); if (!tbody) return;
  tbody.innerHTML = trades.slice(0,30).map(t =>
    `<tr><td>#${String(t.id).slice(-5)}</td><td>${t.sym||sym}</td><td style="font-size:7px">${t.type||'RF'}</td><td>$${t.stake.toFixed(2)}</td>
    <td style="color:${t.pnl>=0?'var(--green)':'var(--red)'}">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</td>
    <td><span class="badge ${t.status}">${t.status.toUpperCase()}</span></td><td>${t.time}</td></tr>`
  ).join('') || '<tr><td colspan="7" class="epty">No trades yet</td></tr>';
}

function exportCSV() {
  const rows = [['ID','Market','Type','Dir','Stake','PnL','Status','Time'],
    ...trades.map(t => [t.id, t.sym||sym, t.type, t.dir, t.stake, t.pnl.toFixed(2), t.status, t.time])];
  const csv = rows.map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'rerrmytrades_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

// ── AUTH ──────────────────────────
// ── Deriv OAuth flow ──────────────────────────────────────
const REDIRECT_URI = 'https://rerrmytrades.vercel.app';
const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN&brand=deriv`;

function doOAuth() {
  // Store flag so we know we're mid-OAuth on return
  sessionStorage.setItem('rmt-oauth-pending', '1');
  // Redirect to Deriv OAuth — user logs in, grants permissions,
  // then Deriv sends them to REDIRECT_URI?token1=...&acct1=...
  window.location.href = OAUTH_URL;
}

function readOAuthTokenFromURL() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token1'); // Deriv always sends token1 for primary account
  const acct  = params.get('acct1');
  const cur   = params.get('cur1');
  if (!token) return;

  // Clean the URL immediately so tokens don't stay in browser history
  const cleanUrl = window.location.pathname;
  window.history.replaceState({}, document.title, cleanUrl);

  // Persist and authorize
  tok = token;
  localStorage.setItem('rmt-tok', tok);
  if (acct) localStorage.setItem('rmt-acct', acct);
  if (cur)  localStorage.setItem('rmt-cur', cur);
  sessionStorage.removeItem('rmt-oauth-pending');

  toast('🔑', 'Token received', acct ? `Account: ${acct}` : 'Connecting...');
  // connectWS will see tok is set and authorize automatically on open
  if (ws && ws.readyState === 1) {
    wsSend({authorize: tok});
  } else {
    connectWS();
  }
}

function doAuth() {
  const t = $('apiTok')?.value?.trim();
  if (!t) { toast('❌','Error','Paste your API token or use the Connect button'); return; }
  tok = t;
  localStorage.setItem('rmt-tok', tok); // persist across reloads
  if (ws && ws.readyState === 1) {
    wsSend({authorize: tok});
  } else {
    connectWS();
  }
  toast('⏳','Connecting...','Authorizing with Deriv...');
}

function doDisconnect() {
  tok = null;
  authed = false;
  localStorage.removeItem('rmt-tok');
  const inp = $('apiTok'); if (inp) inp.value = '';
  const btn = $('btnApi'); if (btn) { btn.textContent = '🔑 CONNECT API'; btn.classList.remove('live'); }
  const chip = $('balChip'); if (chip) chip.style.display = 'none';
  const stat = $('balStat'); if (stat) stat.style.display = 'none';
  const banner = $('banner'); if (banner) banner.style.display = 'block';
  closeModal();
  toast('🔓','Disconnected','Switched to demo mode');
}

// ── DERIV CHART IFRAME INTEGRATION ─────────────────────────────────────
// Map Deriv API symbols → TradingView symbols used by charts.deriv.com
const DERIV_TV_SYMBOLS = {
  'R_10':     'Volatility 10 Index',
  'R_25':     'Volatility 25 Index',
  'R_50':     'Volatility 50 Index',
  'R_75':     'Volatility 75 Index',
  'R_100':    'Volatility 100 Index',
  '1HZ10V':  'Volatility 10 (1s) Index',
  '1HZ25V':  'Volatility 25 (1s) Index',
  '1HZ50V':  'Volatility 50 (1s) Index',
  '1HZ75V':  'Volatility 75 (1s) Index',
  '1HZ100V': 'Volatility 100 (1s) Index',
};

// Chart mode: 'local' = lightweight chart, 'deriv' = charts.deriv.com iframe
let chartMode = 'local';
let derivChartLoaded = false;

function setChartMode(mode, btn) {
  chartMode = mode;
  // Update tab buttons
  document.querySelectorAll('#col-chart .tf-bar .ct-btn[id^="chart-mode-"]').forEach(b => {
    b.classList.remove('on');
    b.style.background = '';
    b.style.color = '';
    b.style.borderColor = '';
  });
  if (btn) {
    btn.classList.add('on');
    if (mode === 'deriv') {
      btn.style.background = 'rgba(5,177,105,0.2)';
      btn.style.color = 'var(--cyan)';
      btn.style.borderColor = 'rgba(5,177,105,0.5)';
    }
  }

  const derivWrap = $('derivChartWrap');
  const localWrap = $('tvChartWrap');
  const localOpts = $('local-chart-opts');
  const localOvls = $('local-overlay-opts');
  const localSep = $('local-overlay-sep');

  if (mode === 'deriv') {
    if (derivWrap) { derivWrap.style.display = 'flex'; derivWrap.style.flexDirection = 'column'; }
    if (localWrap) localWrap.style.display = 'none';
    if (localOpts) localOpts.style.display = 'none';
    if (localOvls) localOvls.style.display = 'none';
    if (localSep) localSep.style.display = 'none';
    if (derivWrap) loadDerivChart(sym);
  } else {
    if (derivWrap) derivWrap.style.display = 'none';
    if (localWrap) localWrap.style.display = 'block';
    if (localOpts) localOpts.style.display = 'flex';
    if (localOvls) localOvls.style.display = 'flex';
    if (localSep) localSep.style.display = 'block';
    // Resize local chart
    setTimeout(() => {
      if (tvChart) {
        const c = $('tvChart');
        if (c) tvChart.resize(c.offsetWidth, c.offsetHeight);
      }
    }, 50);
  }
}

function loadDerivChart(s) {
  // charts.deriv.com cannot be embedded (X-Frame-Options).
  // Best solution: open it in a popup window so users get the full Deriv chart experience.
  // Meanwhile show the live local chart (already connected to Deriv WebSocket).
  const m = MKT[s];
  const tvName = DERIV_TV_SYMBOLS[s] || (m ? m.d : s);
  const chartUrl = `https://charts.deriv.com/deriv?symbol=${encodeURIComponent(s)}&theme=dark`;

  // Hide iframe, show local chart in deriv wrap
  const frame = $('derivChartFrame');
  if (frame) frame.style.display = 'none';

  const loader = $('derivChartLoader');
  if (loader) loader.style.display = 'none';

  // Remove old fallback
  const old = $('derivChartFallback');
  if (old) old.remove();

  // Build an info panel + embedded lightweight chart (real Deriv WS data)
  const fallback = document.createElement('div');
  fallback.id = 'derivChartFallback';
  fallback.style.cssText = 'position:absolute;inset:0;z-index:5;display:flex;flex-direction:column;background:var(--bg)';
  const _dcw = $('derivChartWrap'); if (!_dcw) return; _dcw.appendChild(fallback);

  fallback.innerHTML = `
    <div style="padding:5px 12px;background:rgba(5,177,105,0.06);border-bottom:1px solid rgba(5,177,105,0.15);
      display:flex;align-items:center;gap:8px;flex-shrink:0">
      <div style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 1.5s ease-in-out infinite;flex-shrink:0"></div>
      <span style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--cyan);font-weight:700;letter-spacing:1px;flex:1">${tvName} — LIVE</span>
      <button onclick="window.open('https://charts.deriv.com/deriv?symbol=${encodeURIComponent(s)}&theme=dark','derivchart','width=1200,height=700,resizable=yes,scrollbars=yes')"
        style="padding:3px 10px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;
        cursor:pointer;border:1px solid rgba(5,177,105,0.35);background:rgba(5,177,105,0.08);color:var(--cyan);
        letter-spacing:.5px;white-space:nowrap;transition:all .15s"
        onmouseover="this.style.background='rgba(5,177,105,0.18)'" onmouseout="this.style.background='rgba(5,177,105,0.08)'">
        📊 Open Deriv Chart ↗
      </button>
    </div>
    <div id="derivLocalChart" style="flex:1;min-height:0;position:relative"></div>`;

  // Init a second lightweight chart inside the deriv wrap using real WS data
  const chartEl = fallback.querySelector('#derivLocalChart');
  if (!chartEl || typeof LightweightCharts === 'undefined') return;

  // Create chart
  const dc = LightweightCharts.createChart(chartEl, {
    width: chartEl.offsetWidth,
    height: chartEl.offsetHeight,
    layout: { background: { type: 'solid', color: '#151717' }, textColor: '#999999' },
    grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    crosshair: { mode: 1, vertLine: { color: 'rgba(0,82,255,0.6)', labelBackgroundColor: '#0052ff' },
                 horzLine: { color: 'rgba(0,82,255,0.5)', labelBackgroundColor: '#0052ff' } },
    rightPriceScale: { borderColor: 'rgba(5,177,105,0.15)', scaleMargins: { top: 0.1, bottom: 0.1 } },
    timeScale: { borderColor: 'rgba(5,177,105,0.15)', timeVisible: true, secondsVisible: true },
    handleScroll: true, handleScale: true,
  });

  // Add candlestick series
  const dcSeries = dc.addCandlestickSeries({
    upColor: '#05b169', downColor: '#f05252',
    borderUpColor: '#05b169', borderDownColor: '#f05252',
    wickUpColor: 'rgba(5,177,105,0.7)', wickDownColor: 'rgba(240,82,82,0.7)',
  });

  // Load existing ohlc data
  if (ohlc.length > 1) {
    const seen = new Set();
    const data = ohlc
      .filter(c => { if (seen.has(c.e)) return false; seen.add(c.e); return true; })
      .sort((a, b) => a.e - b.e)
      .map(c => ({ time: c.e, open: c.o, high: c.h, low: c.l, close: c.c }));
    try { dcSeries.setData(data); dc.timeScale().fitContent(); } catch(e) {}
  }

  // Store refs for live updates
  window._derivChart = dc;
  window._derivSeries = dcSeries;

  // Resize observer
  const ro = new ResizeObserver(() => {
    if (dc && chartEl) dc.resize(chartEl.offsetWidth, chartEl.offsetHeight);
  });
  ro.observe(chartEl);
  window._derivChartRO = ro;
}

// Live-update the deriv panel chart too
const _origTvChartUpdateCandle = tvChartUpdateCandle;

function showDerivFallback(s, tvName) { loadDerivChart(s); }

// Update Deriv chart when market changes
function updateDerivChart(s) {
  if (chartMode !== 'deriv') return;
  // Cleanup old deriv chart
  if (window._derivChart) { try { window._derivChart.remove(); } catch(e) {} window._derivChart = null; window._derivSeries = null; }
  if (window._derivChartRO) { window._derivChartRO.disconnect(); window._derivChartRO = null; }
  loadDerivChart(s);
}


let tvChart = null;
let tvSeries = null;
let tvVolSeries = null;
let tvEmaSeries = null;
let tvBbUpper = null;
let tvBbLower = null;
let tvTickSeries = null;
let chartType = 'candle';
let overlays = {ema: false, bb: false, vol: false};
let tickEpochs = [];       // epoch timestamps for live tick data
let tickTimestamps = [];   // for tick rate calculation

// Live chart update — tick mode
function tvChartUpdateTick(price, epoch) {
  if (!tvTickSeries) return;
  try {
    tvTickSeries.update({ time: epoch, value: price });
  } catch(e) {}
  _trackTickRate();
}

// Live chart update — candle mode
function tvChartUpdateCandle(candle) {
  if (!tvSeries || !candle) return;
  try {
    const update = chartType === 'candle'
      ? { time: candle.e, open: candle.o, high: candle.h, low: candle.l, close: candle.c }
      : { time: candle.e, value: candle.c };
    tvSeries.update(update);

    // Also update overlays live
    if (overlays.ema && tvEmaSeries && ohlc.length >= 20) {
      const closes = ohlc.map(c => c.c);
      const emas = calcEMA(closes, 20);
      const lastEma = emas[emas.length - 1];
      if (lastEma) try { tvEmaSeries.update({ time: candle.e, value: lastEma }); } catch(e) {}
    }
  } catch(e) {}

  // Mirror live updates to the deriv panel chart
  if (window._derivSeries && chartMode === 'deriv') {
    try {
      window._derivSeries.update({ time: candle.e, open: candle.o, high: candle.h, low: candle.l, close: candle.c });
    } catch(e) {}
  }

  _trackTickRate();
}

function _trackTickRate() {
  tickTimestamps.push(Date.now());
  tickTimestamps = tickTimestamps.filter(t => Date.now() - t < 5000);
  const tps = (tickTimestamps.length / 5).toFixed(1);
  const el = $('indTps'); if (el) el.textContent = tps + '/s';
}

const TV_THEME = {
  layout: { background: { type: 'solid', color: '#151717' }, textColor: '#999999' },
  grid:   { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
  crosshair: { mode: 1,
    vertLine: { color: 'rgba(0,82,255,0.6)', labelBackgroundColor: '#0052ff', width: 1, style: 2 },
    horzLine: { color: 'rgba(0,82,255,0.5)', labelBackgroundColor: '#0052ff', width: 1, style: 2 } },
  rightPriceScale: { borderColor: 'rgba(255,255,255,0.06)', scaleMargins: { top: 0.08, bottom: 0.08 } },
  timeScale: { borderColor: 'rgba(255,255,255,0.06)', timeVisible: true, secondsVisible: true },
};

function initTVChart() {
  const container = document.getElementById('tvChart');
  if (!container || typeof LightweightCharts === 'undefined') {
    console.warn('LightweightCharts not loaded yet, retrying...');
    setTimeout(initTVChart, 500);
    return;
  }

  // Destroy old chart if exists
  if (tvChart) { try { tvChart.remove(); } catch(e){} }
  tvSeries = null; tvVolSeries = null; tvEmaSeries = null;
  tvBbUpper = null; tvBbLower = null; tvTickSeries = null;

  tvChart = LightweightCharts.createChart(container, {
    width: container.offsetWidth,
    height: container.offsetHeight,
    layout:          TV_THEME.layout,
    grid:            TV_THEME.grid,
    crosshair:       TV_THEME.crosshair,
    rightPriceScale: TV_THEME.rightPriceScale,
    timeScale:       TV_THEME.timeScale,
    handleScroll: true,
    handleScale: true,
  });

  // Subscribe to crosshair for OHLC overlay
  tvChart.subscribeCrosshairMove(param => {
    if (!param || !param.time) return;
    const activeSeries = tvSeries || tvTickSeries;
    if (!activeSeries) return;
    const data = param.seriesData.get(activeSeries);
    if (!data) return;
    const isCandle = chartType === 'candle' && tf !== '1T';
    const o = isCandle ? data.open  : data.value;
    const h = isCandle ? data.high  : data.value;
    const l = isCandle ? data.low   : data.value;
    const c = isCandle ? data.close : data.value;
    if (o == null && c == null) return;
    const chgPct = o ? ((c - o) / o * 100) : 0;
    const up = c >= (o || c);
    const setEl = (id, v, col) => { const e = $(id); if(e){ e.textContent = v; if(col) e.style.color = col; } };
    setEl('ohlcO', isCandle ? fp(o) : '—');
    setEl('ohlcH', isCandle ? fp(h) : '—', 'var(--green)');
    setEl('ohlcL', isCandle ? fp(l) : '—', 'var(--red)');
    setEl('ohlcC', fp(c), up ? 'var(--green)' : 'var(--red)');
    setEl('ohlcChg', isCandle ? ((up ? '+' : '') + chgPct.toFixed(3) + '%') : fp(c), up ? 'var(--green)' : 'var(--red)');
  });

  // Resize observer
  const resizeObserver = new ResizeObserver(entries => {
    for (const entry of entries) {
      const { width, height } = entry.contentRect;
      if (tvChart && width > 0 && height > 0) tvChart.resize(width, height);
    }
  });
  resizeObserver.observe(container);

  buildMainSeries();
  hideChartLoader();
}

function buildMainSeries() {
  if (!tvChart) return;

  // Remove old series safely
  const removeSeries = s => { try { if (s) tvChart.removeSeries(s); } catch(e){} };
  removeSeries(tvSeries); removeSeries(tvVolSeries); removeSeries(tvEmaSeries);
  removeSeries(tvBbUpper); removeSeries(tvBbLower); removeSeries(tvTickSeries);
  tvSeries = null; tvVolSeries = null; tvEmaSeries = null;
  tvBbUpper = null; tvBbLower = null; tvTickSeries = null;

  if (tf === '1T') {
    // Tick mode — line series, no candles
    tvTickSeries = tvChart.addLineSeries({
      color: '#0052ff',
      lineWidth: 2,
      crosshairMarkerVisible: true,
      crosshairMarkerRadius: 4,
      crosshairMarkerBackgroundColor: '#0052ff',
      priceLineVisible: true,
      priceLineWidth: 1,
      priceLineColor: '#0052ff',
      priceLineStyle: 2,
      lastValueVisible: true,
    });
    loadTickData();
    return;
  }

  if (chartType === 'candle') {
    tvSeries = tvChart.addCandlestickSeries({
      upColor:          '#05b169',
      downColor:        '#f05252',
      borderUpColor:    '#05b169',
      borderDownColor:  '#f05252',
      wickUpColor:      'rgba(5,177,105,0.7)',
      wickDownColor:    'rgba(240,82,82,0.7)',
    });
  } else if (chartType === 'line') {
    tvSeries = tvChart.addLineSeries({
      color: '#0052ff',
      lineWidth: 2,
      crosshairMarkerVisible: true,
      lastValueVisible: true,
      priceLineColor: '#0052ff',
    });
  } else { // area
    tvSeries = tvChart.addAreaSeries({
      topColor:    'rgba(0,82,255,0.3)',
      bottomColor: 'rgba(139,92,246,0)',
      lineColor:   '#0052ff',
      lineWidth: 2,
      lastValueVisible: true,
    });
  }

  // Volume histogram (as small panel via price scale)
  if (overlays.vol) {
    tvVolSeries = tvChart.addHistogramSeries({
      color: 'rgba(255,255,255,0.16)',
      priceFormat: { type: 'volume' },
      priceScaleId: 'vol',
      scaleMargins: { top: 0.8, bottom: 0 },
    });
  }

  loadOHLCData();
}

function loadTickData() {
  if (!tvTickSeries) return;
  // Use real epoch timestamps if we have them, else estimate
  const hasEpochs = tickEpochs.length === ticks.length && tickEpochs.length > 0;
  const now = Math.floor(Date.now() / 1000);
  const seen = new Set();
  const data = ticks.map((v, i) => {
    const t = hasEpochs ? tickEpochs[i] : (now - (ticks.length - 1 - i));
    return { time: t, value: v };
  }).filter(d => d.value > 0 && !seen.has(d.time) && seen.add(d.time))
    .sort((a, b) => a.time - b.time);

  if (data.length > 1) {
    try { tvTickSeries.setData(data); tvChart.timeScale().fitContent(); } catch(e) {}
  }
}

function loadOHLCData() {
  if (!tvSeries || !ohlc.length) return;

  const toTV = c => {
    const base = { time: c.e };
    if (chartType === 'candle') return { ...base, open: c.o, high: c.h, low: c.l, close: c.c };
    return { ...base, value: c.c };
  };

  // Deduplicate & sort by time
  const seen = new Set();
  const data = ohlc
    .filter(c => { if (seen.has(c.e)) return false; seen.add(c.e); return true; })
    .sort((a, b) => a.e - b.e)
    .map(toTV);

  try {
    tvSeries.setData(data);
    tvChart.timeScale().fitContent();
  } catch(e) { console.warn('TV setData error:', e); }

  // Volume
  if (overlays.vol && tvVolSeries) {
    const volData = ohlc
      .filter(c => { return true; })
      .sort((a,b) => a.e - b.e)
      .map(c => ({
        time: c.e,
        value: Math.abs(c.c - c.o) * 1000 + Math.random() * 500,
        color: c.c >= c.o ? 'rgba(5,177,105,0.35)' : 'rgba(240,82,82,0.3)',
      }));
    const seen2 = new Set();
    const vd = volData.filter(d => { if(seen2.has(d.time)) return false; seen2.add(d.time); return true; });
    try { tvVolSeries.setData(vd); } catch(e) {}
  }

  // Overlays
  applyOverlays();
}

function applyOverlays() {
  if (!tvSeries || !ohlc.length) return;

  // EMA 20
  if (overlays.ema) {
    if (!tvEmaSeries) {
      tvEmaSeries = tvChart.addLineSeries({
        color: 'rgba(245,158,11,0.8)',
        lineWidth: 1.5,
        crosshairMarkerVisible: false,
        priceLineVisible: false,
        lastValueVisible: false,
        lineStyle: 0,
      });
    }
    const closes = ohlc.map(c => c.c);
    const emas = calcEMA(closes, 20);
    const seen = new Set();
    const emaData = ohlc
      .map((c, i) => ({ time: c.e, value: emas[i] }))
      .filter(d => d.value != null && !seen.has(d.time) && seen.add(d.time))
      .sort((a,b) => a.time - b.time);
    try { tvEmaSeries.setData(emaData); } catch(e) {}
  } else {
    try { if (tvEmaSeries) { tvChart.removeSeries(tvEmaSeries); tvEmaSeries = null; } } catch(e) {}
  }

  // Bollinger Bands
  if (overlays.bb && ohlc.length >= 20) {
    const bbStyle = { lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false, lineStyle: 1 };
    if (!tvBbUpper) tvBbUpper = tvChart.addLineSeries({ ...bbStyle, color: 'rgba(5,177,105,0.4)' });
    if (!tvBbLower) tvBbLower = tvChart.addLineSeries({ ...bbStyle, color: 'rgba(5,177,105,0.4)' });

    const closes = ohlc.map(c => c.c);
    const upperData = [], lowerData = [];
    for (let i = 19; i < closes.length; i++) {
      const sl = closes.slice(i - 19, i + 1);
      const mean = sl.reduce((a,b)=>a+b,0)/sl.length;
      const sd = Math.sqrt(sl.reduce((a,b)=>a+(b-mean)**2,0)/sl.length);
      upperData.push({ time: ohlc[i].e, value: mean + 2 * sd });
      lowerData.push({ time: ohlc[i].e, value: mean - 2 * sd });
    }
    const dedup = arr => { const s=new Set(); return arr.filter(d=>!s.has(d.time)&&s.add(d.time)).sort((a,b)=>a.time-b.time); };
    try { tvBbUpper.setData(dedup(upperData)); tvBbLower.setData(dedup(lowerData)); } catch(e) {}
  } else {
    try { if (tvBbUpper) { tvChart.removeSeries(tvBbUpper); tvBbUpper = null; } } catch(e) {}
    try { if (tvBbLower) { tvChart.removeSeries(tvBbLower); tvBbLower = null; } } catch(e) {}
  }
}

function toggleOverlay(name, btn) {
  overlays[name] = !overlays[name];
  btn.classList.toggle('on', overlays[name]);
  if (name === 'vol') { buildMainSeries(); } // rebuild for vol (different price scale)
  else { applyOverlays(); }
}

function hideChartLoader() {
  const loader = $('chartLoader');
  if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 300); }
}

function setChartType(type, btn) {
  chartType = type;
  document.querySelectorAll('.ct-btn').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  if (tf !== '1T') buildMainSeries();
}

function setTF(f, btn) {
  tf = f;
  document.querySelectorAll('#col-chart .tf-bar .tfb:not(.ct-btn):not([id^="ovl-"])').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');

  const loader = $('chartLoader');
  if (loader) { loader.style.display = 'flex'; loader.style.opacity = '1'; }

  ohlc = [];

  if (f === '1T') {
    buildMainSeries();
    if (wsConn) {
      // Fetch real tick history
      wsSend({ticks_history: sym, adjust_start_time: 1, count: 500, end: 'latest', style: 'ticks', subscribe: 0});
    } else {
      loadTickData();
      hideChartLoader();
    }
  } else {
    buildMainSeries();
    if (wsConn) {
      getOHLC(sym, f);
    } else {
      buildCandles(sym);
      loadOHLCData();
      hideChartLoader();
    }
  }
}

// Resize on window change
window.addEventListener('resize', () => {
  if (tvChart) {
    const c = document.getElementById('tvChart');
    if (c) tvChart.resize(c.offsetWidth, c.offsetHeight);
  }
});

// ── INIT ──────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  Object.keys(MKT).forEach(s => tPx[s] = MKT[s].b);

  renderMkts(); renderTicker(); calcPay(); calcDTPay();
  buildDigitGrid(); buildPredGrid(); renderLastDigits(); renderDtDigitBtns();

  if (window.innerWidth >= 960) {
    goCol('col-digit');
    $('tn-col-digit') && $('tn-col-digit').classList.add('act');
    $('tn-col-chart') && $('tn-col-chart').classList.add('act');
  } else {
    goCol('col-chart');
  }

  // Init TV chart — must happen after DOM is fully rendered
  requestAnimationFrame(() => {
    setTimeout(() => {
      // TV chart removed from home screen — skip initTVChart
      startDemo();
    }, 100);
  });

  // Check if returning from Deriv OAuth (token in URL params)
  readOAuthTokenFromURL();

  // Restore saved token from previous session (if no OAuth token in URL)
  if (!tok) {
    const savedTok = localStorage.getItem('rmt-tok');
    if (savedTok) {
      tok = savedTok;
      const inp = $('apiTok');
      if (inp) inp.value = savedTok;
    }
  } else {
    // OAuth token just loaded — pre-fill input for visibility
    const inp = $('apiTok');
    if (inp) inp.value = tok;
  }

  connectWS();

  setTimeout(() => {
    if (!authed) { const b = $('banner'); if(b) b.style.display = 'block'; }
  }, 3000);

  updateDigitAnalysis(); runAI(); updateRFAnalysis();
});

// ══════════════════════════════════════════════════════════
// MOTIVATION / MINDSET AUDIO ENGINE
// Uses Web Speech API (SpeechSynthesis) — deep male voice
// ══════════════════════════════════════════════════════════

const MOTIVATION_TEXT = `Let me tell you something about forex. The charts don't care about your feelings. The candlesticks don't wake up and say, "Oh no, he had a bad day, let's move in his favor." No. The market wakes up and says, "Who's disciplined? Who's sharp? Who's ready to take money from the lazy?"

And if you're not sharp? You get eaten.

Most people open a trading account like it's a casino app. Clicking buy. Clicking sell. No plan. No journal. No risk management. Then they cry: "The market manipulated me." No, my friend. You manipulated yourself.

You know what's funny? You'll spend 6 hours scrolling nonsense, but you won't spend 2 hours backtesting your strategy. You'll memorize song lyrics, but you don't know your risk-to-reward ratio. And then you're surprised you're broke?

Come on.

Forex is not gambling. It's war. You versus your emotions. You versus impatience. You versus that little voice saying, "Enter early… it's probably going to move."

"Probably" is for amateurs.

Professionals wait. Professionals calculate. Professionals strike once.

You don't need 20 trades a day. You need one clean setup executed like a sniper. Precision. Patience. Discipline. That's how you build consistency.

And let's talk about losses.

You lost a trade? Good.

If one red candle destroys your confidence, you were never built for this. Real traders don't cry over losses. They log them. They study them. They improve. Losses are tuition. The market charges everyone. The difference is whether you graduate… or drop out.

You say you want financial freedom. But do you wake up early to analyze London session? Do you review your trades on weekends? Do you track your mistakes?

Or are you just dreaming about withdrawals you haven't earned yet?

Here's the truth: Forex will expose you.

If you're impatient — you'll overtrade. If you're greedy — you'll blow accounts. If you're emotional — you'll revenge trade.

The chart is a mirror. It shows you who you are.

And that's the beautiful part.

Because once you master yourself, the money follows.

Stop chasing pips like a desperate gambler. Build skill. Build control. Build composure. When your setup appears, you enter with confidence — not hope. When it doesn't, you sit on your hands like a professional.

Boring? Good. Boring makes money.

The flashy trader blowing accounts every month? Entertainment. The calm trader compounding three to five percent consistently? Dangerous.

You don't need hype. You need discipline.

You don't need ten indicators. You need clarity.

You don't need motivation every day. You need standards.

Raise your standards.

Decide that you are the type of trader who: Respects risk. Waits for confirmation. Accepts losses calmly. Protects capital like it's oxygen.

Because it is.

Capital is your soldier. Stop sending it to die in random trades.

If you want to be average, keep gambling. If you want to level up, treat this like a business.

Journal everything. Backtest relentlessly. Control your lot size. Think long term.

And when everyone else quits after three blown accounts?

You'll still be there.

Calm. Focused. Profitable.

Now go study your charts. Not because you're emotional. Not because you're desperate.

But because you've decided you're built different.

The market rewards the disciplined.

Be that trader.`;

// Split into paragraphs (non-empty lines)
const MOTIV_PARAGRAPHS = MOTIVATION_TEXT.split('\n').map(l => l.trim()).filter(l => l.length > 0);

// State
let motivUtterance = null;
let motivSpeaking = false;
let motivPaused = false;
let motivCurrentPara = 0;
let motivRate = 0.75;
let motivPitch = 0.7;
let motivSelectedVoice = null;
let motivWaveAnim = null;
let motivStartTime = 0;
let motivEstDuration = 0;
let motivRafId = null;

// Canvas waveform
let motivWavePhase = 0;

function motivInitUI() {
  // Build jump cards
  const cardsEl = $('motivCards');
  if (cardsEl) {
    cardsEl.innerHTML = MOTIV_PARAGRAPHS.map((p, i) =>
      `<div class="motiv-card" id="mcard-${i}" onclick="motivJumpTo(${i})">
        <div class="motiv-card-num">SECTION ${String(i+1).padStart(2,'0')}</div>
        <div class="motiv-card-preview">${p}</div>
      </div>`
    ).join('');
  }

  // Build transcript
  const transcriptEl = $('motivTranscript');
  if (transcriptEl) {
    transcriptEl.innerHTML = MOTIV_PARAGRAPHS.map((p, i) =>
      `<div class="motiv-line" id="mline-${i}" onclick="motivJumpTo(${i})">${p}</div>`
    ).join('');
  }

  // Load voices
  motivLoadVoices();

  // Start idle waveform
  motivDrawWaveIdle();
}

function motivLoadVoices() {
  const select = $('motivVoiceSelect');
  if (!select || !window.speechSynthesis) return;

  const populate = () => {
    const voices = window.speechSynthesis.getVoices();
    if (!voices.length) return;

    // Prefer deep male English voices
    const preferred = voices.filter(v =>
      v.lang.startsWith('en') &&
      (v.name.toLowerCase().includes('male') ||
       v.name.toLowerCase().includes('david') ||
       v.name.toLowerCase().includes('james') ||
       v.name.toLowerCase().includes('daniel') ||
       v.name.toLowerCase().includes('alex') ||
       v.name.toLowerCase().includes('george') ||
       v.name.toLowerCase().includes('fred') ||
       v.name.toLowerCase().includes('guy') ||
       v.name.toLowerCase().includes('reed') ||
       v.name.toLowerCase().includes('tom') ||
       v.name.toLowerCase().includes('gordon') ||
       v.name.toLowerCase().includes('ralph') ||
       v.name.toLowerCase().includes('bruce'))
    );
    const english = voices.filter(v => v.lang.startsWith('en'));
    const pool = preferred.length ? preferred : english;

    select.innerHTML = pool.map((v, i) =>
      `<option value="${v.name}">${v.name} (${v.lang})</option>`
    ).concat(
      voices.filter(v => !v.lang.startsWith('en')).map(v =>
        `<option value="${v.name}">${v.name} (${v.lang})</option>`)
    ).join('');

    // Auto-select best deep voice
    const best = preferred[0] || english[0] || voices[0];
    if (best) {
      select.value = best.name;
      motivSelectedVoice = best;
    }
  };

  if (window.speechSynthesis.getVoices().length) populate();
  window.speechSynthesis.onvoiceschanged = populate;
}

function motivSetVoice(name) {
  const voices = window.speechSynthesis.getVoices();
  motivSelectedVoice = voices.find(v => v.name === name) || null;
  if (motivSpeaking) { motivStop(); setTimeout(() => motivJumpTo(motivCurrentPara), 100); }
}

function motivSetRate(r, btn) {
  motivRate = r;
  document.querySelectorAll('.motiv-rate-btn').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  // Re-estimate duration
  motivEstDuration = motivEstimateDuration();
  if (motivSpeaking) { motivStop(); setTimeout(() => motivJumpTo(motivCurrentPara), 100); }
}

function motivEstimateDuration() {
  // Approx 150 words/min at rate=1, adjusted
  const words = MOTIV_PARAGRAPHS.slice(motivCurrentPara).join(' ').split(' ').length;
  return (words / 150) * 60 / motivRate;
}

function motivToggle() {
  if (!window.speechSynthesis) { toast('⚠️','No TTS','Your browser does not support Speech Synthesis'); return; }
  if (motivSpeaking && !motivPaused) {
    // Pause
    window.speechSynthesis.pause();
    motivPaused = true;
    $('motivPlayBtn').textContent = '▶ RESUME';
    $('motivVolDot').style.background = 'var(--gold)';
    motivDrawWaveIdle();
  } else if (motivPaused) {
    // Resume
    window.speechSynthesis.resume();
    motivPaused = false;
    $('motivPlayBtn').textContent = '⏸ PAUSE';
    $('motivVolDot').style.background = '#f05252';
    $('motivVolDot').style.boxShadow = '0 0 8px rgba(240,82,82,0.7)';
    motivDrawWaveActive();
  } else {
    // Start fresh from current para
    motivSpeakFrom(motivCurrentPara);
  }
}

function motivStop() {
  window.speechSynthesis.cancel();
  motivSpeaking = false;
  motivPaused = false;
  const btn = $('motivPlayBtn');
  if (btn) btn.textContent = '▶ PLAY';
  const dot = $('motivVolDot');
  if (dot) { dot.style.background = 'var(--txt3)'; dot.style.boxShadow = ''; }
  cancelAnimationFrame(motivRafId);
  motivDrawWaveIdle();
  $('motivProgress').style.width = '0%';
}

function motivRestart() {
  motivStop();
  motivCurrentPara = 0;
  motivHighlightLine(-1);
  setTimeout(() => motivSpeakFrom(0), 150);
}

function motivJumpTo(idx) {
  motivStop();
  motivCurrentPara = idx;
  setTimeout(() => motivSpeakFrom(idx), 150);
}

function motivSpeakFrom(startIdx) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();

  // Speak each paragraph sequentially
  motivCurrentPara = startIdx;
  motivSpeaking = true;
  motivPaused = false;
  motivStartTime = Date.now();
  motivEstDuration = motivEstimateDuration();

  const btn = $('motivPlayBtn');
  if (btn) btn.textContent = '⏸ PAUSE';
  const dot = $('motivVolDot');
  if (dot) { dot.style.background = '#f05252'; dot.style.boxShadow = '0 0 8px rgba(240,82,82,0.7)'; }

  motivDrawWaveActive();
  motivSpeakPara(startIdx);
}

function motivSpeakPara(idx) {
  if (idx >= MOTIV_PARAGRAPHS.length) {
    // Done!
    motivSpeaking = false;
    const btn = $('motivPlayBtn');
    if (btn) btn.textContent = '▶ PLAY';
    const dot = $('motivVolDot');
    if (dot) { dot.style.background = 'var(--green)'; dot.style.boxShadow = '0 0 8px rgba(16,185,129,0.6)'; }
    $('motivNowPlaying').textContent = '✅ Finished. You are ready. Now trade.';
    $('motivProgress').style.width = '100%';
    motivHighlightLine(-1);
    motivDrawWaveIdle();
    cancelAnimationFrame(motivRafId);
    return;
  }

  motivCurrentPara = idx;
  motivHighlightLine(idx);
  scrollToLine(idx);

  // Update "now playing" display
  const np = $('motivNowPlaying');
  if (np) np.textContent = MOTIV_PARAGRAPHS[idx];

  const utt = new SpeechSynthesisUtterance(MOTIV_PARAGRAPHS[idx]);
  utt.rate = motivRate;
  utt.pitch = motivPitch;
  utt.volume = 1;
  if (motivSelectedVoice) utt.voice = motivSelectedVoice;

  utt.onend = () => {
    // Mark this line as spoken
    const el = $('mline-' + idx);
    if (el) { el.classList.remove('active'); el.classList.add('spoken'); }
    const card = $('mcard-' + idx);
    if (card) card.classList.remove('playing');

    if (!motivPaused && motivSpeaking) {
      setTimeout(() => motivSpeakPara(idx + 1), 120);
    }
  };
  utt.onerror = () => {
    if (motivSpeaking) setTimeout(() => motivSpeakPara(idx + 1), 200);
  };

  motivUtterance = utt;
  window.speechSynthesis.speak(utt);
}

function motivHighlightLine(idx) {
  // Clear all
  MOTIV_PARAGRAPHS.forEach((_, i) => {
    const line = $('mline-' + i);
    const card = $('mcard-' + i);
    if (line) line.classList.remove('active');
    if (card) card.classList.remove('playing');
  });
  if (idx >= 0) {
    const line = $('mline-' + idx);
    if (line) line.classList.add('active');
    const card = $('mcard-' + idx);
    if (card) card.classList.add('playing');
  }
}

function scrollToLine(idx) {
  const el = $('mline-' + idx);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Waveform animation
function motivDrawWaveActive() {
  const canvas = $('motivWave');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  const W = canvas.width, H = canvas.height;

  let t = 0;

  function frame() {
    ctx.clearRect(0, 0, W, H);

    // Update progress bar
    if (motivStartTime && motivEstDuration) {
      const elapsed = (Date.now() - motivStartTime) / 1000;
      const pct = Math.min(100, (elapsed / motivEstDuration) * 100);
      $('motivProgress').style.width = pct + '%';
      const mins = Math.floor(elapsed / 60), secs = Math.floor(elapsed % 60);
      const total_m = Math.floor(motivEstDuration / 60), total_s = Math.floor(motivEstDuration % 60);
      const timeEl = $('motivTime');
      if (timeEl) timeEl.textContent = `${mins}:${String(secs).padStart(2,'0')} / ${total_m}:${String(total_s).padStart(2,'0')}`;
    }

    // Draw multi-layer waveform
    const bars = Math.floor(W / 4);
    for (let i = 0; i < bars; i++) {
      const x = i * 4 + 2;
      const freq1 = 0.12, freq2 = 0.07, freq3 = 0.19;
      const amp = (
        Math.sin(i * freq1 + t * 3.2) * 0.4 +
        Math.sin(i * freq2 + t * 2.1) * 0.3 +
        Math.sin(i * freq3 + t * 4.5) * 0.2 +
        (Math.random() * 0.1)
      );
      const barH = Math.max(2, Math.abs(amp) * H * 0.8);
      const alpha = 0.5 + Math.abs(amp) * 0.5;

      const grad = ctx.createLinearGradient(x, H/2 - barH/2, x, H/2 + barH/2);
      grad.addColorStop(0, `rgba(239,68,68,${alpha})`);
      grad.addColorStop(0.5, `rgba(245,158,11,${alpha * 0.8})`);
      grad.addColorStop(1, `rgba(239,68,68,${alpha})`);

      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.roundRect(x - 1, H/2 - barH/2, 2.5, barH, 1);
      ctx.fill();
    }

    t += 0.016;
    motivRafId = requestAnimationFrame(frame);
  }
  cancelAnimationFrame(motivRafId);
  frame();
}

function motivDrawWaveIdle() {
  const canvas = $('motivWave');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0, 0, W, H);
  const bars = Math.floor(W / 4);
  for (let i = 0; i < bars; i++) {
    const x = i * 4 + 2;
    const barH = 2 + Math.sin(i * 0.3) * 2;
    ctx.fillStyle = 'rgba(255,255,255,0.10)';
    ctx.beginPath();
    ctx.roundRect(x - 1, H/2 - barH/2, 2.5, barH, 1);
    ctx.fill();
  }
}

function motivSeek(e, bar) {
  // Seek not easily supported in SpeechSynthesis — jump to a rough paragraph
  const rect = bar.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  const targetIdx = Math.floor(pct * MOTIV_PARAGRAPHS.length);
  motivJumpTo(Math.max(0, Math.min(MOTIV_PARAGRAPHS.length - 1, targetIdx)));
}

// Init motivation panel when DOM ready
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(motivInitUI, 300);
});

// ── END MOTIVATION ENGINE ──────────────────────────────────────────────


// ══════════════════════════════════════════════════════════
// TICK COUNTER AUTO BOT ENGINE
// Fires a Rise/Fall trade after each atcFinishRound() result
// using the same wsSend(proposal→buy) flow as doTrade()
// ══════════════════════════════════════════════════════════
var atcBot = {
  running: false,
  dir: 'with',        // 'with' | 'against'
  runs: 0,
  maxRuns: 10,
  baseStake: 1,
  currentStake: 1,
  martingale: 2,
  duration: 5,
  sl: 10,
  tp: 20,
  totalPnl: 0,
  lastWon: null,
  pendingRound: false  // waiting for next atcFinishRound
};

function abSetDir(d) {
  atcBot.dir = d;
  $('abDirWith').classList.toggle('on', d === 'with');
  $('abDirAgainst').classList.toggle('on', d === 'against');
}

function atcBotToggle() {
  if (atcBot.running) {
    atcBotStop('Manually stopped');
  } else {
    atcBotStart();
  }
}

function atcBotStart() {
  // Read settings
  atcBot.baseStake   = Math.max(0.35, parseFloat($('abStake')?.value) || 1);
  atcBot.currentStake = atcBot.baseStake;
  atcBot.martingale  = Math.max(1, parseFloat($('abMart')?.value) || 2);
  atcBot.duration    = Math.max(1, parseInt($('abDur')?.value) || 5);
  atcBot.sl          = Math.max(0, parseFloat($('abSL')?.value) || 10);
  atcBot.tp          = Math.max(0, parseFloat($('abTP')?.value) || 20);
  atcBot.maxRuns     = Math.max(1, parseInt($('abRuns')?.value) || 10);
  atcBot.runs        = 0;
  atcBot.totalPnl    = 0;
  atcBot.running     = true;
  atcBot.pendingRound = true;  // will fire on next completed round

  // Disable inputs
  ['abStake','abMart','abDur','abSL','abTP','abRuns'].forEach(function(id){
    var el = $(id); if (el) el.disabled = true;
  });
  $('abDirWith').disabled = true;
  $('abDirAgainst').disabled = true;

  abSetBadge('running','RUNNING');
  abSetDot('running');
  $('atcBotMainBtn').textContent = '⏹ STOP';
  $('atcBotMainBtn').classList.add('stop');
  $('atcBotLog').innerHTML = '';

  // Make sure autoTC is running
  if (!atcState.auto) atcToggle();

  abLog('info', '🤖', 'Bot started — waiting for next round to complete...');
  abLog('info', '⚙️', 'Stake: $'+atcBot.baseStake+' | Martingale: '+atcBot.martingale+'× | Dur: '+atcBot.duration+'t | SL: $'+atcBot.sl+' | TP: $'+atcBot.tp+' | Runs: '+atcBot.maxRuns);
  abLog('info', '📡', 'Direction: '+(atcBot.dir === 'with' ? 'WITH signal (follow)' : 'AGAINST signal (reverse)'));
}

function atcBotStop(reason) {
  atcBot.running = false;
  atcBot.pendingRound = false;
  ['abStake','abMart','abDur','abSL','abTP','abRuns'].forEach(function(id){
    var el = $(id); if (el) el.disabled = false;
  });
  $('abDirWith').disabled = false;
  $('abDirAgainst').disabled = false;
  $('atcBotMainBtn').textContent = '▶ START';
  $('atcBotMainBtn').classList.remove('stop');
  abSetBadge('stopped','STOPPED');
  abSetDot('');
  abLog('warn', '🛑', reason || 'Bot stopped');
  abLog('info', '📊', 'Session P&L: '+(atcBot.totalPnl >= 0 ? '+' : '')+'$'+atcBot.totalPnl.toFixed(2)+' over '+atcBot.runs+' run(s)');
}

// Called by atcFinishRound() after each round completes
function atcBotOnRoundComplete(direction, conf) {
  if (!atcBot.running || !atcBot.pendingRound) return;

  // Check run limit
  if (atcBot.runs >= atcBot.maxRuns) {
    atcBotStop('Max runs ('+atcBot.maxRuns+') reached');
    return;
  }

  // Determine trade direction
  // direction = 'RISE' | 'FALL' | 'NEUTRAL'
  if (direction === 'NEUTRAL') {
    abLog('warn', '〰️', 'Neutral signal — skipping this round');
    return;
  }

  var tradeDir; // 'CALL' or 'PUT'
  if (atcBot.dir === 'with') {
    tradeDir = direction === 'RISE' ? 'CALL' : 'PUT';
  } else {
    tradeDir = direction === 'RISE' ? 'PUT' : 'CALL';
  }

  var label = tradeDir === 'CALL' ? '▲ RISE' : '▼ FALL';
  var stake = atcBot.currentStake;

  abLog('info', '🎯', 'Signal: '+direction+' ('+conf+'%) → Trade: '+label+' @ $'+stake.toFixed(2));

  // Fire trade
  atcBotExecuteTrade(tradeDir, stake);
  atcBot.runs++;
  atcBot.pendingRound = false; // will re-enable after trade settles
}

function atcBotExecuteTrade(ct, stake) {
  if (wsConn && authed) {
    var params = {
      proposal: 1,
      amount: stake,
      basis: 'stake',
      contract_type: ct,
      currency: 'USD',
      symbol: sym,
      duration: atcBot.duration,
      duration_unit: 't'
    };
    window._pendingTrade = { stake: stake, ct: ct, dir: ct, isBot: true };
    window._lastBotCt = ct;
    wsSend(params);
    abSetBadge('running', 'TRADING');
    toast('🤖', 'Bot Trade', label(ct)+' · $'+stake.toFixed(2));
  } else {
    // Demo sim
    abSetBadge('running','SIM');
    var won = Math.random() > 0.47;
    var pnl = won ? +(stake * 0.92) : -stake;
    setTimeout(function(){ atcBotOnTradeDone(won, pnl); }, 2000 + Math.random()*3000);
    window._lastBotCt = ct;
    abLog('info', '🎮', 'DEMO trade: '+label(ct)+' @ $'+stake.toFixed(2));
  }
}

function label(ct){ return ct === 'CALL' ? '▲ RISE' : '▼ FALL'; }

// Called when a bot trade settles — hook into existing onPoc
function atcBotOnTradeDone(won, pnl) {
  if (!atcBot.running) return;

  atcBot.totalPnl += pnl;
  abUpdatePnl();

  // ── Log to global trades journal ──
  var botStake = atcBot.currentStake;
  var botDir = (window._lastBotCt || 'CALL');
  var t = {
    id: Date.now(),
    sym: sym,
    type: 'ATC-BOT',
    dir: botDir,
    stake: botStake,
    entry: px,
    time: new Date().toLocaleTimeString(),
    status: won ? 'won' : 'lost',
    pnl: pnl,
    source: 'bot'
  };
  trades.unshift(t); cnt++;
  if (won) { wins++; consecWin++; consecLoss = 0; }
  else { consecLoss++; consecWin = 0; }
  totals++; proft += pnl;
  updStats(); updJournal();

  if (won) {
    atcBot.currentStake = atcBot.baseStake; // reset on win
    abSetBadge('win', 'WIN +$'+Math.abs(pnl).toFixed(2));
    abLog('win', '🏆', 'WIN +$'+Math.abs(pnl).toFixed(2)+' | Stake reset to $'+atcBot.baseStake.toFixed(2));
  } else {
    atcBot.currentStake = +(atcBot.currentStake * atcBot.martingale).toFixed(2); // martingale
    abSetBadge('loss', 'LOSS -$'+Math.abs(pnl).toFixed(2));
    abLog('loss', '❌', 'LOSS -$'+Math.abs(pnl).toFixed(2)+' | Next stake: $'+atcBot.currentStake.toFixed(2)+' ('+atcBot.martingale+'×)');
  }

  // Check SL/TP
  if (atcBot.sl > 0 && atcBot.totalPnl <= -atcBot.sl) {
    atcBotStop('🔴 Stop loss hit ($-'+atcBot.sl+')');
    return;
  }
  if (atcBot.tp > 0 && atcBot.totalPnl >= atcBot.tp) {
    atcBotStop('🟢 Take profit hit ($+'+atcBot.tp+')');
    return;
  }
  if (atcBot.runs >= atcBot.maxRuns) {
    atcBotStop('Max runs ('+atcBot.maxRuns+') reached');
    return;
  }

  // Ready for next round
  atcBot.pendingRound = true;
  abSetBadge('running','RUNNING');
  abLog('info', '⏳', 'Waiting for next tick counter round...');
}

function abSetBadge(cls, txt) {
  var b = $('atcBotBadge');
  if (!b) return;
  b.className = 'atcbot-badge ' + cls;
  b.textContent = txt;
}
function abSetDot(cls) {
  var d = $('atcBotDot');
  if (d) d.className = 'atcbot-status-dot ' + cls;
}
function abUpdatePnl() {
  var el = $('atcBotPnl');
  if (!el) return;
  var v = atcBot.totalPnl;
  el.textContent = (v >= 0 ? '+' : '') + '$' + v.toFixed(2);
  el.className = 'atcbot-pnl ' + (v > 0 ? 'pos' : v < 0 ? 'neg' : '');
}
function abLog(cls, ico, msg) {
  var log = $('atcBotLog');
  if (!log) return;
  var idle = log.querySelector('.atcbot-log-idle');
  if (idle) idle.remove();
  var t = new Date().toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  var row = document.createElement('div');
  row.className = 'ablog ' + cls;
  row.innerHTML = '<span class="ablog-time">'+t+'</span><span class="ablog-ico">'+ico+'</span><span class="ablog-msg">'+msg+'</span>';
  log.insertBefore(row, log.firstChild);
  // Keep max 40 lines
  while (log.children.length > 40) log.removeChild(log.lastChild);
}
// ══════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════
// ADVANCED DIGIT PATTERN BOT ENGINE
// Logic: analyse last N digits against a barrier.
// If all last N digits are UNDER barrier → next trade = OVER barrier
// If all last N digits are OVER barrier  → next trade = UNDER barrier
// Confidence = streak strength + frequency bias
// ══════════════════════════════════════════════════════════
var dpbot = {
  running: false,
  window: 3,        // how many consecutive digits to analyse
  barrier: 5,       // the digit barrier (0-9)
  minConf: 70,      // minimum confidence % to fire a trade
  baseStake: 1,
  currentStake: 1,
  martingale: 2,
  duration: 5,
  sl: 10,
  tp: 20,
  maxRuns: 20,
  runs: 0,
  totalPnl: 0,
  lastWon: null,
  pendingTrade: false,  // waiting for open trade to settle
  tradeDir: null        // 'over' or 'under'
};

function dpbotSetWindow(n) {
  dpbot.window = n;
  var winBtnGroups = document.querySelectorAll('.dpbot-win-btns');
  if (winBtnGroups[0]) {
    winBtnGroups[0].querySelectorAll('.dpbot-wb').forEach(function(b){
      b.classList.toggle('on', parseInt(b.textContent) === n);
    });
  }
  var lbl = document.querySelector('#dpbotWinLabel');
  if (lbl) lbl.textContent = n;
  dpbotAnalyse();
}

function dpbotSetBarrier(n) {
  dpbot.barrier = n;
  // Barrier buttons are in the second .dpbot-win-btns group
  var winBtnGroups = document.querySelectorAll('.dpbot-win-btns');
  if (winBtnGroups[1]) {
    winBtnGroups[1].querySelectorAll('.dpbot-wb').forEach(function(b){
      b.classList.toggle('on', parseInt(b.textContent) === n);
    });
  }
  dpbotAnalyse();
}

// ── Analyse current digit stream and produce a signal ──
function dpbotAnalyse() {
  if (!digitStream || digitStream.length < dpbot.window) {
    dpbotSetSignal('wait', 'SCANNING...', 'Not enough data yet', 0);
    dpbotRenderPattern([]);
    return;
  }

  var last = digitStream.slice(-dpbot.window);
  var barrier = dpbot.barrier;
  var allUnder = last.every(function(d){ return d < barrier; });
  var allOver  = last.every(function(d){ return d >= barrier; });

  // Count last 50 for frequency bias
  var last50 = digitStream.slice(-50);
  var underCount = last50.filter(function(d){ return d < barrier; }).length;
  var overCount  = last50.filter(function(d){ return d >= barrier; }).length;

  // Confidence: pattern clarity × frequency reversion pressure
  var conf = 0;
  var signalDir = null;

  if (allUnder) {
    // All last N digits under barrier → strong signal for OVER next
    var streakConf = Math.min(40, dpbot.window * 14);  // more window = more confident
    var freqConf = Math.round(underCount / 50 * 60);   // how dominant under has been
    conf = Math.min(98, streakConf + freqConf);
    signalDir = 'over';
  } else if (allOver) {
    var streakConf = Math.min(40, dpbot.window * 14);
    var freqConf = Math.round(overCount / 50 * 60);
    conf = Math.min(98, streakConf + freqConf);
    signalDir = 'under';
  } else {
    // Mixed pattern — partial signal
    var underStreak = 0, overStreak = 0;
    for (var i = last.length - 1; i >= 0; i--) {
      if (last[i] < barrier) underStreak++; else break;
    }
    for (var i = last.length - 1; i >= 0; i--) {
      if (last[i] >= barrier) overStreak++; else break;
    }
    if (underStreak >= 2) {
      conf = Math.min(65, underStreak * 18 + Math.round(underCount / 50 * 30));
      signalDir = 'over';
    } else if (overStreak >= 2) {
      conf = Math.min(65, overStreak * 18 + Math.round(overCount / 50 * 30));
      signalDir = 'under';
    } else {
      conf = 0; signalDir = null;
    }
  }

  // Build pattern visualiser
  dpbotRenderPattern(last, barrier);

  // Update signal card
  if (signalDir === 'over') {
    var detail = 'Last '+dpbot.window+' digits < '+barrier+' ('+conf+'% conf) → Expect OVER '+barrier;
    dpbotSetSignal('over', '▲ OVER ' + barrier, detail, conf);
  } else if (signalDir === 'under') {
    var detail = 'Last '+dpbot.window+' digits ≥ '+barrier+' ('+conf+'% conf) → Expect UNDER '+barrier;
    dpbotSetSignal('under', '▼ UNDER ' + barrier, detail, conf);
  } else {
    dpbotSetSignal('wait', 'MIXED PATTERN', 'No clear signal — waiting...', 0);
  }

  // If bot running and not in a pending trade, check if we should fire
  if (dpbot.running && !dpbot.pendingTrade && signalDir && conf >= dpbot.minConf) {
    dpbot.tradeDir = signalDir;
    dpbotFire(signalDir, conf);
  }
}

function dpbotSetSignal(type, dir, detail, conf) {
  var card = $('dpbotSignalCard');
  var dirEl = $('dpbotSigDir');
  var detEl = $('dpbotSigDetail');
  if (card) card.className = 'dpbot-signal-card ' + (type === 'over' ? 'over-sig' : type === 'under' ? 'under-sig' : '');
  if (dirEl) { dirEl.textContent = conf > 0 ? dir + ' (' + conf + '%)' : dir; dirEl.className = 'dpbot-sig-dir ' + type; }
  if (detEl) detEl.textContent = detail;
}

function dpbotRenderPattern(digits, barrier) {
  var wrap = $('dpbotPvDigits');
  if (!wrap) return;
  wrap.innerHTML = digits.map(function(d){
    var cls = barrier !== undefined ? (d < barrier ? 'under' : 'over') : '';
    return '<div class="dpbot-pv-d '+cls+'">'+d+'</div>';
  }).join('');

  var nextEl = $('dpbotPvNext');
  if (nextEl) {
    if (dpbot.tradeDir === 'over') { nextEl.textContent = '↑'; nextEl.className = 'dpbot-pv-next over'; }
    else if (dpbot.tradeDir === 'under') { nextEl.textContent = '↓'; nextEl.className = 'dpbot-pv-next under'; }
    else { nextEl.textContent = '?'; nextEl.className = 'dpbot-pv-next'; }
  }
}

function dpbotToggle() {
  if (dpbot.running) {
    dpbotStop('Manually stopped');
  } else {
    dpbotStart();
  }
}

function dpbotStart() {
  dpbot.baseStake    = Math.max(0.35, parseFloat($('dpbStake')?.value) || 1);
  dpbot.currentStake = dpbot.baseStake;
  dpbot.martingale   = Math.max(1, parseFloat($('dpbMart')?.value) || 2);
  dpbot.duration     = Math.max(1, parseInt($('dpbDur')?.value) || 5);
  dpbot.sl           = Math.max(0, parseFloat($('dpbSL')?.value) || 10);
  dpbot.tp           = Math.max(0, parseFloat($('dpbTP')?.value) || 20);
  dpbot.maxRuns      = Math.max(1, parseInt($('dpbRuns')?.value) || 20);
  dpbot.minConf      = parseInt($('dpbMinConf')?.value) || 70;
  dpbot.runs         = 0;
  dpbot.totalPnl     = 0;
  dpbot.running      = true;
  dpbot.pendingTrade = false;

  ['dpbStake','dpbMart','dpbDur','dpbSL','dpbTP','dpbRuns','dpbMinConf'].forEach(function(id){
    var el = $(id); if (el) el.disabled = true;
  });

  var btn = $('dpbotStartBtn');
  if (btn) { btn.textContent = '⏹ STOP BOT'; btn.classList.add('stop'); }
  $('dpbotLog').innerHTML = '';

  dpblog('info', '🤖 Digit Pattern Bot started — barrier: '+dpbot.barrier+' | window: '+dpbot.window+' | min conf: '+dpbot.minConf+'%');
  dpblog('info', '⚙️ Stake: $'+dpbot.baseStake+' | Martingale: '+dpbot.martingale+'× | SL: $'+dpbot.sl+' | TP: $'+dpbot.tp+' | Runs: '+dpbot.maxRuns);
}

function dpbotStop(reason) {
  dpbot.running = false;
  dpbot.pendingTrade = false;
  ['dpbStake','dpbMart','dpbDur','dpbSL','dpbTP','dpbRuns','dpbMinConf'].forEach(function(id){
    var el = $(id); if (el) el.disabled = false;
  });
  var btn = $('dpbotStartBtn');
  if (btn) { btn.textContent = '▶ START BOT'; btn.classList.remove('stop'); }
  dpblog('warn', '🛑 '+(reason || 'Stopped')+' | P&L: '+(dpbot.totalPnl >= 0 ? '+' : '')+'$'+dpbot.totalPnl.toFixed(2)+' over '+dpbot.runs+' run(s)');
}

function dpbotFire(dir, conf) {
  if (!dpbot.running || dpbot.pendingTrade) return;
  if (dpbot.runs >= dpbot.maxRuns) { dpbotStop('Max runs reached'); return; }

  var ct = dir === 'over' ? 'DIGITOVER' : 'DIGITUNDER';
  var stake = dpbot.currentStake;
  var label = dir === 'over' ? '▲ OVER '+dpbot.barrier : '▼ UNDER '+dpbot.barrier;

  dpbot.pendingTrade = true;
  dpbot.runs++;
  dpblog('info', '🎯 Signal: '+label+' ('+conf+'%) @ $'+stake.toFixed(2));

  if (wsConn && authed) {
    var params = {
      proposal: 1,
      amount: stake,
      basis: 'stake',
      contract_type: ct,
      currency: 'USD',
      symbol: sym,
      duration: dpbot.duration,
      duration_unit: 't',
      barrier: String(dpbot.barrier)
    };
    window._pendingTrade = { stake: stake, ct: ct, dir: dir, isBot: true, isDpbot: true };
    window._lastBotCt = ct;
    wsSend(params);
    toast('🤖', 'Digit Bot', label+' · $'+stake.toFixed(2));
  } else {
    // Demo simulation
    window._lastBotCt = ct;
    var won = Math.random() > 0.47;
    var pnl = won ? +(stake * 0.92) : -stake;
    dpblog('info', '🎮 DEMO: '+label+' @ $'+stake.toFixed(2));
    setTimeout(function(){ dpbotOnDone(won, pnl, ct); }, 2500 + Math.random()*2000);
  }
}

function dpbotOnDone(won, pnl, ct) {
  if (!dpbot.running) return;

  dpbot.totalPnl += pnl;
  dpbot.pendingTrade = false;

  // Log to global journal
  var t = {
    id: Date.now(),
    sym: sym,
    type: 'DIGIT-BOT',
    dir: ct || dpbot.tradeDir,
    stake: dpbot.currentStake,
    entry: px,
    time: new Date().toLocaleTimeString(),
    status: won ? 'won' : 'lost',
    pnl: pnl,
    source: 'dpbot'
  };
  trades.unshift(t); cnt++;
  if (won) { wins++; consecWin++; consecLoss = 0; }
  else { consecLoss++; consecWin = 0; }
  totals++; proft += pnl;
  updStats(); updJournal();

  // Update bot P&L display
  var pnlEl = $('dpbotPnl');
  if (pnlEl) {
    pnlEl.textContent = (dpbot.totalPnl >= 0 ? '+' : '')+'$'+dpbot.totalPnl.toFixed(2);
    pnlEl.className = 'dpbot-pnl ' + (dpbot.totalPnl > 0 ? 'pos' : dpbot.totalPnl < 0 ? 'neg' : '');
  }

  if (won) {
    dpbot.currentStake = dpbot.baseStake;
    dpblog('win', '🏆 WIN +$'+Math.abs(pnl).toFixed(2)+' | Stake reset to $'+dpbot.baseStake.toFixed(2));
  } else {
    dpbot.currentStake = +(dpbot.currentStake * dpbot.martingale).toFixed(2);
    dpblog('loss', '❌ LOSS -$'+Math.abs(pnl).toFixed(2)+' | Next stake: $'+dpbot.currentStake.toFixed(2)+' ('+dpbot.martingale+'×)');
  }

  // Check limits
  if (dpbot.sl > 0 && dpbot.totalPnl <= -dpbot.sl) { dpbotStop('🔴 Stop loss hit (-$'+dpbot.sl+')'); return; }
  if (dpbot.tp > 0 && dpbot.totalPnl >= dpbot.tp) { dpbotStop('🟢 Take profit hit (+$'+dpbot.tp+')'); return; }
  if (dpbot.runs >= dpbot.maxRuns) { dpbotStop('Max runs reached'); return; }

  dpblog('info', '⏳ Waiting for next pattern...');
}

// Called from onPoc when a digit-bot trade settles
function dpbotHandlePoc(won, pnl, ct) {
  if (window._pendingTrade && window._pendingTrade.isDpbot) {
    window._pendingTrade.isDpbot = false;
    dpbotOnDone(won, pnl, ct);
  }
}

function dpblog(cls, msg) {
  var log = $('dpbotLog');
  if (!log) return;
  var idle = log.querySelector('.dpbot-log-idle');
  if (idle) idle.remove();
  var t = new Date().toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  var row = document.createElement('div');
  row.className = 'dpblog ' + cls;
  row.innerHTML = '<span class="dpblog-time">'+t+'</span><span class="dpblog-msg">'+msg+'</span>';
  log.insertBefore(row, log.firstChild);
  while (log.children.length > 40) log.removeChild(log.lastChild);
}

// Hook dpbotAnalyse into the digit stream on every tick
// We call it from inside updateDigitAnalysis
// ══════════════════════════════════════════════════════════

// Style for spin animation
const spinStyle = document.createElement('style');
spinStyle.textContent = `@keyframes spin{to{transform:rotate(360deg)}}`;
document.head.appendChild(spinStyle);
</script>
</body>
</html>
